<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>5m10v3&#39;s blog</title>
  
  
  <link href="https://5m10v3.top/atom.xml" rel="self"/>
  
  <link href="https://5m10v3.top/"/>
  <updated>2024-07-07T01:10:08.874Z</updated>
  <id>https://5m10v3.top/</id>
  
  <author>
    <name>5m10v3</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2024春秋联赛-夏季赛</title>
    <link href="https://5m10v3.top/2024/07/06/2024%E6%98%A5%E7%A7%8B%E8%81%94%E8%B5%9B-%E5%A4%8F%E5%AD%A3%E8%B5%9B/"/>
    <id>https://5m10v3.top/2024/07/06/2024%E6%98%A5%E7%A7%8B%E8%81%94%E8%B5%9B-%E5%A4%8F%E5%AD%A3%E8%B5%9B/</id>
    <published>2024-07-05T16:00:00.000Z</published>
    <updated>2024-07-07T01:10:08.874Z</updated>
    
    <content type="html"><![CDATA[<p><strong>REVERSE</strong></p><ul><li><strong>snack</strong></li><li><strong>HardSignin</strong></li><li><strong>BEDTEA</strong></li></ul><h2 id="Snake"><a href="#Snake" class="headerlink" title="Snake"></a>Snake</h2><p>python逆向</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python pyinstxtractor.py snake.exe</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/06/RYozmagP6KTcqUr.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/06/RYozmagP6KTcqUr.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>python3.8 直接选择在线pyc编译网站</p><p><a href="https://www.lddgo.net/string/pyc-compile-decompile">https://www.lddgo.net/string/pyc-compile-decompile</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Visit https://www.lddgo.net/string/pyc-compile-decompile for more information</span></span><br><span class="line"><span class="comment"># Version : Python 3.8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pygame</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> key</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">key</span>):</span><br><span class="line">    key_length = <span class="built_in">len</span>(key)</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % key_length]) % <span class="number">256</span></span><br><span class="line">        S[i] = S[j]</span><br><span class="line">        S[j] = S[i]</span><br><span class="line">    <span class="keyword">return</span> S</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_key_stream</span>(<span class="params">S, length</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    key_stream = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + S[i]) % <span class="number">256</span></span><br><span class="line">        S[i] = S[j]</span><br><span class="line">        S[j] = S[i]</span><br><span class="line">        key_stream.append(S[(S[i] + S[j]) % <span class="number">256</span>])</span><br><span class="line">    <span class="keyword">return</span> key_stream</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">data, key</span>):</span><br><span class="line">    S = initialize(key)</span><br><span class="line">    key_stream = generate_key_stream(S, <span class="built_in">len</span>(data))</span><br><span class="line">    decrypted_data = <span class="literal">None</span>((<span class="keyword">lambda</span> <span class="number">.0</span> = <span class="literal">None</span>: [ i ^ data[i] ^ key_stream[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">.0</span> ])(<span class="built_in">range</span>(<span class="built_in">len</span>(data))))</span><br><span class="line">    <span class="keyword">return</span> decrypted_data</span><br><span class="line"></span><br><span class="line">pygame.init()</span><br><span class="line">WINDOW_WIDTH = <span class="number">800</span></span><br><span class="line">WINDOW_HEIGHT = <span class="number">600</span></span><br><span class="line">SNAKE_SIZE = <span class="number">20</span></span><br><span class="line">SNAKE_SPEED = <span class="number">20</span></span><br><span class="line">WHITE = (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>)</span><br><span class="line">BLACK = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">RED = (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">window = pygame.display.set_mode((WINDOW_WIDTH, WINDOW_HEIGHT))</span><br><span class="line">pygame.display.set_caption(<span class="string">&#x27;贪吃蛇&#x27;</span>)</span><br><span class="line">font = pygame.font.Font(<span class="literal">None</span>, <span class="number">36</span>)</span><br><span class="line">snake = [</span><br><span class="line">    (<span class="number">200</span>, <span class="number">200</span>),</span><br><span class="line">    (<span class="number">210</span>, <span class="number">200</span>),</span><br><span class="line">    (<span class="number">220</span>, <span class="number">200</span>)]</span><br><span class="line">snake_direction = (SNAKE_SPEED, <span class="number">0</span>)</span><br><span class="line">food = ((random.randint(<span class="number">0</span>, WINDOW_WIDTH - SNAKE_SIZE) // SNAKE_SIZE) * SNAKE_SIZE, (random.randint(<span class="number">0</span>, WINDOW_HEIGHT - SNAKE_SIZE) // SNAKE_SIZE) * SNAKE_SIZE)</span><br><span class="line">key_bytes = <span class="built_in">bytes</span>((<span class="keyword">lambda</span> <span class="number">.0</span>: [ <span class="built_in">ord</span>(char) <span class="keyword">for</span> char <span class="keyword">in</span> <span class="number">.0</span> ])(key.xor_key))</span><br><span class="line">data = [</span><br><span class="line">    <span class="number">101</span>,</span><br><span class="line">    <span class="number">97</span>,</span><br><span class="line">    <span class="number">39</span>,</span><br><span class="line">    <span class="number">125</span>,</span><br><span class="line">    <span class="number">218</span>,</span><br><span class="line">    <span class="number">172</span>,</span><br><span class="line">    <span class="number">205</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    <span class="number">235</span>,</span><br><span class="line">    <span class="number">195</span>,</span><br><span class="line">    <span class="number">72</span>,</span><br><span class="line">    <span class="number">125</span>,</span><br><span class="line">    <span class="number">89</span>,</span><br><span class="line">    <span class="number">130</span>,</span><br><span class="line">    <span class="number">103</span>,</span><br><span class="line">    <span class="number">213</span>,</span><br><span class="line">    <span class="number">120</span>,</span><br><span class="line">    <span class="number">227</span>,</span><br><span class="line">    <span class="number">193</span>,</span><br><span class="line">    <span class="number">67</span>,</span><br><span class="line">    <span class="number">174</span>,</span><br><span class="line">    <span class="number">71</span>,</span><br><span class="line">    <span class="number">162</span>,</span><br><span class="line">    <span class="number">248</span>,</span><br><span class="line">    <span class="number">244</span>,</span><br><span class="line">    <span class="number">12</span>,</span><br><span class="line">    <span class="number">238</span>,</span><br><span class="line">    <span class="number">92</span>,</span><br><span class="line">    <span class="number">160</span>,</span><br><span class="line">    <span class="number">203</span>,</span><br><span class="line">    <span class="number">185</span>,</span><br><span class="line">    <span class="number">155</span>]</span><br><span class="line">decrypted_data = decrypt(<span class="built_in">bytes</span>(data), key_bytes)</span><br><span class="line">running = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> running:</span><br><span class="line">    window.fill(BLACK)</span><br><span class="line">    <span class="keyword">for</span> event <span class="keyword">in</span> pygame.event.get():</span><br><span class="line">        <span class="keyword">if</span> event.<span class="built_in">type</span> == pygame.QUIT:</span><br><span class="line">            running = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> event.<span class="built_in">type</span> == pygame.KEYDOWN <span class="keyword">or</span> event.key == pygame.K_UP:</span><br><span class="line">            snake_direction = (<span class="number">0</span>, -SNAKE_SPEED)</span><br><span class="line">        <span class="keyword">elif</span> event.key == pygame.K_DOWN:</span><br><span class="line">            snake_direction = (<span class="number">0</span>, SNAKE_SPEED)</span><br><span class="line">        <span class="keyword">elif</span> event.key == pygame.K_LEFT:</span><br><span class="line">            snake_direction = (-SNAKE_SPEED, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">elif</span> event.key == pygame.K_RIGHT:</span><br><span class="line">            snake_direction = (SNAKE_SPEED, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            snake_head = (snake[<span class="number">0</span>][<span class="number">0</span>] + snake_direction[<span class="number">0</span>], snake[<span class="number">0</span>][<span class="number">1</span>] + snake_direction[<span class="number">1</span>])</span><br><span class="line">            snake.insert(<span class="number">0</span>, snake_head)</span><br><span class="line">            snake.pop()</span><br><span class="line">            <span class="keyword">if</span> snake[<span class="number">0</span>] == food:</span><br><span class="line">                food = ((random.randint(<span class="number">0</span>, WINDOW_WIDTH - SNAKE_SIZE) // SNAKE_SIZE) * SNAKE_SIZE, (random.randint(<span class="number">0</span>, WINDOW_HEIGHT - SNAKE_SIZE) // SNAKE_SIZE) * SNAKE_SIZE)</span><br><span class="line">                snake.append(snake[-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> snake[<span class="number">0</span>][<span class="number">0</span>] &lt; <span class="number">0</span> <span class="keyword">and</span> snake[<span class="number">0</span>][<span class="number">0</span>] &gt;= WINDOW_WIDTH <span class="keyword">and</span> snake[<span class="number">0</span>][<span class="number">1</span>] &lt; <span class="number">0</span> <span class="keyword">and</span> snake[<span class="number">0</span>][<span class="number">1</span>] &gt;= WINDOW_HEIGHT <span class="keyword">or</span> snake[<span class="number">0</span>] <span class="keyword">in</span> snake[<span class="number">1</span>:]:</span><br><span class="line">        running = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> segment <span class="keyword">in</span> snake:</span><br><span class="line">        pygame.draw.rect(window, WHITE, (segment[<span class="number">0</span>], segment[<span class="number">1</span>], SNAKE_SIZE, SNAKE_SIZE))</span><br><span class="line">    pygame.draw.rect(window, RED, (food[<span class="number">0</span>], food[<span class="number">1</span>], SNAKE_SIZE, SNAKE_SIZE))</span><br><span class="line">    score_text = font.render(<span class="string">f&#x27;&#x27;&#x27;Score: <span class="subst">&#123;<span class="built_in">len</span>(snake)&#125;</span>&#x27;&#x27;&#x27;</span>, <span class="literal">True</span>, WHITE)</span><br><span class="line">    speed_text = font.render(<span class="string">f&#x27;&#x27;&#x27;Speed: <span class="subst">&#123;SNAKE_SPEED&#125;</span>&#x27;&#x27;&#x27;</span>, <span class="literal">True</span>, WHITE)</span><br><span class="line">    window.blit(score_text, (<span class="number">10</span>, <span class="number">10</span>))</span><br><span class="line">    window.blit(speed_text, (<span class="number">10</span>, <span class="number">40</span>))</span><br><span class="line">    score = <span class="built_in">len</span>(snake)</span><br><span class="line">    <span class="keyword">if</span> score &gt;= <span class="number">9999</span>:</span><br><span class="line">        flag_text = font.render(<span class="string">&#x27;Flag: &#x27;</span> + decrypted_data.decode(), <span class="literal">True</span>, WHITE)</span><br><span class="line">        window.blit(flag_text, (<span class="number">10</span>, <span class="number">70</span>))</span><br><span class="line">    pygame.display.update()</span><br><span class="line">    pygame.time.Clock().tick(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">pygame.quit()</span><br></pre></td></tr></table></figure><p>很明显是RC4加密，只需要找到key就行，key.pyc在PYZ-00.pyz_extracted里面也拖到在线编译网站</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xor_key = &#x27;V3rY_v3Ry_Ez&#x27;</span><br></pre></td></tr></table></figure><p>exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">def initialize(key):</span><br><span class="line">    key_length = len(key)</span><br><span class="line">    S = list(range(256))</span><br><span class="line">    j = 0</span><br><span class="line">    for i in range(256):</span><br><span class="line">        j = (j + S[i] + key[i % key_length]) % 256</span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">    return S</span><br><span class="line">def generate_key_stream(S, length):</span><br><span class="line">    i = 0</span><br><span class="line">    j = 0</span><br><span class="line">    key_stream = []</span><br><span class="line">    for _ in range(length):</span><br><span class="line">        i = (i + 1) % 256</span><br><span class="line">        j = (j + S[i]) % 256</span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        key_stream.append(S[(S[i] + S[j]) % 256])</span><br><span class="line">    return key_stream</span><br><span class="line">def decrypt(data, key):</span><br><span class="line">    # Convert key to list of byte values</span><br><span class="line">    key = [ord(c) for c in key]</span><br><span class="line">    S = initialize(key)</span><br><span class="line">    key_stream = generate_key_stream(S, len(data))</span><br><span class="line">    # XOR the data with the keystream to get the decrypted data</span><br><span class="line">    decrypted_data = [i^data[i] ^ key_stream[i] for i in range(len(data))]</span><br><span class="line">    return decrypted_data</span><br><span class="line">data = [</span><br><span class="line">    101, 97, 39, 125, 218, 172, 205, 3, 235, 195, 72, 125, 89, 130, 103, 213,</span><br><span class="line">    120, 227, 193, 67, 174, 71, 162, 248, 244, 12, 238, 92, 160, 203, 185, 155</span><br><span class="line">]</span><br><span class="line">key_bytes = &quot;V3rY_v3Ry_Ez&quot;</span><br><span class="line">decrypted_data = decrypt(data, key_bytes)</span><br><span class="line">for i  in range(len(decrypted_data)):</span><br><span class="line">    print(chr(decrypted_data[i]),end=&#x27;&#x27;)</span><br><span class="line">#flag&#123;KMLTz3lT_MePUDa7A_P5LpzCBT&#125;</span><br></pre></td></tr></table></figure><h2 id="HardSignin"><a href="#HardSignin" class="headerlink" title="HardSignin"></a>HardSignin</h2><img src="/2024/07/06/2024春秋联赛-夏季赛/" class="lazyload" data-srcset="/2024/07/06/2024春秋联赛-夏季赛/" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="  alt="20240706151337.png" style="zoom:150%;" /><p>改特征值，UPX脱壳</p><p><img src="https://s2.loli.net/2024/07/07/WOPuBho1XTAew4J.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/WOPuBho1XTAew4J.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><strong>TlsCallback_0</strong></p><p><img src="https://s2.loli.net/2024/07/07/THVt8lIPabNZ42y.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/THVt8lIPabNZ42y.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>TlsCallback0是SMC自修改</p><p><img src="https://s2.loli.net/2024/07/07/wR12UgKTfN7HDYe.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/wR12UgKTfN7HDYe.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><strong>TlsCallback_1</strong></p><p><img src="https://s2.loli.net/2024/07/07/qMlanTLVy2Wwi6s.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/qMlanTLVy2Wwi6s.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>顺便教大家一下这个花指令怎么恢复的最好</p><p>首先先不要去掉jz 和 jnz</p><p>我们先在下面标红的call指令那里按d</p><p><img src="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240707090034802.png" class="lazyload" data-srcset="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240707090034802.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20240707090034802"></p><p>然后在我光标的那里按c恢复</p><p><img src="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240707090155744.png" class="lazyload" data-srcset="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240707090155744.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20240707090155744"></p><p>然后恢复成这样，之后再把 hlt指令上面的全部nop掉，jz上面的不用</p><p><img src="https://s2.loli.net/2024/07/07/olH3cvT5yerzAIC.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/olH3cvT5yerzAIC.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们就可以按p生成函数了</p><p>把base64的table表魔改了</p><p><img src="https://s2.loli.net/2024/07/07/zswfOZUFJCMIjlB.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/zswfOZUFJCMIjlB.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><strong>TlsCallback_2</strong></p><p><img src="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240707090456001.png" class="lazyload" data-srcset="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240707090456001.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20240707090456001"></p><p><img src="https://s2.loli.net/2024/07/07/zQpWrXkDtGBgOfR.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/zQpWrXkDtGBgOfR.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>byte_4045B0,byte_4045A0这两个变量，后面会查到</p><p>ida脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x401890</span>,<span class="number">0x4019D1</span>):</span><br><span class="line">   patch_byte(i,get_wide_byte(i)^<span class="number">0x66</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;done!&quot;</span>)</span><br></pre></td></tr></table></figure><p>还原main函数</p><img src="/2024/07/06/2024春秋联赛-夏季赛/" class="lazyload" data-srcset="/2024/07/06/2024春秋联赛-夏季赛/" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="  style="zoom:150%;" /><p><img src="https://s2.loli.net/2024/07/06/Gxy8ceHAo57lgkP.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/06/Gxy8ceHAo57lgkP.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rc4_init</span><span class="params">(<span class="type">uint8_t</span>* s, <span class="type">uint8_t</span>* key, <span class="type">unsigned</span> <span class="type">long</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> k[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">uint8_t</span> temp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s[i] = i;         </span><br><span class="line">        k[i] = key[i % len];   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        j = (j + s[i] + k[i]) % <span class="number">256</span>;    </span><br><span class="line">        temp = s[i];</span><br><span class="line">        s[i] = s[j];</span><br><span class="line">        s[j] = temp;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rc4_crypt</span><span class="params">(<span class="type">uint8_t</span>* s, <span class="type">uint8_t</span>* data, <span class="type">unsigned</span> <span class="type">long</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, t = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> k = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> temp;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; len; k++)</span><br><span class="line">    &#123;</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span>;            </span><br><span class="line">        j = (j + s[i]) % <span class="number">256</span>;          </span><br><span class="line">        temp = s[i];</span><br><span class="line">        s[i] = s[j];</span><br><span class="line">        s[j] = temp;            </span><br><span class="line">        t = (s[i] + s[j]) % <span class="number">256</span>;      </span><br><span class="line">        data[k] ^= s[t];          </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">encipher</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_rounds, <span class="type">uint32_t</span> v[<span class="number">2</span>], <span class="type">uint32_t</span>  key[<span class="number">4</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">    <span class="type">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>], sum = <span class="number">0</span>, delta = <span class="number">0x61C88647</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_rounds; i++) &#123;</span><br><span class="line">        v0 += (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum + key[sum &amp; <span class="number">3</span>]);</span><br><span class="line">        sum -= delta;</span><br><span class="line">        v1 += (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum + key[(sum &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    v[<span class="number">0</span>] = v0; v[<span class="number">1</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decipher</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_rounds, <span class="type">uint32_t</span> v[<span class="number">2</span>], <span class="type">uint32_t</span>  key[<span class="number">4</span>])</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">    <span class="type">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>], delta = <span class="number">0x61C88647</span>, sum = <span class="number">0xcdab8c44</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_rounds; i++) &#123;</span><br><span class="line">        v1 -= (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum + key[(sum &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>]);</span><br><span class="line">        sum += delta;</span><br><span class="line">        v0 -= (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum + key[sum &amp; <span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    v[<span class="number">0</span>] = v0; v[<span class="number">1</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    srand(<span class="number">0x1919810</span>);</span><br><span class="line">    <span class="type">uint8_t</span> key[<span class="number">16</span>];</span><br><span class="line">    <span class="type">uint8_t</span> key1[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        key[i] = rand() % <span class="number">0xff</span>;</span><br><span class="line">        key1[i] = rand() % <span class="number">0xff</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint8_t</span> enc[<span class="number">64</span>] = &#123; <span class="number">0x59</span>, <span class="number">0x1B</span>, <span class="number">0xFD</span>, <span class="number">0xB4</span>, <span class="number">0x6B</span>, <span class="number">0xB8</span>, <span class="number">0xBE</span>, <span class="number">0xD9</span>, <span class="number">0xB3</span>, <span class="number">0xD3</span>, <span class="number">0x77</span>, <span class="number">0xD6</span>, <span class="number">0xF0</span>, <span class="number">0x65</span>, <span class="number">0x5F</span>, <span class="number">0x18</span>, <span class="number">0xA0</span>, <span class="number">0x9D</span>, <span class="number">0x3A</span>, <span class="number">0x53</span>, <span class="number">0x6D</span>, <span class="number">0x4A</span>, <span class="number">0x7B</span>, <span class="number">0x26</span>, <span class="number">0x74</span>, <span class="number">0x3A</span>, <span class="number">0x9C</span>, <span class="number">0x4E</span>, <span class="number">0x20</span>, <span class="number">0x43</span>, <span class="number">0x19</span>, <span class="number">0xD8</span>, <span class="number">0x72</span>, <span class="number">0xED</span>, <span class="number">0x95</span>, <span class="number">0xB5</span>, <span class="number">0x9C</span>, <span class="number">0x05</span>, <span class="number">0x22</span>, <span class="number">0x56</span>, <span class="number">0xCB</span>, <span class="number">0x7A</span>, <span class="number">0x11</span>, <span class="number">0x91</span>, <span class="number">0x9F</span>, <span class="number">0x7A</span>, <span class="number">0xBC</span>, <span class="number">0x0C</span>, <span class="number">0x4A</span>, <span class="number">0x69</span>, <span class="number">0x6D</span>, <span class="number">0xCE</span>, <span class="number">0x3D</span>, <span class="number">0xB4</span>, <span class="number">0xAB</span>, <span class="number">0x29</span>, <span class="number">0x61</span>, <span class="number">0xFA</span>, <span class="number">0x62</span>, <span class="number">0x32</span>, <span class="number">0xB4</span>, <span class="number">0xEC</span>, <span class="number">0x4C</span>, <span class="number">0xB6</span> &#125;;</span><br><span class="line">    <span class="type">uint8_t</span> s[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i += <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        decipher(<span class="number">100</span>,(<span class="type">uint32_t</span>*)(enc + i), (<span class="type">uint32_t</span>*)key1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc4_init(s, key, <span class="number">16</span>);</span><br><span class="line">    rc4_crypt(s, enc, <span class="number">64</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, enc[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>换表base64解密之后得到flag</p><p>flag{C0ngr@tulat1on!Y0u_Re_suCces3fu1Ly_Signln!}</p><h2 id="BEDTEA"><a href="#BEDTEA" class="headerlink" title="BEDTEA"></a>BEDTEA</h2><p><img src="https://s2.loli.net/2024/07/07/vz9UR8PKZQ4Gf63.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/vz9UR8PKZQ4Gf63.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://s2.loli.net/2024/07/07/lEMSb754WuYwyRe.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/lEMSb754WuYwyRe.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://s2.loli.net/2024/07/07/1VmtiX8B2GxE3Fv.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/1VmtiX8B2GxE3Fv.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这个题里面没有反调试，但是有一个检测是否被调试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">byte_404010 = !IsDebuggerPresent() ? 3 : 1;</span><br></pre></td></tr></table></figure><p>这是一个三元运算符</p><p><img src="https://s2.loli.net/2024/07/07/CKpeLhXQmGiwUuy.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/CKpeLhXQmGiwUuy.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>一开始我们并不知道这个作用是什么，那么我们就看一下哪里引用了它发现它在tea加密里面有被用到，经过调试可知明文为24个字节，已经三次tea加密里面的密钥都不相等</p><p><img src="https://s2.loli.net/2024/07/07/AqurYk5mzvQoCf3.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/AqurYk5mzvQoCf3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>但是这个密钥生成的过程看着很繁琐，为了节约时间，我们要下断点得到密钥</p><p><img src="https://s2.loli.net/2024/07/07/HfWuctUkdDSmPhG.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/07/HfWuctUkdDSmPhG.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>每次断在这里，然后查看byte_408040的内存</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::chrono::_V2::system_clock::now(v7) - v4 &lt;= 10000999</span><br></pre></td></tr></table></figure><p>这个其实就是算误差的但是程序运行和我们调试的时候误差是不一样的，在调试的时候我们走的是else，但是正常程序运行应该是走if那里，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_mm_load_si128 // 就是加载内存中128位的值，并且放到向量空间里面</span><br><span class="line">_mm_xor_si128（值，si128）//就是你的值和sil128 每个值进行异或</span><br></pre></td></tr></table></figure><p>然后我们回到一开始检测调试器那里，调试的时候那里的值是1，在里面改为3，然后就会生成不同的密钥exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">encrypt</span><span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* <span class="built_in">array</span>)</span> &#123;</span><br><span class="line"><span class="type">uint32_t</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">sum -= <span class="number">0x61CBB648</span>;</span><br><span class="line">v0 += ((v1 &gt;&gt; <span class="number">4</span>) + <span class="built_in">array</span>[<span class="number">1</span>]) ^ (v1 + sum) ^ ((v1 &lt;&lt; <span class="number">5</span>) + <span class="built_in">array</span>[<span class="number">0</span>]);</span><br><span class="line">v1 += ((v0 &gt;&gt; <span class="number">4</span>) + <span class="built_in">array</span>[<span class="number">3</span>]) ^ (v0 + sum) ^ ((v0 &lt;&lt; <span class="number">5</span>) + <span class="built_in">array</span>[<span class="number">2</span>]);</span><br><span class="line">&#125; <span class="keyword">while</span> (sum != <span class="number">0x987E55D0</span>);</span><br><span class="line">v[<span class="number">0</span>] = v0; v[<span class="number">1</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt</span><span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* <span class="built_in">array</span>)</span> &#123;</span><br><span class="line"><span class="type">uint32_t</span> sum = <span class="number">0x987E55D0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">v1 -= ((v0 &gt;&gt; <span class="number">4</span>) + <span class="built_in">array</span>[<span class="number">3</span>]) ^ (v0 + sum) ^ ((v0 &lt;&lt; <span class="number">5</span>) + <span class="built_in">array</span>[<span class="number">2</span>]);</span><br><span class="line">v0 -= ((v1 &gt;&gt; <span class="number">4</span>) + <span class="built_in">array</span>[<span class="number">1</span>]) ^ (v1 + sum) ^ ((v1 &lt;&lt; <span class="number">5</span>) + <span class="built_in">array</span>[<span class="number">0</span>]);</span><br><span class="line">sum += <span class="number">0x61CBB648</span>;</span><br><span class="line">&#125; <span class="keyword">while</span> (sum != <span class="number">0</span>);</span><br><span class="line">v[<span class="number">0</span>] = v0; v[<span class="number">1</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint32_t</span> key1[<span class="number">4</span>] = &#123; <span class="number">0x00000003</span>, <span class="number">0x00000005</span>, <span class="number">0x00000008</span>, <span class="number">0x0000000D</span> &#125;;</span><br><span class="line"><span class="type">uint32_t</span> key2[<span class="number">4</span>] = &#123; <span class="number">0x00000015</span>, <span class="number">0x00000022</span>, <span class="number">0x00000037</span>, <span class="number">0x00000059</span> &#125;;</span><br><span class="line"><span class="type">uint32_t</span> key3[<span class="number">4</span>] = &#123; <span class="number">0x00000090</span>, <span class="number">0x000000E9</span>, <span class="number">0x00000179</span>, <span class="number">0x00000262</span> &#125;;</span><br><span class="line"><span class="type">uint8_t</span> flag[<span class="number">24</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">uint8_t</span> enc[<span class="number">24</span>] = &#123; <span class="number">0x76</span>, <span class="number">0x71</span>, <span class="number">0x9D</span>, <span class="number">0xE7</span>, <span class="number">0x70</span>, <span class="number">0x77</span>, <span class="number">0x3F</span>, <span class="number">0xA3</span>, <span class="number">0x02</span>, <span class="number">0xF1</span>, <span class="number">0x8D</span>, <span class="number">0xC9</span>, <span class="number">0x02</span>, <span class="number">0xC6</span>, <span class="number">0xA2</span>, <span class="number">0x4B</span>, <span class="number">0xBA</span>, <span class="number">0x19</span>, <span class="number">0x56</span>, <span class="number">0x05</span>, <span class="number">0xF2</span>, <span class="number">0x89</span>, <span class="number">0x5E</span>, <span class="number">0xE0</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;<span class="number">24</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">enc[i] ^= <span class="number">0x33</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; ++i) &#123;</span><br><span class="line">flag[i] = enc[<span class="number">23</span>- i];</span><br><span class="line">&#125;</span><br><span class="line">decrypt((<span class="type">uint32_t</span>*)(flag + <span class="number">16</span>), key3);</span><br><span class="line">decrypt((<span class="type">uint32_t</span>*)(flag + <span class="number">8</span>), key2);</span><br><span class="line">decrypt((<span class="type">uint32_t</span>*)flag, key1);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, flag[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#flag&#123;y0u_reallyl1ke_te@&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;REVERSE&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;snack&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;HardSignin&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;BEDTEA&lt;/strong&gt;&lt;/li&gt;
&lt;</summary>
      
    
    
    
    <category term="逆向" scheme="https://5m10v3.top/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="ctf学习" scheme="https://5m10v3.top/tags/ctf%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>C/C++逆向学习(一)</title>
    <link href="https://5m10v3.top/2024/07/02/C%20orC++%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0(%E4%B8%80)/"/>
    <id>https://5m10v3.top/2024/07/02/C%20orC++%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0(%E4%B8%80)/</id>
    <published>2024-07-01T16:00:00.000Z</published>
    <updated>2024-07-06T14:00:54.316Z</updated>
    
    <content type="html"><![CDATA[<p>为啥要开个这个专题，一方面是为了巩固自己在逆向基础的知识，另一方面是为了给以后的学弟指一条明路吧，以前的时候太依赖IDA的F5了，这次学习从另一个角度重新学习逆向</p><p><img src="https://s2.loli.net/2024/07/04/D5paeXbTPREqAQM.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/D5paeXbTPREqAQM.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="汇编眼中的函数"><a href="#汇编眼中的函数" class="headerlink" title="汇编眼中的函数"></a>汇编眼中的函数</h3><p>由于现在编译器的发展，使得我们的代码得到了极大的优化，这使我们编译出的代码并不是那么适合调试，因此笔者选择VC++ 6.0 进行编写</p><p><img src="https://s2.loli.net/2024/07/04/I4hKwn5Nlkqug2v.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/I4hKwn5Nlkqug2v.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://s2.loli.net/2024/07/04/kIBGKZ5N1Jnfz4o.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/kIBGKZ5N1Jnfz4o.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后将生成的exe拖到x32dbg里面，定位到main函数 ，我们此时断在的这个点就是我们要调用的函数，这里我们选择堆栈图来进行描述</p><p>首先进行call test.401005</p><p>call 其实也是一种push的操作，相当于把下一个指令的地址压入栈中</p><p><img src="https://s2.loli.net/2024/07/04/F3OXlJPaUkD7NSw.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/F3OXlJPaUkD7NSw.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这个时候我们发现EIP的值发生了变化，eip的值就是下一个指令的地址</p><p>至于开头这个jmp，是编译器搞的，可以不用去理解这个</p><p><img src="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240704161706224.png" class="lazyload" data-srcset="C:/Users/sm1ov3/AppData/Roaming/Typora/typora-user-images/image-20240704161706224.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20240704161706224"></p><p>之后就是push操作，我们不再一步一步分析，直接画出堆栈图，然后再一一对比</p><p><img src="https://s2.loli.net/2024/07/04/ZVhnvmOclI24PEA.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/ZVhnvmOclI24PEA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://s2.loli.net/2024/07/04/ZT1cp38dILStJ7i.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/ZT1cp38dILStJ7i.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们发现最后堆栈是平衡的。</p><h3 id="裸函数"><a href="#裸函数" class="headerlink" title="裸函数"></a>裸函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//裸函数的格式</span></span><br><span class="line">数据类型 _declspec(naked) 函数名称()</span><br><span class="line">&#123;</span><br><span class="line">    函数语句;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/07/04/zBMSqXdp9ZKtivR.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/zBMSqXdp9ZKtivR.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们运行之后发现会报错,然后我们可以看一下反汇编</p><p>​<img src="https://s2.loli.net/2024/07/04/wXki1lGYSoEqzMu.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/wXki1lGYSoEqzMu.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>之后就会发现这个跟我之前再x32dbg里面调的不一样，这个里面全都是int3 中断</p><p>那么如何让这个程序正常运行起来呢，我们可以采用内联汇编的方式</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> _declspec(naked) Function()</span><br><span class="line">&#123;</span><br><span class="line">__asm </span><br><span class="line">&#123;</span><br><span class="line">PUSH EBP</span><br><span class="line">MOV EBP, ESP</span><br><span class="line">SUB ESP,<span class="number">0x40</span></span><br><span class="line"></span><br><span class="line">PUSH EBX</span><br><span class="line">PUSH ESI</span><br><span class="line">PUSH EDI</span><br><span class="line"></span><br><span class="line">LEA EDI, DWORD PTR DS:[EBP<span class="number">-0x40</span>]</span><br><span class="line"></span><br><span class="line">MOV EAX,<span class="number">0xCCCCCCCC</span></span><br><span class="line">MOV ECX, <span class="number">0x10</span></span><br><span class="line">REP STOSD</span><br><span class="line"></span><br><span class="line">POP EDI</span><br><span class="line">POP ESI</span><br><span class="line">POP EBX</span><br><span class="line"></span><br><span class="line">MOV ESP,EBP</span><br><span class="line">POP EBP</span><br><span class="line"></span><br><span class="line">RET</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">Function();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="局部变量的体现"><a href="#局部变量的体现" class="headerlink" title="局部变量的体现"></a>局部变量的体现</h3><p><img src="https://s2.loli.net/2024/07/04/6KdB1klXmsh7aZt.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/6KdB1klXmsh7aZt.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://s2.loli.net/2024/07/04/yikQs1MJLtmhqxe.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/yikQs1MJLtmhqxe.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这里就不像上一个有过多的文字描述了，看堆栈图即可</p><h3 id="裸函数-局部变量定义"><a href="#裸函数-局部变量定义" class="headerlink" title="裸函数(局部变量定义)"></a>裸函数(局部变量定义)</h3><p>我们要学会举一反三</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">z</span><br><span class="line"><span class="type">void</span> _declspec(naked) Function()</span><br><span class="line">&#123;</span><br><span class="line">__asm </span><br><span class="line">&#123;</span><br><span class="line">PUSH EBP</span><br><span class="line"></span><br><span class="line">MOV EBP,ESP</span><br><span class="line">SUB ESP,<span class="number">0x4C</span></span><br><span class="line"></span><br><span class="line">PUSH EBX</span><br><span class="line">PUSH ESI</span><br><span class="line">PUSH EDI</span><br><span class="line"></span><br><span class="line">LEA EDI,DWORD PTR DS:[EBP - <span class="number">0x4C</span>]</span><br><span class="line">MOV EAX,<span class="number">0xCCCCCCCC</span></span><br><span class="line">MOV ECX,<span class="number">13</span></span><br><span class="line">REP STOSD</span><br><span class="line"></span><br><span class="line">MOV DWORD PTR DS:[EBP - <span class="number">0x4</span>],<span class="number">1</span></span><br><span class="line">MOV DWORD PTR DS:[EBP - <span class="number">0x8</span>],<span class="number">2</span></span><br><span class="line">        MOV EAX, DWORD PTR DS : [EBP - <span class="number">0x4</span>]</span><br><span class="line">ADD EAX, DWORD PTR DS : [EBP - <span class="number">0x8</span>]</span><br><span class="line">MOV DWORD PTR DS : [EBP - <span class="number">0xC</span>],EAX</span><br><span class="line"></span><br><span class="line">POP EDI</span><br><span class="line">POP ESI </span><br><span class="line">POP EBX</span><br><span class="line"></span><br><span class="line">MOV ESP, EBP</span><br><span class="line">POP EBP</span><br><span class="line">RET</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">Function();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="返回值的传递"><a href="#返回值的传递" class="headerlink" title="返回值的传递"></a>返回值的传递</h3><p><img src="https://s2.loli.net/2024/07/04/53vjeRaOlEf7AXV.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/53vjeRaOlEf7AXV.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>xxxxxxxxxx void CInjectDllDlg::UnInjectDll(DWORD dwPid, LPCSTR szDllName){    &#x2F;&#x2F; TODO: 在此处添加实现代码.    if (dwPid &#x3D;&#x3D; 0 || strlen(szDllName) &#x3D;&#x3D; 0)    {        return;    }​    &#x2F;&#x2F;创建DLL快照    HANDLE hSnap &#x3D; CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, dwPid);    MODULEENTRY32 me32;    me32.dwSize &#x3D; sizeof(me32);        &#x2F;&#x2F;这里寻找指定的dll信息,找到了后,结构体里的hModule参数里会存有dll模块句柄    BOOL bRet &#x3D; Module32First(hSnap,&amp;me32);    TCHAR szDllNameW[MAX_PATH] &#x3D; { 0 };    MultiByteToWideChar(CP_ACP, NULL, szDllName, -1, szDllNameW, strlen(szDllName));    while (bRet) {        if (lstrcmp(_wcsupr(me32.szExePath), _wcsupr(szDllNameW)) &#x3D;&#x3D; 0) {            break;        }        bRet &#x3D; Module32Next(hSnap, &amp;me32);    }    CloseHandle(hSnap);    char* pFunName &#x3D; “FreeLibrary”;    &#x2F;&#x2F; 打开目标进程    HANDLE hProcess &#x3D; OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);​    if (hProcess &#x3D;&#x3D; NULL)    {        return;    }    &#x2F;&#x2F; 计算欲注入DLL文件完整路径的长度    int nDllLen &#x3D; strlen(szDllName) + sizeof(TCHAR);​    &#x2F;&#x2F;获得函数的地址    FARPROC pFunAddr &#x3D; GetProcAddress(GetModuleHandle(L”kernel32.dll”), pFunName);        &#x2F;&#x2F; 创建远程线程    HANDLE hThread &#x3D; CreateRemoteThread(hProcess,        NULL, 0,        (PTHREAD_START_ROUTINE)pFunAddr,&#x2F;&#x2F;LoadLibraryA函数        me32.hModule,        &#x2F;&#x2F;参数是dll地址指针        0, NULL);    &#x2F;&#x2F;WaitForSingleObject(hThread, INFINITE);&#x2F;&#x2F;等待线程执行完毕​    CloseHandle(hThread);    CloseHandle(hProcess);}c++</p><p>我们经过堆栈图的分析之后</p><p><img src="https://s2.loli.net/2024/07/04/yikQs1MJLtmhqxe.png" class="lazyload" data-srcset="https://s2.loli.net/2024/07/04/yikQs1MJLtmhqxe.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>发现跟之前那个一模一样</p><p>call 完函数之后，eax是我们最后return的值，但是这里的[ebp - 4]是 恢复堆栈平衡之后的地址，这里其实是main函数里面的局部变量</p><h3 id="裸函数-返回值的传递"><a href="#裸函数-返回值的传递" class="headerlink" title="裸函数(返回值的传递)"></a>裸函数(返回值的传递)</h3><p>这里做个小练习</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fun</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a=<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> b=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> a^b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a= fun();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> _declspec(naked) function()</span><br><span class="line">&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp ,esp</span><br><span class="line">        sub esp,<span class="number">0x4c</span></span><br><span class="line"></span><br><span class="line">        push ebx</span><br><span class="line">        push esi</span><br><span class="line">        push edi</span><br><span class="line">        lea edi,dword ptr ds:[ebp - <span class="number">0x4c</span>]</span><br><span class="line">        mov ecx ,<span class="number">13</span></span><br><span class="line">        mov eax,<span class="number">0xcccccccc</span></span><br><span class="line">        rep stosd</span><br><span class="line"></span><br><span class="line">        mov dword ptr ds:[ebp - <span class="number">0x4</span>],<span class="number">1</span></span><br><span class="line">        mov dword ptr ds:[ebp - <span class="number">0x8</span>],<span class="number">2</span></span><br><span class="line">        mov eax, dword ptr ds : [ebp - <span class="number">0x4</span>]</span><br><span class="line">        xor eax, dword ptr ds : [ebp - <span class="number">0x8</span>]</span><br><span class="line">        mov eax ,ecx</span><br><span class="line">        pop edi</span><br><span class="line">        pop esi</span><br><span class="line">        pop ebx</span><br><span class="line"></span><br><span class="line">        mov esp,ebp</span><br><span class="line">        pop ebp</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = function();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对比之后发现是一模一样</p><h3 id="参数的传递"><a href="#参数的传递" class="headerlink" title="参数的传递"></a>参数的传递</h3><p>示例</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> c = a + b;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = add(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="C:/Users/sm1ov3/Desktop/堆栈图2.png" class="lazyload" data-srcset="C:/Users/sm1ov3/Desktop/堆栈图2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="堆栈图2"></p><h3 id="裸函数-参数的传递"><a href="#裸函数-参数的传递" class="headerlink" title="裸函数(参数的传递)"></a>裸函数(参数的传递)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> _declspec(naked)add(<span class="type">int</span> a, <span class="type">int</span> b)</span><br><span class="line">&#123;</span><br><span class="line">    __asm </span><br><span class="line">    &#123;</span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp, esp</span><br><span class="line">        sub esp,<span class="number">0xcc</span></span><br><span class="line">        push ebx</span><br><span class="line">        push esi</span><br><span class="line">        push edi</span><br><span class="line">        lea edi,dword ptr ds:[ebp<span class="number">-0xc</span>]</span><br><span class="line">        mov eax,<span class="number">0xcccccccc</span></span><br><span class="line">        mov ecx,<span class="number">3</span></span><br><span class="line">        rep stosd</span><br><span class="line"></span><br><span class="line">        mov eax,dword ptr [ebp+<span class="number">0x8</span>]</span><br><span class="line">        add eax,dword ptr [ebp+<span class="number">0xc</span>]</span><br><span class="line">        mov dword ptr[ebp<span class="number">-0x8</span>],eax</span><br><span class="line">        mov eax, dword ptr[ebp - <span class="number">0x8</span>]</span><br><span class="line"></span><br><span class="line">        pop edi</span><br><span class="line">        pop esi</span><br><span class="line">        pop ebx</span><br><span class="line"></span><br><span class="line">        add esp,<span class="number">0xcc</span></span><br><span class="line">        pop ebp</span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = add(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="嵌套调用分析"><a href="#嵌套调用分析" class="headerlink" title="嵌套调用分析"></a>嵌套调用分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">fun1</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span> temp = a;</span><br><span class="line">   a=b;</span><br><span class="line">   b=temp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fun2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> a=<span class="number">10</span>;</span><br><span class="line"><span class="type">int</span> b=<span class="number">20</span>;</span><br><span class="line">fun1(a,b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">fun2();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析堆栈图</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;为啥要开个这个专题，一方面是为了巩固自己在逆向基础的知识，另一方面是为了给以后的学弟指一条明路吧，以前的时候太依赖IDA的F5了，这次学习从另一个角度重新学习逆向&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/07/04/D5paeXb</summary>
      
    
    
    
    <category term="逆向" scheme="https://5m10v3.top/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>日记(27)</title>
    <link href="https://5m10v3.top/2024/07/01/%E6%97%A5%E8%AE%B0(27)/"/>
    <id>https://5m10v3.top/2024/07/01/%E6%97%A5%E8%AE%B0(27)/</id>
    <published>2024-06-30T16:00:00.000Z</published>
    <updated>2024-07-01T14:07:35.233Z</updated>
    
    <content type="html"><![CDATA[<p>期末周终于过去了，自己的生活也调整过来了，这个暑假准备沉淀一下关于二进制安全的学习</p><p>从明天开始，一天一更！！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;期末周终于过去了，自己的生活也调整过来了，这个暑假准备沉淀一下关于二进制安全的学习&lt;/p&gt;
&lt;p&gt;从明天开始，一天一更！！&lt;/p&gt;
</summary>
      
    
    
    
    <category term="日记" scheme="https://5m10v3.top/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>日记(26)</title>
    <link href="https://5m10v3.top/2024/06/15/%E6%97%A5%E8%AE%B0(26)/"/>
    <id>https://5m10v3.top/2024/06/15/%E6%97%A5%E8%AE%B0(26)/</id>
    <published>2024-06-14T16:00:00.000Z</published>
    <updated>2024-06-15T08:12:34.226Z</updated>
    
    <content type="html"><![CDATA[<p>近来学习了白龙大佬的白盒密码学系列，感觉受益匪浅，有种高山流水觅知音的感觉，也认识了跟自己志同道合的伙伴，今日上午也去考了第一次四级考试（希望没有第二次哈哈哈哈哈哈）<br>在闲暇之余也观看了跟自己同为大一下的师傅们的文章<br>一句话总结：“一山更比一山高”<br>但是这也更让我提起兴趣了，因为可以挑战这么多强有力的对手，同时也激励自己继续学<br>在这里说一下暑假的安排吧</p><ul><li><p>学习一下《逆向工程核心原理》这本书里面的知识，给自己打下一个坚实的基础吧</p></li><li><p>同时也多做题（尽量用新学到的知识去做）</p></li><li><p>多弄一些安卓知识</p></li><li><p>学习游戏安全相关的知识</p><p>在最后想用小排球里面的这张图激励自己</p><p><img src="https://s2.loli.net/2024/06/15/KnvqJ6gZFX5AcGE.jpg" class="lazyload" data-srcset="https://s2.loli.net/2024/06/15/KnvqJ6gZFX5AcGE.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;近来学习了白龙大佬的白盒密码学系列，感觉受益匪浅，有种高山流水觅知音的感觉，也认识了跟自己志同道合的伙伴，今日上午也去考了第一次四级考试（希望没有第二次哈哈哈哈哈哈）&lt;br&gt;在闲暇之余也观看了跟自己同为大一下的师傅们的文章&lt;br&gt;一句话总结：“一山更比一山高”&lt;br&gt;但是这</summary>
      
    
    
    
    <category term="日记" scheme="https://5m10v3.top/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>第七届强网杯-dotdot复现及思考</title>
    <link href="https://5m10v3.top/2024/06/13/%E7%AC%AC%E4%B8%83%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF-dotdot%E5%A4%8D%E7%8E%B0%E5%8F%8A%E6%80%9D%E8%80%83/"/>
    <id>https://5m10v3.top/2024/06/13/%E7%AC%AC%E4%B8%83%E5%B1%8A%E5%BC%BA%E7%BD%91%E6%9D%AF-dotdot%E5%A4%8D%E7%8E%B0%E5%8F%8A%E6%80%9D%E8%80%83/</id>
    <published>2024-06-12T16:00:00.000Z</published>
    <updated>2024-06-14T11:08:28.072Z</updated>
    
    <content type="html"><![CDATA[<p>以下为题目链接，供各位师傅下载练习<br><a href="https://wwb.lanzout.com/iovY721r8pva">https://wwb.lanzout.com/iovY721r8pva</a></p><p>涉及考点: 白盒AES,.net程序的序列化模块，反序列化文件修复</p><p>工具使用：</p><p><a href="https://github.com/dnSpy/dnSpy/releases/tag/v6.1.8">dnspy</a></p><p><a href="https://github.com/icsharpcode/ILSpy/releases">ILSpy</a></p><p>我们将dotdot.exe拖到dnspy里面分析一下</p><p><img src="https://s2.loli.net/2024/06/14/tUzKegJhYIRHZsL.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/tUzKegJhYIRHZsL.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们对函数逐个分析</p><p>BBB函数是对字符串的检验，长度为16</p><p><img src="https://s2.loli.net/2024/06/14/2pm7MQVCTfx89hH.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/2pm7MQVCTfx89hH.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>这个函数是基于查表法实现的AES，很明显他没有让你输入密钥的过程</p><p>那我们该如何对它进行分析呢，这个时候我们就要使用DFA 差分故障攻击的方法</p><p>什么是差分故障攻击呢，简单来说就是插入故障数据，然后导致最后生成密文改变，从而推导出最后一轮密钥</p><p>由于dnspy是可以直接在上面修改源码的，所以我们直接在上面修改源码，然后重新编译。</p><p><img src="https://s2.loli.net/2024/06/14/TUo8RFedYpXzMvy.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/TUo8RFedYpXzMvy.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>右键选择编辑方法，修改之后选择编辑，这个时候我们还不能调</p><p><img src="https://s2.loli.net/2024/06/14/kYwAGMIhj7lsf3F.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/kYwAGMIhj7lsf3F.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>需要保存模块，点击全部保存，它会将这些的修改全都保存在新的exe里面，默认是覆盖原文件，这里我选择默认</p><p><img src="https://s2.loli.net/2024/06/14/DfxmoPQK1rZgEi9.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/DfxmoPQK1rZgEi9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们首先先来测试一下，没有插入故障数据的时候，第十轮的密文是什么样的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试数据</span></span><br><span class="line">daolwoayxawdwadg</span><br><span class="line"><span class="comment">#正常密文</span></span><br><span class="line">A9F4EC008E731B715FFAE5EA2C4F3EEC</span><br></pre></td></tr></table></figure><p>我们在进行最后一轮之前插入一个字节的故障数据，然后看密文是什么样子</p><p><img src="https://s2.loli.net/2024/06/14/MgZyKl3o7Fb89xz.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/MgZyKl3o7Fb89xz.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们发现有四个字节不一样，说明我们插入的地方是正确的，我们多记录几个数据aaa[index]&#x3D;x,index和x的值是要发生变化的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#故障密文</span></span><br><span class="line">A908B4918EE75DD85F4C82002C2AE133</span><br><span class="line">3BF4EC008E731B875FFA3EEA2C7A3EEC</span><br><span class="line">A9F4EC5C8E730F715FC0E5EA124F3EEC</span><br><span class="line">A9F4A2008E281B71C5FAE5EA2C4F3E0B</span><br><span class="line">A9DDEC0033731B715FFAE5932C4F99EC</span><br><span class="line">A9C9EC00A2731B715FFAE5B72C4F10EC </span><br><span class="line">05F4EC008E731B165FFAD1EA2C1F3EEC</span><br><span class="line">A9F4EC948E7357715F88E5EA574F3EEC</span><br><span class="line">A9F401008EEB1B7166FAE5EA2C4F3E29</span><br><span class="line">A9F4B6008E601B7124FAE5EA2C4F3E77</span><br><span class="line">A904EC00EC731B715FFAE5392C4F08EC</span><br><span class="line">98F4EC008E731B535FFA43EA2C5A3EEC</span><br><span class="line">A9F4ECF98E73F5715F1FE5EA124F3EEC</span><br><span class="line">A9F403008ECE1B710FFAE5EA2C4F3E65</span><br><span class="line">A956EC0020731B715FFAE5252C4F39EC</span><br><span class="line">0CF4EC008E731BAB5FFADEEA2CAB3EEC</span><br></pre></td></tr></table></figure><p>然后这里有个非常好用的库，phoenixAES,可以帮我们恢复最后一轮的密钥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> phoenixAES</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;tracefile&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> t:</span><br><span class="line">    t.write(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">A9F4EC008E731B715FFAE5EA2C4F3EEC</span></span><br><span class="line"><span class="string">A908B4918EE75DD85F4C82002C2AE133</span></span><br><span class="line"><span class="string">3BF4EC008E731B875FFA3EEA2C7A3EEC</span></span><br><span class="line"><span class="string">A9F4EC5C8E730F715FC0E5EA124F3EEC</span></span><br><span class="line"><span class="string">A9F4A2008E281B71C5FAE5EA2C4F3E0B</span></span><br><span class="line"><span class="string">A9DDEC0033731B715FFAE5932C4F99EC</span></span><br><span class="line"><span class="string">A9C9EC00A2731B715FFAE5B72C4F10EC </span></span><br><span class="line"><span class="string">05F4EC008E731B165FFAD1EA2C1F3EEC</span></span><br><span class="line"><span class="string">A9F4EC948E7357715F88E5EA574F3EEC</span></span><br><span class="line"><span class="string">A9F401008EEB1B7166FAE5EA2C4F3E29</span></span><br><span class="line"><span class="string">A9F4B6008E601B7124FAE5EA2C4F3E77</span></span><br><span class="line"><span class="string">A904EC00EC731B715FFAE5392C4F08EC</span></span><br><span class="line"><span class="string">98F4EC008E731B535FFA43EA2C5A3EEC</span></span><br><span class="line"><span class="string">A9F4ECF98E73F5715F1FE5EA124F3EEC</span></span><br><span class="line"><span class="string">A9F403008ECE1B710FFAE5EA2C4F3E65</span></span><br><span class="line"><span class="string">A956EC0020731B715FFAE5252C4F39EC</span></span><br><span class="line"><span class="string">0CF4EC008E731BAB5FFADEEA2CAB3EEC</span></span><br><span class="line"><span class="string">     &quot;&quot;&quot;</span>.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">phoenixAES.crack_file(<span class="string">&#x27;tracefile&#x27;</span>,verbose=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/06/14/KJkRQ8d17HrwLUb.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/KJkRQ8d17HrwLUb.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们再用GitHub上面的stark<a href="https://github.com/SideChannelMarvels/Stark/blob/master/aes_keyschedule.c">https://github.com/SideChannelMarvels/Stark/blob/master/aes_keyschedule.c</a></p><p>自己生成exe</p><p><img src="https://s2.loli.net/2024/06/14/j6CY4XP9sJzva3V.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/j6CY4XP9sJzva3V.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们可以得到最初始的密钥</p><p><img src="https://s2.loli.net/2024/06/14/qnidhFJLwcj6oMI.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/qnidhFJLwcj6oMI.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>得到密钥是<strong>QWB2023HappyGame</strong></p><p>然后我们解密AES</p><p><img src="https://s2.loli.net/2024/06/14/Jxh9sDmOHPfonFK.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/Jxh9sDmOHPfonFK.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们往下面分析，我们发现它经过字符串对比之后还有RC4加密，但是RC4同时也可以解密，然后我们可以先把License.dat给解密一下</p><p><img src="https://s2.loli.net/2024/06/14/kvzrtJQWZXDSaL2.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/kvzrtJQWZXDSaL2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line">key = <span class="string">b&quot;WelcomeToQWB2023&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;License.dat&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line">rc4 = ARC4.new(key)</span><br><span class="line">data = rc4.decrypt(data)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;new.dat&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data)</span><br></pre></td></tr></table></figure><p>我们把新生成的new.dat拖到010eidtor里面看一下</p><p><img src="https://s2.loli.net/2024/06/14/MfnR3e81oZh4zNI.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/MfnR3e81oZh4zNI.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>我们发现他调用了FFF方法</p><p>我们回到dnspy看FFF方法</p><p>发现是tea加密，然后加密的密钥就是我们的输入</p><p><img src="https://s2.loli.net/2024/06/14/u4ktHbcm8DLBJIw.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/u4ktHbcm8DLBJIw.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们还发现后面有比较的地方，密文在v28里面</p><p><img src="https://s2.loli.net/2024/06/14/wQtgvLhMTlkm97F.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/wQtgvLhMTlkm97F.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>但是由于程序经过了优化，所以我们在dnspy中无法看到v28的变量</p><p>我们需要去到ILspy里面查看v28，这里注意一定要用原程序进行查看</p><p>进行tea解密</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt</span><span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* <span class="built_in">array</span>)</span> &#123;</span><br><span class="line"><span class="type">uint32_t</span> num5 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">num5 += <span class="number">3735928559u</span>;</span><br><span class="line">&#125;</span><br><span class="line">num5 = num5 &amp; <span class="number">0xffffffff</span>;</span><br><span class="line"><span class="type">uint32_t</span> num3 = v[<span class="number">0</span>], num4 = v[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span>; ++j)</span><br><span class="line">&#123;</span><br><span class="line">num4 -= ((num3 &lt;&lt; <span class="number">4</span>) + <span class="built_in">array</span>[<span class="number">2</span>]) ^ (num3 + num5) ^ ((num3 &gt;&gt; <span class="number">5</span>) + <span class="built_in">array</span>[<span class="number">3</span>]);</span><br><span class="line">num3 -= ((num4 &lt;&lt; <span class="number">4</span>) + <span class="built_in">array</span>[<span class="number">0</span>]) ^ (num4 + num5) ^ ((num4 &gt;&gt; <span class="number">5</span>) + <span class="built_in">array</span>[<span class="number">1</span>]);</span><br><span class="line">num5 -= <span class="number">3735928559u</span>;</span><br><span class="line">&#125;</span><br><span class="line">v[<span class="number">0</span>] = num3; v[<span class="number">1</span>] = num4;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> key[<span class="number">17</span>] = <span class="string">&quot;WelcomeToQWB2023&quot;</span>;</span><br><span class="line"><span class="type">uint8_t</span> enc[<span class="number">24</span>] = &#123; <span class="number">69</span>, <span class="number">182</span>, <span class="number">171</span>, <span class="number">33</span>, <span class="number">121</span>, <span class="number">107</span>, <span class="number">254</span>, <span class="number">150</span>, <span class="number">92</span>, <span class="number">29</span>,</span><br><span class="line"><span class="number">4</span>, <span class="number">178</span>, <span class="number">138</span>, <span class="number">166</span>, <span class="number">184</span>, <span class="number">106</span>, <span class="number">53</span>, <span class="number">241</span>, <span class="number">42</span>, <span class="number">191</span>,</span><br><span class="line"><span class="number">23</span>, <span class="number">211</span>, <span class="number">3</span>, <span class="number">107</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i += <span class="number">8</span>)</span><br><span class="line">&#123;</span><br><span class="line">decrypt((<span class="type">uint32_t</span>*)(enc + i), (<span class="type">uint32_t</span>*)key);</span><br><span class="line">&#125;</span><br><span class="line">enc[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, enc);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/06/14/zGudTZk7vnjlh8V.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/zGudTZk7vnjlh8V.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们还要去改一下程序</p><p><img src="https://s2.loli.net/2024/06/14/t81fme4IphqaMnw.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/t81fme4IphqaMnw.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们开始调试</p><p><img src="https://s2.loli.net/2024/06/14/1TMAYPiKUVOyQuF.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/1TMAYPiKUVOyQuF.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>发现有异常，是我们的dat文件出现了问题</p><p>这里贴一下出题人的样例代码</p><p><a href="https://bbs.kanxue.com/thread-279971.htm">https://bbs.kanxue.com/thread-279971.htm</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">TypeConfuseDelegate</span><span class="params">(Comparison&lt;<span class="built_in">string</span>&gt; comp)</span></span><br><span class="line">&#123;</span><br><span class="line">    FieldInfo fi = typeof(MulticastDelegate).GetField(<span class="string">&quot;_invocationList&quot;</span>,</span><br><span class="line">            BindingFlags.NonPublic | BindingFlags.Instance);</span><br><span class="line">    object[] invoke_list = comp.GetInvocationList();</span><br><span class="line">    <span class="comment">// Modify the invocation list to add Process::Start(string, string)</span></span><br><span class="line">    invoke_list[<span class="number">1</span>] = new Func&lt;<span class="built_in">string</span>, <span class="built_in">string</span>, <span class="type">int</span>&gt;(FFF);</span><br><span class="line">    fi.SetValue(comp, invoke_list);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span>&#123;</span><br><span class="line">    <span class="comment">// Create a simple multicast delegate.</span></span><br><span class="line">    Delegate d = new Comparison&lt;<span class="built_in">string</span>&gt;(String.Compare);</span><br><span class="line">    Comparison&lt;<span class="built_in">string</span>&gt; c = (Comparison&lt;<span class="built_in">string</span>&gt;)MulticastDelegate.Combine(d, d);</span><br><span class="line">    <span class="comment">// Create set with original comparer.</span></span><br><span class="line">    IComparer&lt;<span class="built_in">string</span>&gt; comp = Comparer&lt;<span class="built_in">string</span>&gt;.Create(c);</span><br><span class="line"> </span><br><span class="line">    SortedSet&lt;<span class="built_in">string</span>&gt; mysl = new SortedSet&lt;<span class="built_in">string</span>&gt;(comp);</span><br><span class="line">    mysl.Add(<span class="string">&quot;dotN3t_Is_1nt3r3sting&quot;</span>);</span><br><span class="line">    mysl.Add(<span class="string">&quot;WelcomeToQWB2023&quot;</span>)&#125;</span><br><span class="line">     </span><br><span class="line">    TypeConfuseDelegate(c);</span><br><span class="line"> </span><br><span class="line">    BinaryFormatter fmt = new BinaryFormatter();</span><br><span class="line">    BinaryFormatter fmt2 = new BinaryFormatter();</span><br><span class="line">    MemoryStream stm = new MemoryStream();</span><br><span class="line">    fmt.Serialize(stm, mysl);</span><br><span class="line"> </span><br><span class="line">    using (FileStream fs = new FileStream(<span class="string">&quot;License.dat&quot;</span>, FileMode.Create, FileAccess.Write))</span><br><span class="line">    &#123;</span><br><span class="line">        stm.Position = <span class="number">0</span>;</span><br><span class="line">        stm.CopyTo(fs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2024/06/14/zlnxoLtWwf68ZTE.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/zlnxoLtWwf68ZTE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后可以找到异常的位置</p><p><img src="https://s2.loli.net/2024/06/14/e7Y3JoD1BfpzTGS.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/e7Y3JoD1BfpzTGS.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后06，06 ， 06，07是len</p><p><img src="https://s2.loli.net/2024/06/14/IghFqA3ROmwG6tN.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/IghFqA3ROmwG6tN.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>其实FFF函数这里也有提示，FFF的两个参数是string类型的，然后我们就是把刚才的两个的string，填进去</p><p><img src="https://s2.loli.net/2024/06/14/Mw4AoQ6RjIVlLBk.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/Mw4AoQ6RjIVlLBk.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后我们直接运行就行了</p><p><img src="https://s2.loli.net/2024/06/14/EtqmjZzBI1FUNoV.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/EtqmjZzBI1FUNoV.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://bbs.kanxue.com/thread-279971.htm">https://bbs.kanxue.com/thread-279971.htm</a></p><p><a href="http://91fans.com.cn/post/ilikeaestwo/">http://91fans.com.cn/post/ilikeaestwo/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;以下为题目链接，供各位师傅下载练习&lt;br&gt;&lt;a href=&quot;https://wwb.lanzout.com/iovY721r8pva&quot;&gt;https://wwb.lanzout.com/iovY721r8pva&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;涉及考点: 白盒AES,.net程序的序列</summary>
      
    
    
    
    <category term="wp" scheme="https://5m10v3.top/categories/wp/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>白盒AES算法学习</title>
    <link href="https://5m10v3.top/2024/06/11/%E7%99%BD%E7%9B%92AES%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/"/>
    <id>https://5m10v3.top/2024/06/11/%E7%99%BD%E7%9B%92AES%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/</id>
    <published>2024-06-10T16:00:00.000Z</published>
    <updated>2024-06-19T07:52:45.867Z</updated>
    
    <content type="html"><![CDATA[<p>首先在这里非常感谢白龙大佬的白盒密码系列，让我对于白盒AES有了更深刻的认识，在这里给白龙大佬宣传一波</p><p><img src="https://s2.loli.net/2024/06/14/CYim2DVxKAz5r8S.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/14/CYim2DVxKAz5r8S.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><a href="https://public.zsxq.com/groups/28855842512881.html">https://public.zsxq.com/groups/28855842512881.html</a></p><p>这里我先贴一张AES加密的流程图</p><p><img src="https://s2.loli.net/2024/06/19/r1GT5PypmdO7zZA.png" class="lazyload" data-srcset="https://s2.loli.net/2024/06/19/r1GT5PypmdO7zZA.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;首先在这里非常感谢白龙大佬的白盒密码系列，让我对于白盒AES有了更深刻的认识，在这里给白龙大佬宣传一波&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2024/06/14/CYim2DVxKAz5r8S.png&quot; class=&quot;lazyload&quot;</summary>
      
    
    
    
    <category term="CTF" scheme="https://5m10v3.top/categories/CTF/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>RCTF-Noval_cpython复现及思考</title>
    <link href="https://5m10v3.top/2024/06/08/RCTF-Noval_cython%E5%A4%8D%E7%8E%B0%E5%8F%8A%E6%80%9D%E8%80%83/"/>
    <id>https://5m10v3.top/2024/06/08/RCTF-Noval_cython%E5%A4%8D%E7%8E%B0%E5%8F%8A%E6%80%9D%E8%80%83/</id>
    <published>2024-06-07T16:00:00.000Z</published>
    <updated>2024-06-10T01:57:04.204Z</updated>
    
    <content type="html"><![CDATA[<p>以下为附件链接，供各位师傅下载练习<br><a href="https://wwb.lanzout.com/i7mkm21aeegd">https://wwb.lanzout.com/i7mkm21aeegd</a></p><p>趁热打铁，前一阵子打国赛遇到了cpython的题，但是国赛那道cpython和这个相比简直就是”关公面前耍大刀“。</p><p>在此也非常感谢<strong>z221x</strong>师傅的博客</p><p><a href="http://z221x.cc/index.php/2024/05/29/rctf%e9%80%86%e5%90%91%e5%a4%8d%e7%8e%b0/">http://z221x.cc/index.php/2024/05/29/rctf%e9%80%86%e5%90%91%e5%a4%8d%e7%8e%b0/</a></p><p>为我提供了一些很好的思路</p><h2 id="Noval-cpython"><a href="#Noval-cpython" class="headerlink" title="Noval_cpython"></a>Noval_cpython</h2><p>我们可以先用help函数看一下有没有什么比较有用的信息</p><p>这里注意一下，它是用python3.10直接编译的，我调了很多遍，发现如果跟版本不一样的话会导致导入不了这个模块</p><p>接下来我们用help查看一下，可以得到很多有用的信息</p><p><img src="/../image/734.png" class="lazyload" data-srcset="/../image/734.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="734"></p><p>我们注意到了check和encrypt函数，在main.py中它使用的就是check()函数</p><p><img src="/../image/735.png" class="lazyload" data-srcset="/../image/735.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="735"></p><p>然后我们可以注意到DATA那里有很多可疑的数据，我们先继续进行分析</p><p>首先第一步还是找到模块处理的地方</p><p><img src="/../image/736.png" class="lazyload" data-srcset="/../image/736.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="736"></p><p>我们要从check_secret模块开始看</p><p><img src="/../image/737.png" class="lazyload" data-srcset="/../image/737.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="737"></p><p>我们发现里面有很多对象，这让我想到之前学习驱动的时候，“驱动之内一切皆对象”，其实cpython在创建模块也需要很多对象</p><p><img src="/../image/738.png" class="lazyload" data-srcset="/../image/738.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="738"></p><p><img src="/../image/739.png" class="lazyload" data-srcset="/../image/739.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="739"></p><p>我们发现这里创建了很多对象，这里的操作相当于</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arr=[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>]</span><br></pre></td></tr></table></figure><p>这里是密文的初始化</p><p><img src="/../image/740.png" class="lazyload" data-srcset="/../image/740.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="740"></p><p>但是我们发现这个跟上面的help的情况不太一样，没有关系我们继续往下面看</p><p>这里重新打包了很多东西</p><p><img src="/../image/741.png" class="lazyload" data-srcset="/../image/741.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="741"></p><p>但是我们在伪代码层面看不出来它的逻辑</p><p>汇编层面:</p><p><img src="/../image/742.png" class="lazyload" data-srcset="/../image/742.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="742"></p><p>我们发现它是定义algorithm1，algorithm2，algorithm3…….这些函数</p><p><img src="/../image/743.png" class="lazyload" data-srcset="/../image/743.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="743"></p><p>然后最后的时候还有个加密函数，这个加密函数有七个参数，我们发现有一个delta的参数，在这里先猜测它可能是tea加密</p><p>继续往下面分析</p><p>这里为定义一个xixi变量</p><p><img src="/../image/744.png" class="lazyload" data-srcset="/../image/744.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="744"></p><p>这里我们发现定义了一个sbox变量</p><p><img src="/../image/745.png" class="lazyload" data-srcset="/../image/745.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="745"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#就是这样的作用</span></span><br><span class="line">s_box=[<span class="number">12</span>,<span class="number">17</span>,<span class="number">10</span>,<span class="number">6</span>,<span class="number">5</span>,<span class="number">27</span>,<span class="number">31</span>,<span class="number">15</span>,<span class="number">11</span>,<span class="number">8</span>,<span class="number">13</span>,<span class="number">21</span>,<span class="number">24</span>,<span class="number">1</span>,<span class="number">26</span>,<span class="number">22</span>,<span class="number">9</span>,<span class="number">16</span>,<span class="number">18</span>,<span class="number">25</span>,<span class="number">29</span>,<span class="number">19</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">7</span>,<span class="number">14</span>,<span class="number">30</span>,<span class="number">4</span>,<span class="number">23</span>,<span class="number">2</span>,<span class="number">28</span>,<span class="number">20</span>]</span><br></pre></td></tr></table></figure><p>这里定义haha这个变量</p><p><img src="/../image/746.png" class="lazyload" data-srcset="/../image/746.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="746"></p><p>再往下面就是定义了打包的函数模块</p><p>这里就是真正定义密文的地方</p><p><img src="/../image/747.png" class="lazyload" data-srcset="/../image/747.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="747"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">enc=[<span class="number">1386864498</span>,<span class="number">2877138732</span>,<span class="number">1628978326</span>,<span class="number">881564191</span>,<span class="number">1437614165</span>,<span class="number">4227562200</span>,<span class="number">1606883458</span>,<span class="number">3679355295</span>]</span><br></pre></td></tr></table></figure><p><img src="/../image/748.png" class="lazyload" data-srcset="/../image/748.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="748"></p><p><img src="/../image/749.png" class="lazyload" data-srcset="/../image/749.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="749"></p><p><img src="/../image/750.png" class="lazyload" data-srcset="/../image/750.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="750"></p><p><img src="/../image/751.png" class="lazyload" data-srcset="/../image/751.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="751"></p><p><img src="/../image/752.png" class="lazyload" data-srcset="/../image/752.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="752"></p><p><img src="/../image/753.png" class="lazyload" data-srcset="/../image/753.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="753"></p><p><img src="/../image/754.png" class="lazyload" data-srcset="/../image/754.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="754"></p><p><img src="/../image/755.png" class="lazyload" data-srcset="/../image/755.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="755"></p><p>总结一下上面八个函数以及前面打包函数的时候的两个参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">algorithm1   --------&gt;  add</span></span><br><span class="line"><span class="string">algorithm2   --------&gt;  sub   </span></span><br><span class="line"><span class="string">algorithm3   --------&gt;  mul</span></span><br><span class="line"><span class="string">algorithm4   --------&gt;  div</span></span><br><span class="line"><span class="string">algorithm5   --------&gt;  mod</span></span><br><span class="line"><span class="string">algorithm6   --------&gt;  rsl</span></span><br><span class="line"><span class="string">algorithm7   --------&gt;  rsr</span></span><br><span class="line"><span class="string">algorithm8   --------&gt;  xor</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algorithm1</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">return</span> a+b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algorithm2</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">return</span> a-b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algorithm3</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">return</span> a*b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algorithm4</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">return</span> a/b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algorithm5</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">return</span> a%b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algorithm6</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">return</span> a&lt;&lt;b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">algorithm7</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">return</span> a^b</span><br></pre></td></tr></table></figure><p>这里定义一个map函数</p><p><img src="/../image/766.png" class="lazyload" data-srcset="/../image/766.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="766"></p><p>后面就是定义encrypt函数，struct函数和check函数</p><p><img src="/../image/767.png" class="lazyload" data-srcset="/../image/767.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="767"></p><p>至此我们对于check_secret这个模块分析完了，这个模块全都是初始化的一些东西，然而我们在main.py调用的是check函数，接下来我们分析check函数</p><p>我们从上往下进行分析</p><p>发现这里调用了range函数</p><p><img src="/../image/769.png" class="lazyload" data-srcset="/../image/769.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="769"></p><p>然后这里调用了s_box</p><p><img src="/../image/770.png" class="lazyload" data-srcset="/../image/770.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="770"></p><p>梳理一下逻辑</p><p>实现了一个替换的功能</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">s_box,your_input</span>):</span><br><span class="line">    change_input=[<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(your_input)):</span><br><span class="line">        chage_input[i]=your_input[s_box[i]]</span><br></pre></td></tr></table></figure><p>下面实现了一个struct函数</p><p><img src="/../image/771.png" class="lazyload" data-srcset="/../image/771.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="771"></p><p><img src="/../image/772.png" class="lazyload" data-srcset="/../image/772.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="772"></p><p><img src="/../image/773.png" class="lazyload" data-srcset="/../image/773.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="773"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#实现以下这个操作</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(change_input)\\<span class="number">4</span>)</span><br><span class="line">     enc[i]=struct.unpack(<span class="string">&#x27;&lt;I&#x27;</span>,change[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#这个操作是为了生成32位的结果</span></span><br></pre></td></tr></table></figure><p>然后下面开始加密</p><p><img src="/../image/774.png" class="lazyload" data-srcset="/../image/774.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="774"></p><p>发现它还调用了下面的xixi，再往下分析</p><p>这里有个+2操作</p><p><img src="/../image/775.png" class="lazyload" data-srcset="/../image/775.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="775"></p><p>后面又调用了一次加密函数，但是调用的是haha</p><p><img src="/../image/776.png" class="lazyload" data-srcset="/../image/776.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="776"></p><p>然后后面还有一个+2操作，但是到这里我们还无法确认它真正的加密逻辑是什么，然后我们去看encrypt函数</p><p>真正的加密在_pyx_pf_12check_secret_16encrypt里面</p><p>现在开始才是真正的逆向🈚，一共有5000多行，逆呗谁能逆过你啊</p><p>我们可以看到光定义变量都有500多行了</p><p><img src="/../image/777.png" class="lazyload" data-srcset="/../image/777.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="777"></p><p>我们发现这个加密函数有两个参数</p><p><img src="/../image/778.png" class="lazyload" data-srcset="/../image/778.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="778"></p><p>其实我们还可以大胆写一下那个加密的逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(enc),<span class="number">2</span>):</span><br><span class="line">    encrypt(enc[i:i+<span class="number">2</span>],xixi)</span><br><span class="line">    encrypt(enc[i:i+<span class="number">2</span>],haha)</span><br></pre></td></tr></table></figure><p>看起来很像tea加密</p><p>这里定义了一个uint32的变量</p><p><img src="/../image/779.png" class="lazyload" data-srcset="/../image/779.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="779"></p><p>从上往下分析，我们发现还定义了另一个uint32的变量</p><p>然后我们有注意到了一个变量</p><p><img src="/../image/780.png" class="lazyload" data-srcset="/../image/780.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="780"></p><p>它只有两处引用，可以猜测一下它经过了32次循环‘</p><p><img src="/../image/781.png" class="lazyload" data-srcset="/../image/781.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="781"></p><p><img src="/../image/782.png" class="lazyload" data-srcset="/../image/782.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="782"></p><p><img src="/../image/783.png" class="lazyload" data-srcset="/../image/783.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="783"></p><p><img src="/../image/784.png" class="lazyload" data-srcset="/../image/784.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="784"></p><p>……………………..后面的图很多，但是我们发现它经历了好多次重复的操作，然后还调用了大量的map</p><p>梳理一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>(add，<span class="built_in">map</span>(xor，<span class="built_in">map</span>(xor，<span class="built_in">map</span>(add，<span class="built_in">map</span>(rsl <span class="number">4</span>，<span class="built_in">map</span>(add，<span class="built_in">map</span>(rsr <span class="number">5</span>，<span class="built_in">map</span>（add</span><br><span class="line"></span><br><span class="line"><span class="built_in">map</span>(add <span class="number">0x12345678</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">map</span>(add，<span class="built_in">map</span>(xor，<span class="built_in">map</span>(xor，<span class="built_in">map</span>(add，<span class="built_in">map</span>(rsl <span class="number">4</span>，<span class="built_in">map</span>(add，<span class="built_in">map</span>(rsr <span class="number">5</span>，<span class="built_in">map</span>(add</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">map=&#123;</span></span><br><span class="line"><span class="string">&#x27;add&#x27;:&lt;built-in function algorithm1&gt;,</span></span><br><span class="line"><span class="string">&#x27;sub&#x27;:&lt;built-in function algorithm2&gt;,  </span></span><br><span class="line"><span class="string">&#x27;mul&#x27;:&lt;built-in function algorithm3&gt;,</span></span><br><span class="line"><span class="string">&#x27;div&#x27;:&lt;built-in function algorithm4&gt;,</span></span><br><span class="line"><span class="string">&#x27;mod&#x27;:&lt;built-in function algorithm5&gt;,</span></span><br><span class="line"><span class="string">&#x27;rsl&#x27;:&lt;built-in function algorithm6&gt;,</span></span><br><span class="line"><span class="string">&#x27;rsr&#x27;:&lt;built-in function algorithm7&gt;,</span></span><br><span class="line"><span class="string">&#x27;xor&#x27;:&lt;built-in function algorithm8&gt;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>到这里我们可以确定这就是个tea加密</p><p>然后Arr3stY0u战队的师傅们提供了另一个思路</p><p><a href="https://mp.weixin.qq.com/s/IwKxtqDd-5v0xhg9UzKe-g">https://mp.weixin.qq.com/s/IwKxtqDd-5v0xhg9UzKe-g</a></p><p>因为这个动态链接库是已经打包好的，所以我们可以直接调用里面的函数然后，再打印出来他们的操作(相当于就是hook操作)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> check_secret</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_add</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> + 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_sud</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> - 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mul</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> * 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_div</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> / 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mod</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> % 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_rsl</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> &lt;&lt; 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_rsr</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> &gt;&gt; 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_xor</span>(<span class="params">a,b</span>):</span><br><span class="line">    res=check_secret.algorithm1(a,b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;0x<span class="subst">&#123;res:08x&#125;</span> = 0x<span class="subst">&#123;a:08x&#125;</span> ^ 0x<span class="subst">&#123;b:08x&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;add&#x27;</span>] = hook_add</span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;sub&#x27;</span>] = hook_sub</span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;mul&#x27;</span>] = hook_mul</span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;div&#x27;</span>] = hook_div</span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;mod&#x27;</span>] = hook_mod</span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;rsl&#x27;</span>] = hook_rsl</span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;rsr&#x27;</span>] = hook_rsr</span><br><span class="line">check_secret.<span class="built_in">map</span>[<span class="string">&#x27;xor&#x27;</span>] = hook_xor</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(check_secret.encrypt([<span class="number">0x11111111</span>,<span class="number">0x2222222</span>]),check_secret.xixi)</span><br></pre></td></tr></table></figure><p>然后我们就可以得到加密的过程</p><p><img src="/../image/785.png" class="lazyload" data-srcset="/../image/785.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="785"></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">decipher</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num_rounds, <span class="type">uint32_t</span> v[<span class="number">2</span>], <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">    <span class="type">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>], delta = <span class="number">0x12345678</span>, sum = delta * num_rounds;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_rounds; i++) &#123;</span><br><span class="line">        v1 -= ((v0 &lt;&lt; <span class="number">4</span>) + key[<span class="number">2</span>]) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="number">5</span>) + key[<span class="number">3</span>]);</span><br><span class="line">        sum -= delta;</span><br><span class="line">        v0 -= ((v1 &lt;&lt; <span class="number">4</span>) + key[<span class="number">0</span>]) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="number">5</span>) + key[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    v[<span class="number">0</span>] = v0; v[<span class="number">1</span>] = v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> xixi[] = &#123; <span class="number">3540658286</span>,<span class="number">3391361277</span>,<span class="number">1321275334</span>,<span class="number">3918321625</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> haha[] = &#123; <span class="number">1272471749</span>,<span class="number">2262110437</span>,<span class="number">697301573</span>,<span class="number">1088211398</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> enc[] = &#123; <span class="number">1386864498</span>,<span class="number">2877138732</span>,<span class="number">1628978326</span>,<span class="number">881564191</span>,<span class="number">1437614165</span>,<span class="number">4227562200</span>,<span class="number">1606883458</span>,<span class="number">3679355295</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i += <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">decipher(<span class="number">32</span>,enc + i, haha);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i += <span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line">decipher(<span class="number">32</span>,enc + i, xixi);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> sbox[] = &#123; <span class="number">12</span>, <span class="number">17</span>, <span class="number">10</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">27</span>, <span class="number">31</span>, <span class="number">15</span>, <span class="number">11</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">21</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">26</span>, <span class="number">22</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">18</span>,</span><br><span class="line"><span class="number">25</span>, <span class="number">29</span>, <span class="number">19</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">30</span>, <span class="number">4</span>, <span class="number">23</span>, <span class="number">2</span>, <span class="number">28</span>, <span class="number">20</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (sbox[j] == i)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, *((<span class="type">unsigned</span> <span class="type">char</span>*)enc + j));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;以下为附件链接，供各位师傅下载练习&lt;br&gt;&lt;a href=&quot;https://wwb.lanzout.com/i7mkm21aeegd&quot;&gt;https://wwb.lanzout.com/i7mkm21aeegd&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;趁热打铁，前一阵子打国赛遇到了cpytho</summary>
      
    
    
    
    <category term="CTF" scheme="https://5m10v3.top/categories/CTF/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>关于爆破迷宫路径的一系列思考</title>
    <link href="https://5m10v3.top/2024/06/07/%E5%85%B3%E4%BA%8E%E7%88%86%E7%A0%B4%E8%BF%B7%E5%AE%AB%E8%B7%AF%E5%BE%84%E7%9A%84%E4%B8%80%E7%B3%BB%E5%88%97%E6%80%9D%E8%80%83/"/>
    <id>https://5m10v3.top/2024/06/07/%E5%85%B3%E4%BA%8E%E7%88%86%E7%A0%B4%E8%BF%B7%E5%AE%AB%E8%B7%AF%E5%BE%84%E7%9A%84%E4%B8%80%E7%B3%BB%E5%88%97%E6%80%9D%E8%80%83/</id>
    <published>2024-06-06T16:00:00.000Z</published>
    <updated>2024-06-09T09:10:00.642Z</updated>
    
    <content type="html"><![CDATA[<p>题目链接在此，供各位师傅下载练习</p><p><a href="https://wwb.lanzout.com/iWuvC216lmqj">https://wwb.lanzout.com/iWuvC216lmqj</a></p><p>前几天学长给了一道maze的题，动态调试过程可谓非常艰难(对我现在的水平而言)，于是学长提供了一种用subprocess的方法</p><h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p><img src="/../image/726.png" class="lazyload" data-srcset="/../image/726.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="726"></p><p>首先通过字符串定位到主函数那里，我们发现cmp那里其实是一个长度校验，判断路径的长度是不是为140</p><p><img src="/../image/727.png" class="lazyload" data-srcset="/../image/727.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="727"></p><p>这里为判断路径方向</p><p><img src="/../image/728.png" class="lazyload" data-srcset="/../image/728.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="728"></p><p>中间过程太复杂，我们直接跳到后面，我们发现他判断所处位置是不是为0，还有判断最后到达位置对不对的</p><p>经过这个分析我们并不知道迷宫在哪，因此我们才要尝试爆破的方法。</p><h2 id="爆破处理"><a href="#爆破处理" class="headerlink" title="爆破处理"></a>爆破处理</h2><p>首先第一步，我们要把长度校验给patch掉</p><p><img src="/../image/729.png" class="lazyload" data-srcset="/../image/729.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="729"></p><p>重点的patch在后面，我们为了一步一步进行爆破，我们要对每一步进行爆破</p><p>但是有一个问题，后面不管走不走对都会输出</p><p>我们可以先写一个简单的试验一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">printable=[<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;d&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(printable)):</span><br><span class="line">    sh=subprocess.Popen(<span class="string">&quot;./mapmap&quot;</span>, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stdin=subprocess.PIPE)</span><br><span class="line">    sh.stdin.write((printable[i]+<span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">    sh.stdin.flush()</span><br><span class="line">    output ,_ =sh.communicate()</span><br><span class="line">    <span class="built_in">print</span>(output)</span><br></pre></td></tr></table></figure><p><img src="/../image/730.png" class="lazyload" data-srcset="/../image/730.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="730"></p><p>我们发现根本无法判断是不是走对了，这个时候我们再patch一下</p><p><img src="/../image/728.png" class="lazyload" data-srcset="/../image/728.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="728"></p><p><img src="/../image/731.png" class="lazyload" data-srcset="/../image/731.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="731"></p><p>把下面那个指向wrong的地址改为指向’   what()’的地址</p><p>我们这个时候可以再看一下</p><p><img src="/../image/732.png" class="lazyload" data-srcset="/../image/732.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="732"></p><p>发现有不一样的回显了，我们根据这个可以写一个脚本，但是这里有一个问题，它在程序里面每走一步不会把走过的给标记，所以我们得自己标记一下，由于没有写这个标记，导致脚本跑了好久也没跑出来。</p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dfs</span>(<span class="params">path, n, x_location, y_location, count, try_direction, visited_paths, coordinates</span>):</span><br><span class="line">    <span class="keyword">if</span> n &lt; count:</span><br><span class="line">        <span class="keyword">for</span> direction <span class="keyword">in</span> try_direction:</span><br><span class="line">            process = subprocess.Popen(<span class="string">&quot;./mapmap&quot;</span>, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stdin=subprocess.PIPE)</span><br><span class="line">            next_path = path + direction</span><br><span class="line">            process.stdin.write((next_path + <span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">            process.stdin.flush()</span><br><span class="line">            output, _ = process.communicate()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&#x27;wrong\n&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> output:</span><br><span class="line">                new_x_location, new_y_location = x_location, y_location</span><br><span class="line">                <span class="keyword">if</span> direction == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">                    new_x_location += <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> direction == <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">                    new_x_location -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> direction == <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">                    new_y_location -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> direction == <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">                    new_y_location += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> (new_x_location, new_y_location) <span class="keyword">not</span> <span class="keyword">in</span> coordinates:</span><br><span class="line">                    <span class="built_in">print</span>(path)</span><br><span class="line">                    coordinates[(new_x_location, new_y_location)] = next_path</span><br><span class="line">                    dfs(next_path, <span class="built_in">len</span>(next_path), new_x_location, new_y_location, count, try_direction, visited_paths, coordinates)</span><br><span class="line">    <span class="keyword">elif</span> n == count:</span><br><span class="line">            visited_paths.append(path)</span><br><span class="line">            coordinates[(x_location, y_location)] = path</span><br><span class="line"></span><br><span class="line"><span class="comment"># DFS start</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start_path = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    try_direction = [<span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">    count = <span class="number">140</span> </span><br><span class="line">    visited_paths = []</span><br><span class="line">    coordinates = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    x_location = <span class="number">0</span></span><br><span class="line">    y_location = <span class="number">0</span></span><br><span class="line">    coordinates[(x_location, y_location)] = start_path</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nVisit paths:&quot;</span>)</span><br><span class="line">    dfs(start_path, <span class="built_in">len</span>(start_path), x_location, y_location, count, try_direction, visited_paths, coordinates)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nFinal paths:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> visited_paths:</span><br><span class="line">        process = subprocess.Popen(<span class="string">&quot;./mapmap&quot;</span>, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stdin=subprocess.PIPE)</span><br><span class="line">        process.stdin.write((path + <span class="string">&#x27;\n&#x27;</span>).encode())</span><br><span class="line">        process.stdin.flush()</span><br><span class="line">        output, _ = process.communicate()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;flag&#123;md5(your input)&#125;\n&#x27;</span> <span class="keyword">in</span> output:</span><br><span class="line">            <span class="built_in">print</span>(path)</span><br></pre></td></tr></table></figure><p><img src="/../image/733.png" class="lazyload" data-srcset="/../image/733.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="733"></p><p>差不多二十秒的时间跑出来</p><p>我自己的虚拟环境是kali 2023.3 内存 4G 处理器2x2</p><p>如果师傅们有更好的思路欢迎来交流😁😁😁😁</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://docs.python.org/zh-cn/3/library/subprocess.html#using-the-subprocess-module">https://docs.python.org/zh-cn/3/library/subprocess.html#using-the-subprocess-module</a></p><p><a href="https://www.cnblogs.com/lordtianqiyi/articles/16588649.html">https://www.cnblogs.com/lordtianqiyi/articles/16588649.html</a></p><p><a href="https://bbs.kanxue.com/thread-281796.html">https://bbs.kanxue.com/thread-281796.html</a></p><p><a href="http://z221x.cc/index.php/2024/01/06/nctf-ezvm%e6%8f%92%e6%a1%a9%e7%88%86%e7%a0%b4%e7%9a%84%e5%a4%8d%e7%8e%b0/">http://z221x.cc/index.php/2024/01/06/nctf-ezvm%e6%8f%92%e6%a1%a9%e7%88%86%e7%a0%b4%e7%9a%84%e5%a4%8d%e7%8e%b0/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;题目链接在此，供各位师傅下载练习&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://wwb.lanzout.com/iWuvC216lmqj&quot;&gt;https://wwb.lanzout.com/iWuvC216lmqj&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;前几天学长给了一道maze的题，动态</summary>
      
    
    
    
    <category term="CTF" scheme="https://5m10v3.top/categories/CTF/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>日记(25)</title>
    <link href="https://5m10v3.top/2024/06/04/%E6%97%A5%E8%AE%B0(25)/"/>
    <id>https://5m10v3.top/2024/06/04/%E6%97%A5%E8%AE%B0(25)/</id>
    <published>2024-06-03T16:00:00.000Z</published>
    <updated>2024-06-09T09:14:14.878Z</updated>
    
    <content type="html"><![CDATA[<p>最近在研究一些能够插桩爆破的方法，目前还在总结，可能要过几天才能彻底总结出来。<br>正在努力赶制</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;最近在研究一些能够插桩爆破的方法，目前还在总结，可能要过几天才能彻底总结出来。&lt;br&gt;正在努力赶制&lt;/p&gt;
</summary>
      
    
    
    
    <category term="日记" scheme="https://5m10v3.top/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>日记(24)</title>
    <link href="https://5m10v3.top/2024/06/01/%E6%97%A5%E8%AE%B0(24)/"/>
    <id>https://5m10v3.top/2024/06/01/%E6%97%A5%E8%AE%B0(24)/</id>
    <published>2024-05-31T16:00:00.000Z</published>
    <updated>2024-06-09T09:14:06.765Z</updated>
    
    <content type="html"><![CDATA[<p>上一次写日记已经是半个多月前了，这半个多月太忙了，还出去了一周的时间。<br>回来这几天勉强把状态调整了回来，今天打了一个比赛，做了一个迷宫题，但不是传统的那种迷宫题，这个比赛的时间也短，最后就差一分钟！一分钟！，就能把这个flag给交上去了😔😔😔</p><p>总的来说自己对这类题的掌握程度还是不足，今天学长又给了一道迷宫的题，比较难调，是一个类似树状的</p><p>近期规划:</p><ul><li>多复现一些大比赛的题目</li><li>同时基本功也不能落下</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;上一次写日记已经是半个多月前了，这半个多月太忙了，还出去了一周的时间。&lt;br&gt;回来这几天勉强把状态调整了回来，今天打了一个比赛，做了一个迷宫题，但不是传统的那种迷宫题，这个比赛的时间也短，最后就差一分钟！一分钟！，就能把这个flag给交上去了😔😔😔&lt;/p&gt;
&lt;p&gt;总的</summary>
      
    
    
    
    <category term="日记" scheme="https://5m10v3.top/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>逆向练习(二)</title>
    <link href="https://5m10v3.top/2024/06/01/%E9%80%86%E5%90%91%E7%BB%83%E4%B9%A0(%E4%BA%8C)/"/>
    <id>https://5m10v3.top/2024/06/01/%E9%80%86%E5%90%91%E7%BB%83%E4%B9%A0(%E4%BA%8C)/</id>
    <published>2024-05-31T16:00:00.000Z</published>
    <updated>2024-06-09T09:10:49.082Z</updated>
    
    <content type="html"><![CDATA[<p>今日练习一题之maze</p><p>题目链接如下，供各位师傅下载</p><p><a href="https://wwb.lanzout.com/iH49D20nej0j">https://wwb.lanzout.com/iH49D20nej0j</a></p><p>直接字符串定位到main函数</p><p>反编译之后我们发现看不懂，那些走迷宫的操作我们也看不到</p><p>我们直接看它的CFG</p><p><img src="/../image/721.png" class="lazyload" data-srcset="/../image/721.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="721"></p><p>第一个call指令的这个函数为输入函数，但是每次只能输入一个字符</p><p>然后对你输入的字符处理的地方是这里</p><p><img src="/../image/722.png" class="lazyload" data-srcset="/../image/722.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="722"></p><p>第一步我们应该先找到迷宫在哪里，经过调试</p><p><img src="/../image/723.png" class="lazyload" data-srcset="/../image/723.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="723"></p><p>r13这里是我们的迷宫，由于它每次只取rsi*4地址处的，所以我们把这个给整理出来</p><p><img src="/../image/724.png" class="lazyload" data-srcset="/../image/724.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="724"></p><p>得到迷宫图之后我们就要得到它的方向指令了，由于第一个我们测出来的是<strong>2</strong>，这个<strong>2</strong>也不是没有根据的，我们回到CFG那里</p><p><img src="/../image/722.png" class="lazyload" data-srcset="/../image/722.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="722"></p><p>首先我们可以看到它将你输入的字符与0x32进行异或,然后和9进行比较，这个不重要,重要的是后面有三个cmp，这三个cmp对应不同的指令，要注意到后面还有个指令  <strong>add    rsi,rcx</strong>，而这个rsi又指向我们路径坐标对应的地址</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test eax,eax ;如果相等对应后面 rsi+=6  相当于就是往上走，然后这个可以得出来输入的结果:0x0^0x32=0x32--&gt;&#x27;2&#x27;</span><br><span class="line">cmp  eax, 6  ;如果相等对应后面 rsi-=1  相当于就是往左走，然后这个可以得出来输入的结果:0x6^0x32=0x34--&gt;&#x27;4&#x27;</span><br><span class="line">cmp  eax, 0Ah;如果相等对应后面 rsi-=6  相当于就是往上走，然后这个可以得出来输入的结果:0xA^0x32=0x38--&gt;&#x27;8&#x27; </span><br><span class="line">cmp  eax, 5Eh;如果相等对应后面 rsi+=1  相当于就是往左走，然后这个可以得出来输入的结果:0x5E^0x32=0x6c--&gt;&#x27;l&#x27;</span><br></pre></td></tr></table></figure><p>然后我们就可以得出路径</p><p><img src="/../image/725.png" class="lazyload" data-srcset="/../image/725.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="725"></p><p>得到我们的flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;今日练习一题之maze&lt;/p&gt;
&lt;p&gt;题目链接如下，供各位师傅下载&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://wwb.lanzout.com/iH49D20nej0j&quot;&gt;https://wwb.lanzout.com/iH49D20nej0j&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;直</summary>
      
    
    
    
    <category term="逆向" scheme="https://5m10v3.top/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="ctf学习" scheme="https://5m10v3.top/tags/ctf%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>2024CISCN(初赛)解题思路及复现</title>
    <link href="https://5m10v3.top/2024/05/31/2024CISCN(%E5%88%9D%E8%B5%9B)%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF%E5%8F%8A%E5%A4%8D%E7%8E%B0/"/>
    <id>https://5m10v3.top/2024/05/31/2024CISCN(%E5%88%9D%E8%B5%9B)%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF%E5%8F%8A%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-05-30T16:00:00.000Z</published>
    <updated>2024-06-09T14:07:06.451Z</updated>
    
    <content type="html"><![CDATA[<h2 id="asm-re"><a href="#asm-re" class="headerlink" title="asm_re"></a>asm_re</h2><p>直接手撕汇编</p><p><img src="/../image/688.png" class="lazyload" data-srcset="/../image/688.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="688"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#正向加密过程</span></span><br><span class="line">enc=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    enc[i]*=<span class="number">0x50</span></span><br><span class="line">    enc[i]+=<span class="number">0x14</span></span><br><span class="line">    enc[i]^=<span class="number">0x4D</span></span><br><span class="line">    enc[i]+=<span class="number">0x1E</span></span><br></pre></td></tr></table></figure><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">enc=[<span class="number">0x1FD7</span>,<span class="number">0x21B7</span>,<span class="number">0x1E47</span>,<span class="number">0x2027</span>,<span class="number">0x26E7</span>,<span class="number">0x10D7</span>,<span class="number">0x1127</span>,<span class="number">0x2007</span>,<span class="number">0x11C7</span>,<span class="number">0x1E47</span>,<span class="number">0x1017</span>,<span class="number">0x1017</span>,<span class="number">0x11F7</span>,<span class="number">0x2007</span>,<span class="number">0x1037</span>,<span class="number">0x1107</span>,<span class="number">0x1F17</span>,<span class="number">0x10D7</span>,<span class="number">0x1017</span>,<span class="number">0x1017</span>,<span class="number">0x1F67</span>,<span class="number">0x1017</span>,<span class="number">0x11C7</span>,<span class="number">0x11C7</span>,<span class="number">0x1017</span>,<span class="number">0x1FD7</span>,<span class="number">0x1F17</span>,<span class="number">0x1107</span>,<span class="number">0x0F47</span>,<span class="number">0x1127</span>,<span class="number">0x1037</span>,<span class="number">0x1E47</span>,<span class="number">0x1037</span>,<span class="number">0x1FD7</span>,<span class="number">0x1107</span>,<span class="number">0x1FD7</span>,<span class="number">0x1107</span>,<span class="number">0x2787</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    enc[i]-=<span class="number">0x1E</span></span><br><span class="line">    enc[i]^=<span class="number">0x4D</span></span><br><span class="line">    enc[i]-=<span class="number">0x14</span></span><br><span class="line">    enc[i]//=<span class="number">0x50</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(enc[i]),end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="androidso-re"><a href="#androidso-re" class="headerlink" title="androidso_re"></a>androidso_re</h2><p><img src="/../image/689.png" class="lazyload" data-srcset="/../image/689.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="689"></p><p>flag的加密在inspect这个类里面</p><p>经过了DES(CBC模式)加密+base64加密</p><p>那么我们需要得到DES加密的IV和key</p><p>在libSecret_entrance.so里面</p><p><img src="/../image/690.png" class="lazyload" data-srcset="/../image/690.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="690"></p><p>分别在getiv和getkey里面把a1的类型变一下改成<strong>JNIEnv</strong>*</p><p><img src="/../image/691.png" class="lazyload" data-srcset="/../image/691.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="691"></p><p><img src="/../image/692.png" class="lazyload" data-srcset="/../image/692.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="692"></p><p>然后我们直接利用jnitrace</p><p><img src="/../image/693.png" class="lazyload" data-srcset="/../image/693.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="693"></p><p><img src="/../image/694.png" class="lazyload" data-srcset="/../image/694.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="694"></p><p><img src="/../image/695.png" class="lazyload" data-srcset="/../image/695.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="695"></p><h2 id="whereThel1b"><a href="#whereThel1b" class="headerlink" title="whereThel1b"></a>whereThel1b</h2><p>出题人自己编写的动态链接库</p><p><img src="/../image/696.png" class="lazyload" data-srcset="/../image/696.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="696"></p><p>真正对明文进行处理的函数时whereThelib这个库里面的trytry函数</p><p>我们可以先搜索init，发现有一个PyInit_whereThel1b这个函数</p><p><img src="/../image/697.png" class="lazyload" data-srcset="/../image/697.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="697"></p><p>然后我们就可以找到初始化这些模块的地方__pyx_moduledef</p><p><img src="/../image/698.png" class="lazyload" data-srcset="/../image/698.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="698"></p><p>这里定义了一个随机数种子</p><p>然后后面又调用了whereistheflag1</p><p><img src="/../image/699.png" class="lazyload" data-srcset="/../image/699.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="699"></p><p>说明对字符的处理在whereistheflag1里面</p><p>在whereistheflag1里面先调用了一个base64，说明先进行了base64加密</p><p><img src="/../image/700.png" class="lazyload" data-srcset="/../image/700.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="700"></p><p>还是生成一个随机数，生成的范围时是**(0,len(arr))**</p><p><img src="/../image/701.png" class="lazyload" data-srcset="/../image/701.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="701"></p><p><img src="/../image/703.png" class="lazyload" data-srcset="/../image/703.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="703"></p><p>这里还调用了一下xor</p><p><img src="/../image/702.png" class="lazyload" data-srcset="/../image/702.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="702"></p><p>这里整理一下加密的逻辑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">whereistheflag1</span>(<span class="params">pla</span>):</span><br><span class="line">    <span class="comment"># 创建一个空列表</span></span><br><span class="line">    result_list = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导入模块 &#x27;base64&#x27; 或获取其全局变量</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> base64</span><br><span class="line">        b64encode_func = base64.b64encode</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">&quot;Cannot find the module &#x27;base64&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 导入模块 &#x27;random&#x27; 或获取其全局变量</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        randint_func = random.randint</span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">&quot;Cannot find the module &#x27;random&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对输入的参数进行编码处理</span></span><br><span class="line">    encoded_pla = b64encode_func(pla)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取编码后字符串的长度</span></span><br><span class="line">    length = <span class="built_in">len</span>(encoded_pla)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 随机生成一些数字并与编码后的字符串进行异或操作</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">        random_int = randint_func(<span class="number">0</span>, <span class="built_in">len</span>(arr))</span><br><span class="line">        result_list.append(random_int ^ encoded_pla[_])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result_list</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">enc</span>):</span><br><span class="line">     random.seed()<span class="comment">#随机数种子的参数不知道</span></span><br><span class="line">     whereiftheflag1(enc)   </span><br><span class="line"><span class="keyword">if</span> __name__  == <span class="string">&quot;__main__&quot;</span> </span><br><span class="line">    enc=<span class="built_in">list</span>(<span class="built_in">input</span>())</span><br><span class="line">    enc=byte(enc)</span><br><span class="line">    encode()</span><br></pre></td></tr></table></figure><p>由于随机数种子的参数我们不知道</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">125</span>):</span><br><span class="line"> random.seed(j)</span><br><span class="line"> encry = [<span class="number">108</span>, <span class="number">117</span>, <span class="number">72</span>, <span class="number">80</span>, <span class="number">64</span>, <span class="number">49</span>, <span class="number">99</span>, <span class="number">19</span>, <span class="number">69</span>, <span class="number">115</span>, <span class="number">94</span>, <span class="number">93</span>, <span class="number">94</span>, <span class="number">115</span>, <span class="number">71</span>, <span class="number">95</span>, <span class="number">84</span>, <span class="number">89</span>, <span class="number">56</span>, <span class="number">101</span>, <span class="number">70</span>, <span class="number">2</span>, <span class="number">84</span>, <span class="number">75</span>, <span class="number">127</span>, <span class="number">68</span>, <span class="number">103</span>, <span class="number">85</span>, <span class="number">105</span>, <span class="number">113</span>, <span class="number">80</span>, <span class="number">103</span>, <span class="number">95</span>, <span class="number">67</span>, <span class="number">81</span>, <span class="number">7</span>, <span class="number">113</span>, <span class="number">70</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">92</span>, <span class="number">124</span>, <span class="number">93</span>, <span class="number">120</span>, <span class="number">104</span>, <span class="number">108</span>, <span class="number">106</span>, <span class="number">17</span>, <span class="number">80</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">75</span>, <span class="number">93</span>, <span class="number">68</span>, <span class="number">121</span>, <span class="number">26</span>]</span><br><span class="line"> keys = [random.randint(<span class="number">0</span>, <span class="built_in">len</span>(encry)) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(encry))]</span><br><span class="line"> flag = []</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(encry)):</span><br><span class="line">    flag.append(keys[i] ^ encry[i])</span><br><span class="line"> <span class="keyword">try</span>:</span><br><span class="line">     <span class="built_in">print</span>(base64.b64decode((<span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">chr</span>, flag))).encode()))</span><br><span class="line"> <span class="keyword">except</span> binascii.Error:</span><br><span class="line">     <span class="keyword">continue</span></span><br><span class="line"><span class="comment">#b&#x27;flag&#123;7f9a2d3c-07de-11ef-be5e-cf1e88674c0b&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="gdb-debug"><a href="#gdb-debug" class="headerlink" title="gdb_debug"></a>gdb_debug</h2><p>加密逻辑非常清楚</p><p>有三处异或</p><p>在生成的随机数那里，有一个办法</p><p>在它调用rand这个函数之后，后面下一个条件断点</p><p><img src="/../image/704.png" class="lazyload" data-srcset="/../image/704.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="704"></p><p>我们需要下三处条件断点，然后得出三处生成的随机数数组</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> flag[<span class="number">38</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> enc[<span class="number">38</span>] = &#123; <span class="number">0x63</span>,<span class="number">0x6f</span>,<span class="number">0x6e</span>,<span class="number">0x67</span>,<span class="number">0x72</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x75</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x69</span>,<span class="number">0x6f</span>,<span class="number">0x6e</span>,<span class="number">0x73</span>,<span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x79</span>,<span class="number">0x6f</span>,<span class="number">0x75</span>,<span class="number">0x63</span>,<span class="number">0x6f</span>,<span class="number">0x6e</span>,<span class="number">0x67</span>,<span class="number">0x72</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x75</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x69</span>,<span class="number">0x6f</span>,<span class="number">0x6e</span>,<span class="number">0x73</span>,<span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x79</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> arr1[<span class="number">38</span>] = &#123; <span class="number">0xBF</span>, <span class="number">0xD7</span>, <span class="number">0x2E</span>, <span class="number">0xDA</span>, <span class="number">0xEE</span>, <span class="number">0xA8</span>, <span class="number">0x1A</span>, <span class="number">0x10</span>, <span class="number">0x83</span>, <span class="number">0x73</span>, <span class="number">0xAC</span>, <span class="number">0xF1</span>, <span class="number">0x06</span>, <span class="number">0xBE</span>, <span class="number">0xAD</span>, <span class="number">0x88</span>, <span class="number">0x04</span>, <span class="number">0xD7</span>, <span class="number">0x12</span>, <span class="number">0xFE</span>, <span class="number">0xB5</span>, <span class="number">0xE2</span>, <span class="number">0x61</span>, <span class="number">0xB7</span>, <span class="number">0x3D</span>, <span class="number">0x07</span>, <span class="number">0x4A</span>, <span class="number">0xE8</span>, <span class="number">0x96</span>, <span class="number">0xA2</span>, <span class="number">0x9D</span>, <span class="number">0x4D</span>, <span class="number">0xBC</span>, <span class="number">0x81</span>, <span class="number">0x8C</span>, <span class="number">0xE9</span>, <span class="number">0x88</span>, <span class="number">0x78</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> xor[] = &#123; <span class="number">0xd9</span>,<span class="number">0x0f</span>,<span class="number">0x18</span>,<span class="number">0xbd</span>,<span class="number">0xc7</span>,<span class="number">0x16</span>,<span class="number">0x81</span>,<span class="number">0xbe</span>,<span class="number">0xf8</span>,<span class="number">0x4a</span>,<span class="number">0x65</span>,<span class="number">0xf2</span>,<span class="number">0x5d</span>,<span class="number">0xab</span>,<span class="number">0x2b</span>,<span class="number">0x33</span>,<span class="number">0xd4</span>,<span class="number">0xa5</span>,<span class="number">0x67</span>,<span class="number">0x98</span>,<span class="number">0x9f</span>,<span class="number">0x7e</span>,<span class="number">0x2b</span>,<span class="number">0x5d</span>,<span class="number">0xc2</span>,<span class="number">0xaf</span>,<span class="number">0x8e</span>,<span class="number">0x3a</span>,<span class="number">0x4c</span>,<span class="number">0xa5</span>,<span class="number">0x75</span>,<span class="number">0x25</span>,<span class="number">0xb4</span>,<span class="number">0x8d</span>,<span class="number">0xe3</span>,<span class="number">0x7b</span>,<span class="number">0xa3</span>,<span class="number">0x64</span> &#125;;</span><br><span class="line"><span class="type">uint32_t</span> xor1[] = &#123; <span class="number">0x5397b3de</span>,<span class="number">0x716150aa</span>,<span class="number">0x1dc9e542</span>,<span class="number">0x0c9bcafc</span>,<span class="number">0x769bf209</span>,<span class="number">0x774664e8</span>,<span class="number">0x4d05f8b2</span>,<span class="number">0x7a1b0806</span>,<span class="number">0x5489330d</span>,<span class="number">0x572e6493</span>,<span class="number">0x36e62061</span>,<span class="number">0x1c979ef4</span>,<span class="number">0x53b95624</span>,<span class="number">0x7b87ba49</span>,<span class="number">0x4a02a315</span>,<span class="number">0x4b3ee601</span>,<span class="number">0x3fa44ad7</span>,<span class="number">0x529698ab</span>,<span class="number">0x5d6d5804</span>,<span class="number">0x18161018</span>,<span class="number">0x605146cf</span>,<span class="number">0x75be02e9</span>,<span class="number">0x5b2f51d5</span>,<span class="number">0x04c0fb96</span>,<span class="number">0x22f4fb33</span>,<span class="number">0x314403ca</span>,<span class="number">0x58e431f9</span>,<span class="number">0x488cbe2a</span>,<span class="number">0x6677855e</span>,<span class="number">0x771e54ea</span>,<span class="number">0x677e312d</span>,<span class="number">0x3a0f393c</span>,<span class="number">0x687fa594</span>,<span class="number">0x0548166f</span>,<span class="number">0x46ab0438</span>,<span class="number">0x5f1b979d</span>,<span class="number">0x7c8e7b58</span>,<span class="number">0x13b0fcea</span> &#125;;</span><br><span class="line"><span class="type">int</span> t1[] = &#123; <span class="number">33</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">0</span>,<span class="number">32</span>,<span class="number">31</span>,<span class="number">10</span>,<span class="number">29</span>,<span class="number">9</span>,<span class="number">24</span>,<span class="number">26</span>,<span class="number">11</span>,<span class="number">20</span>,<span class="number">24</span>,<span class="number">21</span>,<span class="number">3</span>,<span class="number">12</span>,<span class="number">10</span>,<span class="number">13</span>,<span class="number">2</span>,<span class="number">15</span>,<span class="number">4</span>,<span class="number">13</span>,<span class="number">10</span>,<span class="number">8</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> ptr[<span class="number">38</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> final_flag[<span class="number">38</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">ptr[i] = i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">37</span>; i; --i)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> v18 = t1[<span class="number">37</span>-i];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> v19 = ptr[i];</span><br><span class="line">ptr[i] = ptr[v18];</span><br><span class="line">ptr[v18] = v19;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">flag[i] = enc[i] ^ arr1[i];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">flag[i] ^= xor1[i];</span><br><span class="line">final_flag[ptr[i]] = (flag[i]&amp;<span class="number">0xff</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">final_flag[i] ^= xor[i];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, final_flag[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/../image/image-20240531204507826.png" class="lazyload" data-srcset="/../image/image-20240531204507826.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20240531204507826"></p><h2 id="rust-baby"><a href="#rust-baby" class="headerlink" title="rust_baby"></a>rust_baby</h2><p>首先我们要先找到这个函数</p><p>sub_7FF7B37F298A</p><p>这个函数相当于就是我们的主函数</p><p><img src="/../image/706.png" class="lazyload" data-srcset="/../image/706.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="706"></p><p>然后我们把memcpy的内容放到cyberchef里面解密，发现它一个字典的格式，这里面的信息对我们后面有用</p><p>这个函数就是输入函数</p><p><img src="/../image/707.png" class="lazyload" data-srcset="/../image/707.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="707"></p><p>我们注意到后面只处理八个字符，所以我就先输入8个字符</p><p>我们直接下个硬件断点，然后我们可以跟踪对字符串的处理</p><p><img src="/../image/708.png" class="lazyload" data-srcset="/../image/708.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="708"></p><p>由于这里的加密函数太复杂了，我们直接黑盒分析</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">12345611  -------&gt;&gt;&gt;  01346733</span><br><span class="line">aabbccdd  -------&gt;&gt;&gt;  ``bbddff</span><br><span class="line">22334455  -------&gt;&gt;&gt;  11335577</span><br><span class="line">44556677  -------&gt;&gt;&gt;  33557799</span><br></pre></td></tr></table></figure><p>我们可以得到这个规律，后面还有个异或操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dic=-<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(enc),<span class="number">2</span>):</span><br><span class="line">    enc[i]+=dic</span><br><span class="line">    enc[i+<span class="number">1</span>]+=dic</span><br><span class="line">    dic+=<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    enc[i]^=<span class="number">0x33</span></span><br></pre></td></tr></table></figure><p>后面还有一个异或操作</p><p><img src="/../image/709.png" class="lazyload" data-srcset="/../image/709.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="709"></p><p>然后我们可以在这里提取出来我们需要异或的数值，但是我们怎么提取出真正的密钥呢，我们可以看到v91那里一共有104个字节，我们可以把这里全部设置成0</p><p>然后在后面可以提取出密钥，由于中间全部进行了base64加密操作，base64解密之后的就是真正的密钥</p><p><img src="/../image/710.png" class="lazyload" data-srcset="/../image/710.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="710"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">REAL_KEY =[<span class="number">0xdc</span>,<span class="number">0x5f</span>,<span class="number">0x20</span>,<span class="number">0x22</span>,<span class="number">0xc2</span>,<span class="number">0x79</span>,<span class="number">0x19</span>,<span class="number">0x56</span>,<span class="number">0x35</span>,<span class="number">0xda</span>,<span class="number">0x8b</span>,<span class="number">0x47</span>,<span class="number">0xd3</span>,<span class="number">0x19</span>,<span class="number">0xfc</span>,<span class="number">0x55</span>,<span class="number">0x14</span>,<span class="number">0xcd</span>,<span class="number">0xd2</span>,<span class="number">0x7b</span>,<span class="number">0x58</span>,<span class="number">0x59</span>,<span class="number">0x09</span>,<span class="number">0x42</span>,<span class="number">0xde</span>,<span class="number">0x2c</span>,<span class="number">0xb4</span>,<span class="number">0x48</span>,<span class="number">0xd9</span>,<span class="number">0xf2</span>,<span class="number">0x1b</span>,<span class="number">0xa9</span>,<span class="number">0x40</span>,<span class="number">0xe1</span>,<span class="number">0xa6</span>,<span class="number">0xfb</span>,<span class="number">0xff</span>,<span class="number">0x38</span>,<span class="number">0xc1</span>,<span class="number">0xd5</span>,<span class="number">0xe2</span>,<span class="number">0xe8</span>,<span class="number">0x77</span>,<span class="number">0x78</span>,<span class="number">0x6f</span>,<span class="number">0x22</span>,<span class="number">0x04</span>,<span class="number">0xe6</span>,<span class="number">0x16</span>,<span class="number">0x3e</span>,<span class="number">0x0c</span>,<span class="number">0x35</span>,<span class="number">0x52</span>,<span class="number">0x5c</span>,<span class="number">0xfd</span>,<span class="number">0xc1</span>,<span class="number">0xe5</span>,<span class="number">0x59</span>,<span class="number">0x1c</span>,<span class="number">0xd0</span>,<span class="number">0xae</span>,<span class="number">0x5a</span>,<span class="number">0xb2</span>,<span class="number">0xdd</span>,<span class="number">0x19</span>,<span class="number">0xf8</span>,<span class="number">0x42</span>,<span class="number">0xe6</span>,<span class="number">0x2c</span>,<span class="number">0x89</span>,<span class="number">0x59</span>,<span class="number">0xe5</span>,<span class="number">0x11</span>,<span class="number">0x9c</span>,<span class="number">0xc8</span>,<span class="number">0x7b</span>,<span class="number">0x81</span>,<span class="number">0x70</span>,<span class="number">0x7f</span>,<span class="number">0x6f</span>,<span class="number">0xbc</span>,<span class="number">0x6f</span>,<span class="number">0x02</span>,<span class="number">0x8f</span>,<span class="number">0xf7</span>,<span class="number">0xf4</span>,<span class="number">0xc8</span>,<span class="number">0x70</span>,<span class="number">0xae</span>,<span class="number">0x02</span>,<span class="number">0xf8</span>,<span class="number">0x5b</span>,<span class="number">0xe2</span>,<span class="number">0x72</span>,<span class="number">0x08</span>,<span class="number">0x09</span>,<span class="number">0x6f</span>,<span class="number">0xbf</span>,<span class="number">0x4b</span>,<span class="number">0x39</span>,<span class="number">0xb5</span>,<span class="number">0xd0</span>,<span class="number">0x1e</span>,<span class="number">0xa3</span>]</span><br><span class="line">enc=[<span class="number">0x8a</span>,<span class="number">0x07</span>,<span class="number">0x72</span>,<span class="number">0x76</span>,<span class="number">0x8d</span>,<span class="number">0x7d</span>,<span class="number">0x4d</span>,<span class="number">0x51</span>,<span class="number">0x35</span>,<span class="number">0xde</span>,<span class="number">0x88</span>,<span class="number">0x16</span>,<span class="number">0xd4</span>,<span class="number">0x04</span>,<span class="number">0xf9</span>,<span class="number">0x0e</span>,<span class="number">0x08</span>,<span class="number">0xcf</span>,<span class="number">0xcc</span>,<span class="number">0x7c</span>,<span class="number">0x0f</span>,<span class="number">0x0d</span>,<span class="number">0x09</span>,<span class="number">0x5e</span>,<span class="number">0xd5</span>,<span class="number">0x7e</span>,<span class="number">0xe4</span>,<span class="number">0x4b</span>,<span class="number">0xc4</span>,<span class="number">0xf3</span>,<span class="number">0x1c</span>,<span class="number">0xaf</span>,<span class="number">0x12</span>,<span class="number">0xe4</span>,<span class="number">0xa0</span>,<span class="number">0xae</span>,<span class="number">0xf6</span>,<span class="number">0x69</span>,<span class="number">0xc9</span>,<span class="number">0xd2</span>,<span class="number">0xe0</span>,<span class="number">0xa7</span>,<span class="number">0x01</span>,<span class="number">0x0e</span>,<span class="number">0x1a</span>,<span class="number">0x57</span>,<span class="number">0x70</span>,<span class="number">0x92</span>,<span class="number">0x61</span>,<span class="number">0x49</span>,<span class="number">0x7a</span>,<span class="number">0x43</span>,<span class="number">0x27</span>,<span class="number">0x29</span>,<span class="number">0x89</span>,<span class="number">0xb5</span>,<span class="number">0x92</span>,<span class="number">0x2e</span>,<span class="number">0x6a</span>,<span class="number">0xa6</span>,<span class="number">0xdb</span>,<span class="number">0x2f</span>,<span class="number">0xc6</span>,<span class="number">0xa9</span>,<span class="number">0x6e</span>,<span class="number">0x8f</span>,<span class="number">0x34</span>,<span class="number">0x90</span>,<span class="number">0x59</span>,<span class="number">0xfc</span>,<span class="number">0x2d</span>,<span class="number">0x91</span>,<span class="number">0x66</span>,<span class="number">0xeb</span>,<span class="number">0xbe</span>,<span class="number">0x0d</span>,<span class="number">0xf4</span>,<span class="number">0x05</span>,<span class="number">0x0b</span>,<span class="number">0x1b</span>,<span class="number">0xcb</span>,<span class="number">0x18</span>,<span class="number">0x74</span>,<span class="number">0xf9</span>,<span class="number">0x82</span>,<span class="number">0x81</span>,<span class="number">0xbc</span>,<span class="number">0x04</span>,<span class="number">0xd9</span>,<span class="number">0x75</span>,<span class="number">0x8e</span>,<span class="number">0x2d</span>,<span class="number">0x97</span>,<span class="number">0x07</span>,<span class="number">0x7c</span>,<span class="number">0x7d</span>,<span class="number">0x18</span>,<span class="number">0xc8</span>,<span class="number">0x3d</span>,<span class="number">0x4f</span>,<span class="number">0xc0</span>,<span class="number">0xa5</span>,<span class="number">0x6a</span>,<span class="number">0xd7</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(REAL_KEY)):</span><br><span class="line">    enc[i]^=REAL_KEY[i]</span><br><span class="line">    enc[i]^=<span class="number">0x33</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">13</span>):</span><br><span class="line">   num1=-<span class="number">1</span></span><br><span class="line">   <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">8</span>,<span class="number">2</span>):</span><br><span class="line">       enc[<span class="number">8</span>*i+j]-=num1</span><br><span class="line">       enc[<span class="number">8</span>*i+j+<span class="number">1</span>]-=num1</span><br><span class="line">       num1+=<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span>  i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(enc[i]),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment">#flag&#123;6e2480b3-4f02-4cf1-9bc0-123b75f9a922&#125;</span></span><br></pre></td></tr></table></figure><h2 id="GoReverse"><a href="#GoReverse" class="headerlink" title="GoReverse"></a>GoReverse</h2><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>这里借鉴的思路是panda0s师傅的思路</p><p><a href="https://www.bilibili.com/video/BV1bJ4m1w767/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=f5a24deea97cc11fbdd53a993a4129bf">https://www.bilibili.com/video/BV1bJ4m1w767/?spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=f5a24deea97cc11fbdd53a993a4129bf</a></p><p><img src="/../image/667.png" class="lazyload" data-srcset="/../image/667.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="667"></p><p>发现没有符号表，我们可以先恢复一下符号表</p><p><a href="https://github.com/0xjiayu/go_parser">https://github.com/0xjiayu/go_parser</a><br>克隆仓库，IDA加载go_parser.py即可，不需要把脚本放到plugin里面</p><p><img src="/../image/668.png" class="lazyload" data-srcset="/../image/668.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="668"></p><p>初始化在runtime_main里面，然后我们的主函数在main__B2bUPq_Execute里面</p><p>里面一共有两个反调试的地方</p><p><img src="/../image/669.png" class="lazyload" data-srcset="/../image/669.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="669"></p><p>在调用这个runtime_systemstack之后就会退出，我们可以把这个nop掉</p><p><img src="/../image/670.png" class="lazyload" data-srcset="/../image/670.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="670"></p><p>第二个反调试就很明显了，在地址0x004D64A0 这里</p><p>把他patch掉就行了</p><p><img src="/../image/671.png" class="lazyload" data-srcset="/../image/671.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="671"></p><p>后面的zQyveE为xxtea加密，我们可以把ToUint32s复制下来</p><p><a href="https://github.com/xxtea/xxtea-go/blob/master/xxtea/xxtea.go">https://github.com/xxtea/xxtea-go/blob/master/xxtea/xxtea.go</a></p><p><img src="/../image/672.png" class="lazyload" data-srcset="/../image/672.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="672"></p><p>我们可以发现xxtea进行了魔改，魔改的地方为MX和delta</p><p>然后我们可以在以下几个地方设置断点</p><p><img src="/../image/673.png" class="lazyload" data-srcset="/../image/673.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="673"></p><p><img src="/../image/674.png" class="lazyload" data-srcset="/../image/674.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="674"></p><p>然后我们可以先在进行异或操作之前下个断点</p><p><img src="/../image/675.png" class="lazyload" data-srcset="/../image/675.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="675"></p><p>因为我是之前先异或了，所以再异或一下就回去了，这样便于我们更好分析</p><p>以下是我们异或的值</p><p><img src="/../image/676.png" class="lazyload" data-srcset="/../image/676.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="676"></p><p>我们经过xxtea加密之后我们看一下它的返回值</p><p><img src="/../image/677.png" class="lazyload" data-srcset="/../image/677.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="677"></p><p>一共十六个字节，很明显是我们的输入之后的加密结果，但是我们便于分析统一变成11，这个时候我们就可以直接按F9</p><p>跳到了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004D5D41 call    github_com_tjfoc_gmsm_sm4_NewCipher</span><br></pre></td></tr></table></figure><p><img src="/../image/678.png" class="lazyload" data-srcset="/../image/678.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="678"></p><p>然后这个时候我们可以得到SM4的密钥</p><p>继续往下面调</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004D5D96 call    crypto_rand_Read</span><br></pre></td></tr></table></figure><p>这是生成的随机数</p><p><img src="/../image/679.png" class="lazyload" data-srcset="/../image/679.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="679"></p><p>我们统一把它设成22</p><p>再继续往下面调，一直到了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004D5DEF call   rdx 其实调用的是crypto_cipher__ctr_XORKeyStream</span><br></pre></td></tr></table></figure><p>然后我们在rsi寄存器得到了我们一开始经过xxtea加密的密文</p><p>这个时候要和sm4生成的密文(CTR模式)进行异或</p><p>但是这个iv是随机生成的（后面会解释这个怎么得到）</p><p>继续往下面调我们可以到到aes的密钥</p><p><img src="/../image/680.png" class="lazyload" data-srcset="/../image/680.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="680"></p><p>再往下面走，我们可以得到aes的iv是key的前16位</p><p>我们在最后retn这里下个断点，我们把前16位的全都替换成33，最后在Linux里面会输出一段base32的字符串</p><p><img src="/../image/681.png" class="lazyload" data-srcset="/../image/681.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="681"></p><p><img src="/../image/683.png" class="lazyload" data-srcset="/../image/683.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="683"></p><p><img src="/../image/682.png" class="lazyload" data-srcset="/../image/682.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="682"></p><p>就是我们最后输入的33，那么说明我们在经过base32和aes解密之后，得到的前16个字节就是sm4随机生成的iv</p><h3 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h3><p>这里为了复现我直接借用了其它师傅在比赛中得到的flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;3a4575cf-c85c-4350-90ca-baef825242&#125;</span><br></pre></td></tr></table></figure><p><img src="/../image/686.png" class="lazyload" data-srcset="/../image/686.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="686"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">enc=<span class="string">b&#x27;HAA4WOBVE4J2GIVLNOAXSN3N2L3UCBWPZJJICPWEVNYREBHRPGFGIT43WJENRUU25HKVMEMU7QRKDOZWADY7WOK2JAF7J7DOSZ652EY=&#x27;</span></span><br><span class="line"></span><br><span class="line">enc=base64.b32decode(enc)</span><br><span class="line"></span><br><span class="line">aeskey=<span class="string">b&#x27;dPGWgcLpqmxw3uOXhKpKV009Cql@@XE6&#x27;</span></span><br><span class="line">aesiv =<span class="string">b&#x27;dPGWgcLpqmxw3uOXhKpKV009Cql@@XE6&#x27;</span>[:<span class="number">16</span>]</span><br><span class="line"></span><br><span class="line">enc=AES.new(key=aeskey,iv=aesiv,mode=AES.MODE_CBC).decrypt(enc)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(enc[:<span class="number">16</span>].<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure><p>根据flag长度为40或42可知counter还需要分别+1和+2，总共3*16bytes</p><p><img src="/../image/685.png" class="lazyload" data-srcset="/../image/685.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="685"></p><p>我们将SM4加密的密文与AES解出来的明文的从第16位开始进行异或，解出来的就是xxtea的密文</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ctr=<span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;7c aa 04 c3 57 63 29 c3 eb 24 34 4f cf 3e 00 88 7b 60 85 f1 45 88 35 17 52 2c 72 1e 8e cf cf c9 fa 03 9e 45 0f f9 7c 05 d7 e6 b0 3a 8c 0b 09 43 11 ba e2 41 45 1c e9 f6 ea 51 52 63 f5 41 5b 29&#x27;</span>)</span><br><span class="line">enc=<span class="built_in">list</span>(enc[<span class="number">16</span>:])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    enc[i]^=ctr[i]</span><br><span class="line">enc=<span class="built_in">bytes</span>(enc)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(enc), <span class="number">4</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, enc[i:i+<span class="number">4</span>])[<span class="number">0</span>]), end=<span class="string">&quot;,&quot;</span>) <span class="comment">#变成32位，便于后面进行xxtea解密</span></span><br></pre></td></tr></table></figure><p>之后进行xxtea加密</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX ((((z&gt;&gt;5 ^ y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3 ^ z&lt;&lt;4)) ^ (sum^y)) + (key[(p&amp;3)^e]^z))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x7FAB4CAD</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">xxtea</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span>* v, <span class="type">unsigned</span> <span class="type">int</span>* key, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> y, z, sum;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> p, e, round;</span><br><span class="line"><span class="keyword">if</span> (n &gt; <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">round = <span class="number">6</span> + <span class="number">52</span> / n;</span><br><span class="line">sum = <span class="number">0</span>;</span><br><span class="line">z = v[n - <span class="number">1</span>];</span><br><span class="line"><span class="keyword">while</span> (round--)</span><br><span class="line">&#123;</span><br><span class="line">sum += DELTA;</span><br><span class="line">e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span> (p = <span class="number">0</span>; p &lt; n - <span class="number">1</span>; p++)</span><br><span class="line">&#123;</span><br><span class="line">y = v[p + <span class="number">1</span>];</span><br><span class="line">v[p] += MX;</span><br><span class="line">z = v[p];</span><br><span class="line">&#125;</span><br><span class="line">y = v[<span class="number">0</span>];</span><br><span class="line">v[n - <span class="number">1</span>] += MX;</span><br><span class="line">z = v[n - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (n &lt; <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">n = -n;</span><br><span class="line">round = <span class="number">6</span> + <span class="number">52</span> / n;</span><br><span class="line">sum = DELTA * round;</span><br><span class="line">y = v[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">while</span> (round--)</span><br><span class="line">&#123;</span><br><span class="line">e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span> (p = n - <span class="number">1</span>; p &gt; <span class="number">0</span>; p--)</span><br><span class="line">&#123;</span><br><span class="line">z = v[p - <span class="number">1</span>];</span><br><span class="line">v[p] -= MX;</span><br><span class="line">y = v[p];</span><br><span class="line">&#125;</span><br><span class="line">z = v[n - <span class="number">1</span>];</span><br><span class="line">v[<span class="number">0</span>] -= MX;</span><br><span class="line">y = v[<span class="number">0</span>];</span><br><span class="line">sum -= DELTA;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> xorr[] = <span class="string">&quot;D7BJLsOk9@f&amp;1dWIn53IDlJqUS6$^WhkAk2kk*2GaqmLwiLX^bGGE$&amp;dmqR^g5bL3lCA5^HGK$9qo5T@Bwom9vEXya0HAV3LrWW&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> keybyte[] = <span class="string">&quot;Bs^8*wZ4lu8oR&amp;@k&quot;</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span>* key = (<span class="type">unsigned</span> <span class="type">int</span>*)keybyte;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> text[] = &#123; <span class="number">0x14e89d7c</span>,<span class="number">0x70624924</span>,<span class="number">0xe0a2078c</span>,<span class="number">0x555d91e</span>,<span class="number">0xcdd3602</span>,<span class="number">0x6bc8c9d6</span>,<span class="number">0x975e0d09</span>,<span class="number">0x5a54d90f</span>,<span class="number">0xafc1d576</span>,<span class="number">0x73f7f1b2</span>,<span class="number">0x32b8eedf</span>,<span class="number">0x4b010384</span> &#125;;</span><br><span class="line">xxtea(text, key, <span class="number">-10</span>);</span><br><span class="line"><span class="type">char</span>* enc = (<span class="type">char</span>*)text;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">48</span>; i++)</span><br><span class="line">enc[i] ^= xorr[i % <span class="built_in">strlen</span>(xorr)];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">48</span>; i++)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, enc[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/../image/687.png" class="lazyload" data-srcset="/../image/687.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="687"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;asm-re&quot;&gt;&lt;a href=&quot;#asm-re&quot; class=&quot;headerlink&quot; title=&quot;asm_re&quot;&gt;&lt;/a&gt;asm_re&lt;/h2&gt;&lt;p&gt;直接手撕汇编&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/../image/688.png&quot; class=&quot;lazy</summary>
      
    
    
    
    <category term="WP" scheme="https://5m10v3.top/categories/WP/"/>
    
    
    <category term="ctf学习" scheme="https://5m10v3.top/tags/ctf%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>逆向练习(一)</title>
    <link href="https://5m10v3.top/2024/05/29/%E9%80%86%E5%90%91%E7%BB%83%E4%B9%A0(%E4%B8%80)/"/>
    <id>https://5m10v3.top/2024/05/29/%E9%80%86%E5%90%91%E7%BB%83%E4%B9%A0(%E4%B8%80)/</id>
    <published>2024-05-28T16:00:00.000Z</published>
    <updated>2024-06-09T09:11:01.335Z</updated>
    
    <content type="html"><![CDATA[<p>今日练习一题之AES魔改</p><p>题目链接如下，供各位师傅下载</p><p><a href="https://wwb.lanzout.com/iq2Aw20n4ype">https://wwb.lanzout.com/iq2Aw20n4ype</a><br>密码:2v3h</p><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>打开题目发现没有main函数，我们通过字符串查找定位到main函数，我们发现main函数的地方标红，发现是有花指令</p><p><img src="/../image/711.png" class="lazyload" data-srcset="/../image/711.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="711"></p><p>我们进行修复的时候要先修复下面那个call指令</p><p>修复成下图这个样子</p><p><img src="/../image/712.png" class="lazyload" data-srcset="/../image/712.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="712"></p><p>然后再将上面nop掉，就可以恢复这个主函数</p><p><img src="/../image/713.png" class="lazyload" data-srcset="/../image/713.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="713"></p><p>我们可以注意到v9就是密文，然后sub_43615B就是加密函数</p><p>但是我在做这道题的时候，没有注意到它的导出表</p><p>有一个tls反调试</p><p><img src="/../image/714.png" class="lazyload" data-srcset="/../image/714.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="714"></p><p>在这个里面主要是将密钥的第三位替换成了<strong>h</strong></p><p><img src="/../image/715.png" class="lazyload" data-srcset="/../image/715.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="715"></p><p>然后加密函数那里也有花指令</p><p>修复以及重命名之后可以看出AES的特征非常明显了</p><p><img src="/../image/716.png" class="lazyload" data-srcset="/../image/716.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="716"></p><p>主要魔改的点有以下几点:</p><ul><li>在addRoundKey轮密钥加后面那里加了异或操作(固定值)</li><li>S盒的替换</li><li>subBytes和mixColumns里面也加了异或操作</li></ul><p><img src="/../image/717.png" class="lazyload" data-srcset="/../image/717.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="717"></p><p><img src="/../image/718.png" class="lazyload" data-srcset="/../image/718.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="718"></p><p><img src="/../image/719.png" class="lazyload" data-srcset="/../image/719.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="719"></p><p>进行解密的时候先异或一下就行了</p><p>首先是S盒替换的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">new_s_box = [</span><br><span class="line"><span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>, <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, </span><br><span class="line">  <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, </span><br><span class="line">  <span class="number">0x72</span>, <span class="number">0xC0</span>, <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, </span><br><span class="line">  <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>, <span class="number">0x04</span>, <span class="number">0xC7</span>, </span><br><span class="line">  <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, </span><br><span class="line">  <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>, <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, </span><br><span class="line">  <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>, </span><br><span class="line">  <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, </span><br><span class="line">  <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>, <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, </span><br><span class="line">  <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, </span><br><span class="line">  <span class="number">0x9F</span>, <span class="number">0xA8</span>, <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, </span><br><span class="line">  <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>, <span class="number">0xCD</span>, <span class="number">0x0C</span>, </span><br><span class="line">  <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, </span><br><span class="line">  <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>, <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, </span><br><span class="line">  <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, </span><br><span class="line">  <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, </span><br><span class="line">  <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, </span><br><span class="line">  <span class="number">0xAE</span>, <span class="number">0x08</span>, <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, </span><br><span class="line">  <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x70</span>, <span class="number">0x3E</span>, </span><br><span class="line">  <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, </span><br><span class="line">  <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>, <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, </span><br><span class="line">  <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>, </span><br><span class="line">  <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, </span><br><span class="line">  <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span></span><br><span class="line">]</span><br><span class="line"> </span><br><span class="line">new_contrary_sbox = [<span class="number">0</span>]*<span class="number">256</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    line = (new_s_box[i]&amp;<span class="number">0xf0</span>)&gt;&gt;<span class="number">4</span></span><br><span class="line">    rol = new_s_box[i]&amp;<span class="number">0xf</span></span><br><span class="line">    new_contrary_sbox[(line*<span class="number">16</span>)+rol] = i</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span> (new_contrary_sbox)</span><br></pre></td></tr></table></figure><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>aes.h文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Chinese Academy of Sciences</span></span><br><span class="line"><span class="comment"> * State Key Laboratory of Information Security</span></span><br><span class="line"><span class="comment"> * Institute of Information Engineering</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2016 Chinese Academy of Sciences</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * LuoPeng, luopeng@iie.ac.cn</span></span><br><span class="line"><span class="comment"> * Updated in May 2016</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> AES_128_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AES_128_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AES_BLOCK_SIZE      16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AES_ROUNDS          10  <span class="comment">// 12, 14</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AES_ROUND_KEY_SIZE  176 <span class="comment">// AES-128 has 10 rounds, and there is a AddRoundKey before first round. (10+1)x16=176.</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @purpose:            Key schedule for AES-128</span></span><br><span class="line"><span class="comment">  * @par[in]key:         16 bytes of master keys</span></span><br><span class="line"><span class="comment">  * @par[out]roundkeys:  176 bytes of round keys</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">aes_key_schedule_128</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* key, <span class="type">uint8_t</span>* roundkeys)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @purpose:            Encryption. The length of plain and cipher should be one block (16 bytes).</span></span><br><span class="line"><span class="comment"> *                      The plaintext and ciphertext may point to the same memory</span></span><br><span class="line"><span class="comment"> * @par[in]roundkeys:   round keys</span></span><br><span class="line"><span class="comment"> * @par[in]plaintext:   plain text</span></span><br><span class="line"><span class="comment"> * @par[out]ciphertext: cipher text</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">aes_encrypt_128</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* roundkeys, <span class="type">const</span> <span class="type">uint8_t</span>* plaintext, <span class="type">uint8_t</span>* ciphertext)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @purpose:            Decryption. The length of plain and cipher should be one block (16 bytes).</span></span><br><span class="line"><span class="comment"> *                      The ciphertext and plaintext may point to the same memory</span></span><br><span class="line"><span class="comment"> * @par[in]roundkeys:   round keys</span></span><br><span class="line"><span class="comment"> * @par[in]ciphertext:  cipher text</span></span><br><span class="line"><span class="comment"> * @par[out]plaintext:  plain text</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">aes_decrypt_128</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* roundkeys, <span class="type">const</span> <span class="type">uint8_t</span>* ciphertext, <span class="type">uint8_t</span>* plaintext)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>aes.c文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Chinese Academy of Sciences</span></span><br><span class="line"><span class="comment"> * State Key Laboratory of Information Security</span></span><br><span class="line"><span class="comment"> * Institute of Information Engineering</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2016 Chinese Academy of Sciences</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * LuoPeng, luopeng@iie.ac.cn</span></span><br><span class="line"><span class="comment"> * Updated in Oct 2016</span></span><br><span class="line"><span class="comment"> * Updated in Jan 2017, update muliple function on GF(2^8).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;aes.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * round constants</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> RC[] = &#123; <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x1b</span>, <span class="number">0x36</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sbox</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> xor1[<span class="number">16</span>] = &#123; <span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> SBOX[<span class="number">256</span>] = &#123;</span><br><span class="line">    <span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>,</span><br><span class="line">  <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>, <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>,</span><br><span class="line">  <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>,</span><br><span class="line">  <span class="number">0x72</span>, <span class="number">0xC0</span>, <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>,</span><br><span class="line">  <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>, <span class="number">0x04</span>, <span class="number">0xC7</span>,</span><br><span class="line">  <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>,</span><br><span class="line">  <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>, <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>,</span><br><span class="line">  <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>,</span><br><span class="line">  <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>,</span><br><span class="line">  <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>, <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>,</span><br><span class="line">  <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>,</span><br><span class="line">  <span class="number">0x9F</span>, <span class="number">0xA8</span>, <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>,</span><br><span class="line">  <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>, <span class="number">0xCD</span>, <span class="number">0x0C</span>,</span><br><span class="line">  <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>,</span><br><span class="line">  <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>, <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>,</span><br><span class="line">  <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>,</span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>,</span><br><span class="line">  <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>,</span><br><span class="line">  <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>,</span><br><span class="line">  <span class="number">0xAE</span>, <span class="number">0x08</span>, <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>,</span><br><span class="line">  <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x70</span>, <span class="number">0x3E</span>,</span><br><span class="line">  <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>,</span><br><span class="line">  <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>, <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>,</span><br><span class="line">  <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>,</span><br><span class="line">  <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>,</span><br><span class="line">  <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Inverse Sboxs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint8_t</span> INV_SBOX[<span class="number">256</span>] = &#123;</span><br><span class="line">    <span class="number">82</span>, <span class="number">9</span>, <span class="number">106</span>, <span class="number">213</span>, <span class="number">48</span>, <span class="number">54</span>, <span class="number">165</span>, <span class="number">56</span>, <span class="number">191</span>, <span class="number">64</span>, <span class="number">163</span>, <span class="number">158</span>, <span class="number">129</span>, <span class="number">243</span>, <span class="number">215</span>, <span class="number">251</span>, <span class="number">124</span>, <span class="number">227</span>, <span class="number">57</span>, <span class="number">130</span>, <span class="number">155</span>, <span class="number">47</span>, <span class="number">255</span>, <span class="number">135</span>, <span class="number">52</span>, <span class="number">142</span>, <span class="number">67</span>, <span class="number">68</span>, <span class="number">196</span>, <span class="number">222</span>, <span class="number">233</span>, <span class="number">203</span>, <span class="number">84</span>, <span class="number">123</span>, <span class="number">148</span>, <span class="number">50</span>, <span class="number">166</span>, <span class="number">194</span>, <span class="number">35</span>, <span class="number">61</span>, <span class="number">238</span>, <span class="number">76</span>, <span class="number">149</span>, <span class="number">11</span>, <span class="number">66</span>, <span class="number">250</span>, <span class="number">195</span>, <span class="number">78</span>, <span class="number">8</span>, <span class="number">46</span>, <span class="number">161</span>, <span class="number">102</span>, <span class="number">40</span>, <span class="number">217</span>, <span class="number">36</span>, <span class="number">178</span>, <span class="number">118</span>, <span class="number">91</span>, <span class="number">162</span>, <span class="number">73</span>, <span class="number">109</span>, <span class="number">139</span>, <span class="number">209</span>, <span class="number">37</span>, <span class="number">114</span>, <span class="number">248</span>, <span class="number">246</span>, <span class="number">100</span>, <span class="number">134</span>, <span class="number">104</span>, <span class="number">152</span>, <span class="number">22</span>, <span class="number">212</span>, <span class="number">164</span>, <span class="number">92</span>, <span class="number">204</span>, <span class="number">93</span>, <span class="number">101</span>, <span class="number">182</span>, <span class="number">146</span>, <span class="number">108</span>, <span class="number">112</span>, <span class="number">72</span>, <span class="number">80</span>, <span class="number">253</span>, <span class="number">237</span>, <span class="number">185</span>, <span class="number">218</span>, <span class="number">94</span>, <span class="number">21</span>, <span class="number">70</span>, <span class="number">87</span>, <span class="number">167</span>, <span class="number">141</span>, <span class="number">157</span>, <span class="number">132</span>, <span class="number">144</span>, <span class="number">216</span>, <span class="number">171</span>, <span class="number">0</span>, <span class="number">140</span>, <span class="number">188</span>, <span class="number">211</span>, <span class="number">10</span>, <span class="number">247</span>, <span class="number">228</span>, <span class="number">88</span>, <span class="number">5</span>, <span class="number">184</span>, <span class="number">179</span>, <span class="number">69</span>, <span class="number">6</span>, <span class="number">208</span>, <span class="number">44</span>, <span class="number">30</span>, <span class="number">143</span>, <span class="number">202</span>, <span class="number">63</span>, <span class="number">15</span>, <span class="number">2</span>, <span class="number">193</span>, <span class="number">175</span>, <span class="number">189</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">19</span>, <span class="number">138</span>, <span class="number">107</span>, <span class="number">58</span>, <span class="number">145</span>, <span class="number">17</span>, <span class="number">65</span>, <span class="number">79</span>, <span class="number">103</span>, <span class="number">220</span>, <span class="number">234</span>, <span class="number">151</span>, <span class="number">242</span>, <span class="number">207</span>, <span class="number">206</span>, <span class="number">240</span>, <span class="number">180</span>, <span class="number">230</span>, <span class="number">115</span>, <span class="number">150</span>, <span class="number">172</span>, <span class="number">116</span>, <span class="number">34</span>, <span class="number">231</span>, <span class="number">173</span>, <span class="number">53</span>, <span class="number">133</span>, <span class="number">226</span>, <span class="number">249</span>, <span class="number">55</span>, <span class="number">232</span>, <span class="number">28</span>, <span class="number">117</span>, <span class="number">223</span>, <span class="number">110</span>, <span class="number">71</span>, <span class="number">241</span>, <span class="number">26</span>, <span class="number">113</span>, <span class="number">29</span>, <span class="number">41</span>, <span class="number">197</span>, <span class="number">137</span>, <span class="number">111</span>, <span class="number">183</span>, <span class="number">98</span>, <span class="number">14</span>, <span class="number">170</span>, <span class="number">24</span>, <span class="number">190</span>, <span class="number">27</span>, <span class="number">252</span>, <span class="number">86</span>, <span class="number">62</span>, <span class="number">75</span>, <span class="number">198</span>, <span class="number">210</span>, <span class="number">121</span>, <span class="number">32</span>, <span class="number">154</span>, <span class="number">219</span>, <span class="number">192</span>, <span class="number">254</span>, <span class="number">120</span>, <span class="number">205</span>, <span class="number">90</span>, <span class="number">244</span>, <span class="number">31</span>, <span class="number">221</span>, <span class="number">168</span>, <span class="number">51</span>, <span class="number">136</span>, <span class="number">7</span>, <span class="number">199</span>, <span class="number">49</span>, <span class="number">177</span>, <span class="number">18</span>, <span class="number">16</span>, <span class="number">89</span>, <span class="number">39</span>, <span class="number">128</span>, <span class="number">236</span>, <span class="number">95</span>, <span class="number">96</span>, <span class="number">81</span>, <span class="number">127</span>, <span class="number">169</span>, <span class="number">25</span>, <span class="number">181</span>, <span class="number">74</span>, <span class="number">13</span>, <span class="number">45</span>, <span class="number">229</span>, <span class="number">122</span>, <span class="number">159</span>, <span class="number">147</span>, <span class="number">201</span>, <span class="number">156</span>, <span class="number">239</span>, <span class="number">160</span>, <span class="number">224</span>, <span class="number">59</span>, <span class="number">77</span>, <span class="number">174</span>, <span class="number">42</span>, <span class="number">245</span>, <span class="number">176</span>, <span class="number">200</span>, <span class="number">235</span>, <span class="number">187</span>, <span class="number">60</span>, <span class="number">131</span>, <span class="number">83</span>, <span class="number">153</span>, <span class="number">97</span>, <span class="number">23</span>, <span class="number">43</span>, <span class="number">4</span>, <span class="number">126</span>, <span class="number">186</span>, <span class="number">119</span>, <span class="number">214</span>, <span class="number">38</span>, <span class="number">225</span>, <span class="number">105</span>,</span><br><span class="line"><span class="number">20</span>, <span class="number">99</span>, <span class="number">85</span>, <span class="number">33</span>, <span class="number">12</span>, <span class="number">125</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * https://en.wikipedia.org/wiki/Finite_field_arithmetic</span></span><br><span class="line"><span class="comment"> * Multiply two numbers in the GF(2^8) finite field defined</span></span><br><span class="line"><span class="comment"> * by the polynomial x^8 + x^4 + x^3 + x + 1 = 0</span></span><br><span class="line"><span class="comment"> * We do use mul2(int8_t a) but not mul(uint8_t a, uint8_t b)</span></span><br><span class="line"><span class="comment"> * just in order to get a higher speed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint8_t</span> <span class="title function_">mul2</span><span class="params">(<span class="type">uint8_t</span> a)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0x1B</span> * ((a &gt;&gt; <span class="number">7</span>) &amp; <span class="number">1</span>)) ^ (<span class="number">2</span> * a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @purpose:    ShiftRows</span></span><br><span class="line"><span class="comment"> * @descrption:</span></span><br><span class="line"><span class="comment"> *  Row0: s0  s4  s8  s12   &lt;&lt;&lt; 0 byte</span></span><br><span class="line"><span class="comment"> *  Row1: s1  s5  s9  s13   &lt;&lt;&lt; 1 byte</span></span><br><span class="line"><span class="comment"> *  Row2: s2  s6  s10 s14   &lt;&lt;&lt; 2 bytes</span></span><br><span class="line"><span class="comment"> *  Row3: s3  s7  s11 s15   &lt;&lt;&lt; 3 bytes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">shift_rows</span><span class="params">(<span class="type">uint8_t</span>* state)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> temp;</span><br><span class="line">    <span class="comment">// row1</span></span><br><span class="line">    temp = *(state + <span class="number">1</span>);</span><br><span class="line">    *(state + <span class="number">1</span>) = *(state + <span class="number">5</span>);</span><br><span class="line">    *(state + <span class="number">5</span>) = *(state + <span class="number">9</span>);</span><br><span class="line">    *(state + <span class="number">9</span>) = *(state + <span class="number">13</span>);</span><br><span class="line">    *(state + <span class="number">13</span>) = temp;</span><br><span class="line">    <span class="comment">// row2</span></span><br><span class="line">    temp = *(state + <span class="number">2</span>);</span><br><span class="line">    *(state + <span class="number">2</span>) = *(state + <span class="number">10</span>);</span><br><span class="line">    *(state + <span class="number">10</span>) = temp;</span><br><span class="line">    temp = *(state + <span class="number">6</span>);</span><br><span class="line">    *(state + <span class="number">6</span>) = *(state + <span class="number">14</span>);</span><br><span class="line">    *(state + <span class="number">14</span>) = temp;</span><br><span class="line">    <span class="comment">// row3</span></span><br><span class="line">    temp = *(state + <span class="number">15</span>);</span><br><span class="line">    *(state + <span class="number">15</span>) = *(state + <span class="number">11</span>);</span><br><span class="line">    *(state + <span class="number">11</span>) = *(state + <span class="number">7</span>);</span><br><span class="line">    *(state + <span class="number">7</span>) = *(state + <span class="number">3</span>);</span><br><span class="line">    *(state + <span class="number">3</span>) = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @purpose:    Inverse ShiftRows</span></span><br><span class="line"><span class="comment"> * @description</span></span><br><span class="line"><span class="comment"> *  Row0: s0  s4  s8  s12   &gt;&gt;&gt; 0 byte</span></span><br><span class="line"><span class="comment"> *  Row1: s1  s5  s9  s13   &gt;&gt;&gt; 1 byte</span></span><br><span class="line"><span class="comment"> *  Row2: s2  s6  s10 s14   &gt;&gt;&gt; 2 bytes</span></span><br><span class="line"><span class="comment"> *  Row3: s3  s7  s11 s15   &gt;&gt;&gt; 3 bytes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">inv_shift_rows</span><span class="params">(<span class="type">uint8_t</span>* state)</span> &#123;</span><br><span class="line">    <span class="type">uint8_t</span> temp;</span><br><span class="line">    <span class="comment">// row1</span></span><br><span class="line">    temp = *(state + <span class="number">13</span>);</span><br><span class="line">    *(state + <span class="number">13</span>) = *(state + <span class="number">9</span>);</span><br><span class="line">    *(state + <span class="number">9</span>) = *(state + <span class="number">5</span>);</span><br><span class="line">    *(state + <span class="number">5</span>) = *(state + <span class="number">1</span>);</span><br><span class="line">    *(state + <span class="number">1</span>) = temp;</span><br><span class="line">    <span class="comment">// row2</span></span><br><span class="line">    temp = *(state + <span class="number">14</span>);</span><br><span class="line">    *(state + <span class="number">14</span>) = *(state + <span class="number">6</span>);</span><br><span class="line">    *(state + <span class="number">6</span>) = temp;</span><br><span class="line">    temp = *(state + <span class="number">10</span>);</span><br><span class="line">    *(state + <span class="number">10</span>) = *(state + <span class="number">2</span>);</span><br><span class="line">    *(state + <span class="number">2</span>) = temp;</span><br><span class="line">    <span class="comment">// row3</span></span><br><span class="line">    temp = *(state + <span class="number">3</span>);</span><br><span class="line">    *(state + <span class="number">3</span>) = *(state + <span class="number">7</span>);</span><br><span class="line">    *(state + <span class="number">7</span>) = *(state + <span class="number">11</span>);</span><br><span class="line">    *(state + <span class="number">11</span>) = *(state + <span class="number">15</span>);</span><br><span class="line">    *(state + <span class="number">15</span>) = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">aes_key_schedule_128</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* key, <span class="type">uint8_t</span>* roundkeys)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> temp[<span class="number">4</span>];</span><br><span class="line">    <span class="type">uint8_t</span>* last4bytes; <span class="comment">// point to the last 4 bytes of one round</span></span><br><span class="line">    <span class="type">uint8_t</span>* lastround;</span><br><span class="line">    <span class="type">uint8_t</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) &#123;</span><br><span class="line">        *roundkeys++ = *key++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    last4bytes = roundkeys - <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_ROUNDS; ++i) &#123;</span><br><span class="line">        <span class="comment">// k0-k3 for next round</span></span><br><span class="line">        temp[<span class="number">3</span>] = SBOX[*last4bytes++];</span><br><span class="line">        temp[<span class="number">0</span>] = SBOX[*last4bytes++];</span><br><span class="line">        temp[<span class="number">1</span>] = SBOX[*last4bytes++];</span><br><span class="line">        temp[<span class="number">2</span>] = SBOX[*last4bytes++];</span><br><span class="line">        temp[<span class="number">0</span>] ^= RC[i];</span><br><span class="line">        lastround = roundkeys - <span class="number">16</span>;</span><br><span class="line">        *roundkeys++ = temp[<span class="number">0</span>] ^ *lastround++;</span><br><span class="line">        *roundkeys++ = temp[<span class="number">1</span>] ^ *lastround++;</span><br><span class="line">        *roundkeys++ = temp[<span class="number">2</span>] ^ *lastround++;</span><br><span class="line">        *roundkeys++ = temp[<span class="number">3</span>] ^ *lastround++;</span><br><span class="line">        <span class="comment">// k4-k7 for next round        </span></span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        <span class="comment">// k8-k11 for next round</span></span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        <span class="comment">// k12-k15 for next round</span></span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">        *roundkeys++ = *last4bytes++ ^ *lastround++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">aes_encrypt_128</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* roundkeys, <span class="type">const</span> <span class="type">uint8_t</span>* plaintext, <span class="type">uint8_t</span>* ciphertext)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> tmp[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;, t;</span><br><span class="line">    <span class="type">uint8_t</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// first AddRoundKey</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">        *(ciphertext + i) = *(plaintext + i) ^ *roundkeys++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; AES_BLOCK_SIZE; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(ciphertext + j) ^= xor1[j];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 9 rounds</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; AES_ROUNDS; ++j) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SubBytes</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">            *(tmp + i) = SBOX[*(ciphertext + i)];</span><br><span class="line">            *(tmp + i) ^= <span class="number">0xA1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        shift_rows(tmp);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * MixColumns</span></span><br><span class="line"><span class="comment">         * [02 03 01 01]   [s0  s4  s8  s12]</span></span><br><span class="line"><span class="comment">         * [01 02 03 01] . [s1  s5  s9  s13]</span></span><br><span class="line"><span class="comment">         * [01 01 02 03]   [s2  s6  s10 s14]</span></span><br><span class="line"><span class="comment">         * [03 01 01 02]   [s3  s7  s11 s15]</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; i += <span class="number">4</span>) &#123;</span><br><span class="line">            t = tmp[i] ^ tmp[i + <span class="number">1</span>] ^ tmp[i + <span class="number">2</span>] ^ tmp[i + <span class="number">3</span>];</span><br><span class="line">            ciphertext[i] = mul2(tmp[i] ^ tmp[i + <span class="number">1</span>]) ^ tmp[i] ^ t;</span><br><span class="line">            ciphertext[i + <span class="number">1</span>] = mul2(tmp[i + <span class="number">1</span>] ^ tmp[i + <span class="number">2</span>]) ^ tmp[i + <span class="number">1</span>] ^ t;</span><br><span class="line">            ciphertext[i + <span class="number">2</span>] = mul2(tmp[i + <span class="number">2</span>] ^ tmp[i + <span class="number">3</span>]) ^ tmp[i + <span class="number">2</span>] ^ t;</span><br><span class="line">            ciphertext[i + <span class="number">3</span>] = mul2(tmp[i + <span class="number">3</span>] ^ tmp[i]) ^ tmp[i + <span class="number">3</span>] ^ t;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            ciphertext[j] ^= <span class="number">0x54</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AddRoundKey</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">            *(ciphertext + i) ^= *roundkeys++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; AES_BLOCK_SIZE; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            *(ciphertext + j) ^= xor1[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// last round</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">        *(ciphertext + i) = SBOX[*(ciphertext + i)];</span><br><span class="line">        *(ciphertext + i) ^= <span class="number">0xA1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    shift_rows(ciphertext);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">        *(ciphertext + i) ^= *roundkeys++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; AES_BLOCK_SIZE; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(ciphertext + j) ^= xor1[j];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">aes_decrypt_128</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* roundkeys, <span class="type">const</span> <span class="type">uint8_t</span>* ciphertext, <span class="type">uint8_t</span>* plaintext)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> tmp[<span class="number">16</span>];</span><br><span class="line">    <span class="type">uint8_t</span> t, u, v;</span><br><span class="line">    <span class="type">uint8_t</span> i, j;</span><br><span class="line"></span><br><span class="line">    roundkeys += <span class="number">160</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// first round</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        *(plaintext + i) = *(ciphertext + i) ^ *(roundkeys + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; AES_BLOCK_SIZE; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(plaintext + j) ^= xor1[j];</span><br><span class="line">    &#125;</span><br><span class="line">    roundkeys -= <span class="number">16</span>;</span><br><span class="line">    inv_shift_rows(plaintext);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">        *(plaintext + i)^= <span class="number">0xA1</span>;</span><br><span class="line">        *(plaintext + i) = INV_SBOX[*(plaintext + i)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; AES_ROUNDS; ++j) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Inverse AddRoundKey</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">            *(tmp + i) = *(plaintext + i) ^ *(roundkeys + i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; AES_BLOCK_SIZE; ++j) &#123;</span><br><span class="line"></span><br><span class="line">            *(tmp + j) ^= xor1[j];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Inverse MixColumns</span></span><br><span class="line"><span class="comment">         * [0e 0b 0d 09]   [s0  s4  s8  s12]</span></span><br><span class="line"><span class="comment">         * [09 0e 0b 0d] . [s1  s5  s9  s13]</span></span><br><span class="line"><span class="comment">         * [0d 09 0e 0b]   [s2  s6  s10 s14]</span></span><br><span class="line"><span class="comment">         * [0b 0d 09 0e]   [s3  s7  s11 s15]</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            tmp[j] ^= <span class="number">0x54</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; i += <span class="number">4</span>) &#123;</span><br><span class="line">            t = tmp[i] ^ tmp[i + <span class="number">1</span>] ^ tmp[i + <span class="number">2</span>] ^ tmp[i + <span class="number">3</span>];</span><br><span class="line">            plaintext[i] = t ^ tmp[i] ^ mul2(tmp[i] ^ tmp[i + <span class="number">1</span>]);</span><br><span class="line">            plaintext[i + <span class="number">1</span>] = t ^ tmp[i + <span class="number">1</span>] ^ mul2(tmp[i + <span class="number">1</span>] ^ tmp[i + <span class="number">2</span>]);</span><br><span class="line">            plaintext[i + <span class="number">2</span>] = t ^ tmp[i + <span class="number">2</span>] ^ mul2(tmp[i + <span class="number">2</span>] ^ tmp[i + <span class="number">3</span>]);</span><br><span class="line">            plaintext[i + <span class="number">3</span>] = t ^ tmp[i + <span class="number">3</span>] ^ mul2(tmp[i + <span class="number">3</span>] ^ tmp[i]);</span><br><span class="line">            u = mul2(mul2(tmp[i] ^ tmp[i + <span class="number">2</span>]));</span><br><span class="line">            v = mul2(mul2(tmp[i + <span class="number">1</span>] ^ tmp[i + <span class="number">3</span>]));</span><br><span class="line">            t = mul2(u ^ v);</span><br><span class="line">            plaintext[i] ^= t ^ u;</span><br><span class="line">            plaintext[i + <span class="number">1</span>] ^= t ^ v;</span><br><span class="line">            plaintext[i + <span class="number">2</span>] ^= t ^ u;</span><br><span class="line">            plaintext[i + <span class="number">3</span>] ^= t ^ v;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Inverse ShiftRows</span></span><br><span class="line">        inv_shift_rows(plaintext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Inverse SubBytes</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">            *(plaintext + i) ^= <span class="number">0xA1</span>;</span><br><span class="line">            *(plaintext + i) = INV_SBOX[*(plaintext + i)];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        roundkeys -= <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// last AddRoundKey</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; AES_BLOCK_SIZE; ++i) &#123;</span><br><span class="line">        </span><br><span class="line">        *(plaintext + i) ^= *(roundkeys + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; AES_BLOCK_SIZE; ++j) &#123;</span><br><span class="line"></span><br><span class="line">        *(plaintext + j) ^= xor1[j];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>main.c文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> *</span><br><span class="line"> * Chinese Academy of Sciences</span><br><span class="line"> * State Key Laboratory of Information Security</span><br><span class="line"> * Institute of Information Engineering</span><br><span class="line"> *</span><br><span class="line"> * Copyright (C) 2016 Chinese Academy of Sciences</span><br><span class="line"> *</span><br><span class="line"> * LuoPeng, luopeng@iie.ac.cn</span><br><span class="line"> * Updated in May 2016</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;aes.h&quot;</span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[]) &#123;</span><br><span class="line"></span><br><span class="line">uint8_t i, r;</span><br><span class="line"></span><br><span class="line">/* 128 bit key */</span><br><span class="line">uint8_t key[] = &#123;</span><br><span class="line">//0x0f, 0x15, 0x71, 0xc9, 0x47, 0xd9, 0xe8, 0x59, </span><br><span class="line">//0x0c, 0xb7, 0xad, 0xd6, 0xaf, 0x7f, 0x67, 0x98,</span><br><span class="line">0x67, 0x61, 0x68, 0x34, 0x33, 0x6A, 0x4A, 0x4B, 0x67, 0x66, 0x6A, 0x47, 0x4D, 0x65, 0x41, 0x52</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">uint8_t plaintext[] = &#123;</span><br><span class="line">//0x01, 0x23, 0x45, 0x67, 0x89, 0xab, 0xcd, 0xef,</span><br><span class="line">//0xfe, 0xdc, 0xba, 0x98, 0x76, 0x54, 0x32, 0x10,</span><br><span class="line">0x66,0x6c,0x61,0x67,0x7b,0x52,0x65,0x5f,0x31,0x74,0x73,0x5f,0x66,0x30,0x6e,0x7d</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uint8_t ciphertext[AES_BLOCK_SIZE];</span><br><span class="line"></span><br><span class="line">const uint8_t const_cipher[AES_BLOCK_SIZE] = &#123;</span><br><span class="line">//0xff, 0x0b, 0x84, 0x4a, 0x08, 0x53, 0xbf, 0x7c,</span><br><span class="line">//0x69, 0x34, 0xab, 0x43, 0x64, 0x14, 0x8f, 0xb9,</span><br><span class="line">0xB4, 0x38, 0x36, 0x30, 0x1E, 0x68, 0x48, 0x57, 0x51, 0x01, 0xB7, 0x03, 0x9B, 0x98, 0xE3, 0x7E &#125;;</span><br><span class="line">//74 BA B6 98 4C BE FF 09 46 CC D3 29 7A 21 C3 F7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">printf(&quot;\n--------------------------------------------------------\n&quot;);</span><br><span class="line">printf(&quot;Plain text:\n&quot;);</span><br><span class="line">for (i = 0; i &lt; AES_BLOCK_SIZE; i++) &#123;</span><br><span class="line">printf(&quot;%c&quot;, plaintext[i]);</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;\n\n&quot;);</span><br><span class="line">for (i = 0; i &lt; AES_BLOCK_SIZE; i++) &#123;</span><br><span class="line">printf(&quot;%c&quot;, key[i]);</span><br><span class="line">&#125;</span><br><span class="line">printf(&quot;\n\n&quot;);</span><br><span class="line"></span><br><span class="line">static uint8_t roundkeys[AES_ROUND_KEY_SIZE] = &#123; 0x67, 0x61, 0x68, 0x34, 0x33, 0x6A, 0x4A, 0x4B, 0x67, 0x66, 0x6A, 0x47, 0x4D, 0x65, 0x41, 0x52, 0x2B, 0xE2, 0x68, 0xD7, 0x18, 0x88, 0x22, 0x9C, 0x7F, 0xEE, 0x48, 0xDB, 0x32, 0x8B, 0x09, 0x89, 0x14, 0xE3, 0xCF, 0xF4, 0x0C, 0x6B, 0xED, 0x68, 0x73, 0x85, 0xA5, 0xB3, 0x41, 0x0E, 0xAC, 0x3A, 0xBB, 0x72, 0x4F, 0x77, 0xB7, 0x19, 0xA2, 0x1F, 0xC4, 0x9C, 0x07, 0xAC, 0x85, 0x92, 0xAB, 0x96, 0xFC, 0x10, 0xDF, 0xE0, 0x4B, 0x09, 0x7D, 0xFF, 0x8F, 0x95, 0x7A, 0x53, 0x0A, 0x07, 0xD1, 0xC5, 0x29, 0x2E, 0x79, 0x87, 0x62, 0x27, 0x04, 0x78, 0xED, 0xB2, 0x7E, 0x2B, 0xE7, 0xB5, 0xAF, 0xEE, 0xDC, 0x57, 0x51, 0x13, 0xBE, 0x70, 0x55, 0x6B, 0x53, 0xC2, 0x2B, 0x40, 0xB4, 0x77, 0x84, 0xAE, 0x69, 0x08, 0xB5, 0x9E, 0xD7, 0x78, 0xE0, 0xF5, 0x84, 0xBA, 0xCB, 0xB5, 0x30, 0xCD, 0x4F, 0x1B, 0x54, 0x8C, 0x1A, 0x9A, 0x83, 0xF4, 0xFA, 0x6F, 0x07, 0x4E, 0x31, 0xDA, 0x37, 0x83, 0x7E, 0xC1, 0xA3, 0x7F, 0x62, 0x00, 0x20, 0x8B, 0x98, 0x6F, 0x27, 0xC5, 0xA9, 0xB5, 0x10, 0x46, 0xD7, 0x74, 0xCF, 0x71, 0xF0, 0xCA, 0xEF, 0xFA, 0x68, 0xA5, 0xC8, 0x3F, 0xC1, 0x10, 0xD8, 0x79, 0x16, 0x64 &#125;;</span><br><span class="line">// decryption</span><br><span class="line">aes_decrypt_128(roundkeys, const_cipher, ciphertext);</span><br><span class="line">printf(&quot;Plain text:\n&quot;);</span><br><span class="line">for (i = 0; i &lt; AES_BLOCK_SIZE; i++) &#123;</span><br><span class="line">printf(&quot;%2x &quot;, ciphertext[i]);</span><br><span class="line">&#125;</span><br><span class="line">for (i = 0; i &lt; AES_BLOCK_SIZE; i++) &#123;</span><br><span class="line">if (ciphertext[i] != plaintext[i]) &#123; break; &#125;</span><br><span class="line">&#125;</span><br><span class="line">if (AES_BLOCK_SIZE != i) &#123; printf(&quot;\nDECRYPT WRONG\n\n&quot;); &#125;</span><br><span class="line">else &#123; printf(&quot;\nDECRYPT CORRECT\n\n&quot;); &#125;</span><br><span class="line"></span><br><span class="line">return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/../image/720.png" class="lazyload" data-srcset="/../image/720.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="720"></p><p>总结一下自己这次的过失</p><ul><li>没有注意到TLS，导致自己一直在做调试</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;今日练习一题之AES魔改&lt;/p&gt;
&lt;p&gt;题目链接如下，供各位师傅下载&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://wwb.lanzout.com/iq2Aw20n4ype&quot;&gt;https://wwb.lanzout.com/iq2Aw20n4ype&lt;/a&gt;&lt;br&gt;密码:2</summary>
      
    
    
    
    <category term="逆向" scheme="https://5m10v3.top/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="ctf学习" scheme="https://5m10v3.top/tags/ctf%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>日记(23)</title>
    <link href="https://5m10v3.top/2024/05/12/%E6%97%A5%E8%AE%B0(23)/"/>
    <id>https://5m10v3.top/2024/05/12/%E6%97%A5%E8%AE%B0(23)/</id>
    <published>2024-05-11T16:00:00.000Z</published>
    <updated>2024-06-08T01:50:52.329Z</updated>
    
    <content type="html"><![CDATA[<p>编写那个pe病毒没有成功，主要是在添加完一个新节地址没有对齐<br>感觉这几天都比较浑浑噩噩，不能再这样下去了，要重新振作起来</p><p>感觉对好几个方向都搞的话，更加的迷茫了，目前还是要学一些实际的东西</p><ul><li>LLVM的初步学习</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;编写那个pe病毒没有成功，主要是在添加完一个新节地址没有对齐&lt;br&gt;感觉这几天都比较浑浑噩噩，不能再这样下去了，要重新振作起来&lt;/p&gt;
&lt;p&gt;感觉对好几个方向都搞的话，更加的迷茫了，目前还是要学一些实际的东西&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LLVM的初步学习&lt;/li&gt;
&lt;/ul</summary>
      
    
    
    
    <category term="日记" scheme="https://5m10v3.top/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>PE文件格式解析</title>
    <link href="https://5m10v3.top/2024/05/10/[%E9%80%86%E5%90%91]PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/"/>
    <id>https://5m10v3.top/2024/05/10/[%E9%80%86%E5%90%91]PE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/</id>
    <published>2024-05-09T16:00:00.000Z</published>
    <updated>2024-07-03T12:06:16.844Z</updated>
    
    <content type="html"><![CDATA[<p>下图是PE文件格式示意图<br><img src="/2024/05/10/[逆向]PE文件格式解析/image" class="lazyload" data-srcset="/2024/05/10/[逆向]PE文件格式解析/image" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="  alt="660" style="zoom:67%;" /></p><h2 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h2><p>首先在这里说明一个概念，可执行文件(Executable File)是指可以由操作系统直接加载的文件，在Windows操作系统中可执行文件就是PE文件结构，在Linux下则是ELF文件，我们这里只讨论Windows下的PE文件，要了解PE文件，首先要知道PE格式，那么什么是PE格式呢，既然是一个格式，那肯定是我们都需要遵循的定理</p><p>其实PE格式就是各种结构体的结合，Windows下PE文件的各种结构体在WinNT.h这个头文件中，可以在VS中查询。</p><h3 id="PE文件整体结构"><a href="#PE文件整体结构" class="headerlink" title="PE文件整体结构"></a>PE文件整体结构</h3><p>PE结构可以大致分为:</p><ul><li>DOS部分</li><li>PE文件头</li><li>节表(块表)</li><li>节数据(块数据)</li><li>调试信息</li></ul><h3 id="PE指纹"><a href="#PE指纹" class="headerlink" title="PE指纹"></a>PE指纹</h3><p>PE指纹是什么呢?其实就是跟我们现实生活中的指纹一样，为了识别一些东西，我们可以通过它来判断是否为一个有效的PE文件。</p><p>分析其结构，首先是根据文件的前两个字节是否为4D 5A，也就是’MZ’，然后看第四排四个字节指向的地址00 00 00 f0是否为50 45，也就是’PE’，满足这两个条件也就满足了PE文件的格式.</p><p><img src="/../image/655.png" class="lazyload" data-srcset="/../image/655.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="655"></p><h3 id="DOS部分"><a href="#DOS部分" class="headerlink" title="DOS部分"></a>DOS部分</h3><p>DOS部分主要是为了兼容以前的DOS系统，DOS部分可以分为DOS MZ文件头(IMAGE_DOS_HEADER)和DOS块(DOS Stub)组成，PE文件的第一个字节位于一个传统的MS-DOS头部，称作IMAGE_DOS_HEADER，其结构如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_DOS_HEADER &#123;      // DOS .EXE header</span><br><span class="line">    WORD   e_magic;                     // Magic number</span><br><span class="line">    WORD   e_cblp;                      // Bytes on last page of file</span><br><span class="line">    WORD   e_cp;                        // Pages in file</span><br><span class="line">    WORD   e_crlc;                      // Relocations</span><br><span class="line">    WORD   e_cparhdr;                   // Size of header in paragraphs</span><br><span class="line">    WORD   e_minalloc;                  // Minimum extra paragraphs needed</span><br><span class="line">    WORD   e_maxalloc;                  // Maximum extra paragraphs needed</span><br><span class="line">    WORD   e_ss;                        // Initial (relative) SS value</span><br><span class="line">    WORD   e_sp;                        // Initial SP value</span><br><span class="line">    WORD   e_csum;                      // Checksum</span><br><span class="line">    WORD   e_ip;                        // Initial IP value</span><br><span class="line">    WORD   e_cs;                        // Initial (relative) CS value</span><br><span class="line">    WORD   e_lfarlc;                    // File address of relocation table</span><br><span class="line">    WORD   e_ovno;                      // Overlay number</span><br><span class="line">    WORD   e_res[4];                    // Reserved words</span><br><span class="line">    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)</span><br><span class="line">    WORD   e_oeminfo;                   // OEM information; e_oemid specific</span><br><span class="line">    WORD   e_res2[10];                  // Reserved words</span><br><span class="line">    LONG   e_lfanew;                    // File address of new exe header</span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure><p>我们只需要熟悉的是 e_magic 和 e_lfanew 这两部分，前者是标识PE指纹的一部分，后者则是寻找PE文件头的部分，其它部分全部填0，也不会影响程序运行</p><p><img src="/../image/656.png" class="lazyload" data-srcset="/../image/656.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="656"></p><p>上图是Dos部分</p><p>我们可以看到e_lfanew指向PE文件头，我们可以通过它来寻找PE文件头，而DOS块的部分自然就是PE文件头和DOS MZ文件头中间的部分，这部分是由链接器所写入的，可以随意进行修改，并不影响程序的运行：</p><p><img src="/../image/657.png" class="lazyload" data-srcset="/../image/657.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="657"></p><h3 id="PE文件头"><a href="#PE文件头" class="headerlink" title="PE文件头"></a>PE文件头</h3><p>PE文件头由PE文件头标志，标准PE头，扩展PE头三部分组成。PE文件头标志自然是50 40 00 00，也就是’PE’，我们从结构体的角度看一下PE文件头的详细信息</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line">    DWORD Signature; <span class="comment">//PE文件头标志 =&gt; 4字节</span></span><br><span class="line">    IMAGE_FILE_HEADER FileHeader; <span class="comment">//标准PE头 =&gt; 20字节</span></span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader; <span class="comment">//扩展PE头 =&gt; 32位下224字节(0xE0) 64位下240字节(0xF0)</span></span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure><p><img src="/../image/658.png" class="lazyload" data-srcset="/../image/658.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="658"></p><p>标黄的地方就是pe文件头的位置</p><p>下图划线部分为PE文件标志</p><p><img src="/../image/659.png" class="lazyload" data-srcset="/../image/659.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="659"></p><p>后面二十个字节为PE标准头，一直到10B之前</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class="line">    WORD    Machine; <span class="comment">//可以运行在什么平台上 任意:0 ,Intel 386以及后续:14C x64:8664</span></span><br><span class="line">    WORD    NumberOfSections; <span class="comment">//节的数量</span></span><br><span class="line">    DWORD   TimeDateStamp; <span class="comment">//编译器填写的时间戳</span></span><br><span class="line">    DWORD   PointerToSymbolTable;   <span class="comment">//调试相关</span></span><br><span class="line">    DWORD   NumberOfSymbols; <span class="comment">//调试相关</span></span><br><span class="line">    WORD    SizeOfOptionalHeader;   <span class="comment">//标识扩展PE头大小</span></span><br><span class="line">    WORD    Characteristics;        <span class="comment">//文件属性 =&gt; 16进制转换为2进制根据哪些位有1,可以查看相关属性</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure><p><img src="/../image/661.png" class="lazyload" data-srcset="/../image/661.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="661"></p><p>拓展PE头大小在32位和64位是不一样的，下图为32位系统</p><p><img src="/../image/662.png" class="lazyload" data-srcset="/../image/662.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="662"></p><p>我们可以注意到是0xF0，而32位是0xE0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_OPTIONAL_HEADER &#123;</span><br><span class="line">    //</span><br><span class="line">    // Standard fields.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    WORD    Magic;//PE32: 10B PE64: 20B</span><br><span class="line">    BYTE    MajorLinkerVersion;</span><br><span class="line">    BYTE    MinorLinkerVersion;</span><br><span class="line">    DWORD   SizeOfCode;//所有含有代码的区块的大小 编译器填入 没用(可改)</span><br><span class="line">    DWORD   SizeOfInitializedData;//所有初始化数据区块的大小 编译器填入 没用(可改)</span><br><span class="line">    DWORD   SizeOfUninitializedData;//所有含未初始化数据区块的大小 编译器填入 没用(可改)</span><br><span class="line">    DWORD   AddressOfEntryPoint;//程序入口RVA</span><br><span class="line">    DWORD   BaseOfCode;//代码区块起始RVA</span><br><span class="line">    DWORD   BaseOfData;//数据区块起始RVA</span><br><span class="line"></span><br><span class="line">    //</span><br><span class="line">    // NT additional fields.</span><br><span class="line">    //</span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;//内存镜像基址(程序默认载入基地址)</span><br><span class="line">    DWORD   SectionAlignment; //内存中对齐大小</span><br><span class="line">    DWORD   FileAlignment; //文件中对齐大小(提高程序运行效率)</span><br><span class="line">    WORD    MajorOperatingSystemVersion;</span><br><span class="line">    WORD    MinorOperatingSystemVersion;</span><br><span class="line">    WORD    MajorImageVersion;</span><br><span class="line">    WORD    MinorImageVersion;</span><br><span class="line">    WORD    MajorSubsystemVersion;</span><br><span class="line">    WORD    MinorSubsystemVersion;</span><br><span class="line">    DWORD   Win32VersionValue;</span><br><span class="line">    DWORD   SizeOfImage;//内存中整个PE文件的映射的尺寸,可比实际值大,必须是SectionAlignment的整数倍</span><br><span class="line">    DWORD   SizeOfHeaders; //所有的头加上节表文件对齐之后的值</span><br><span class="line">    DWORD   CheckSum;//映像校验和,一些系统.dll文件有要求,判断是否被修改</span><br><span class="line">    WORD    Subsystem;</span><br><span class="line">    WORD    DllCharacteristics;//文件特性,不是针对DLL文件的,16进制转换2进制可以根据属性对应的表格得到相应的属性</span><br><span class="line">    DWORD   SizeOfStackReserve;</span><br><span class="line">    DWORD   SizeOfStackCommit;</span><br><span class="line">    DWORD   SizeOfHeapReserve;</span><br><span class="line">    DWORD   SizeOfHeapCommit;</span><br><span class="line">    DWORD   LoaderFlags;</span><br><span class="line">    DWORD   NumberOfRvaAndSizes;</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]; //数据目录表,结构体数组</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;</span><br></pre></td></tr></table></figure><p>这里总结一点：程序的真正入口点是 &#x3D; imageBase + AddressEntryPoint</p><h3 id="节表"><a href="#节表" class="headerlink" title="节表"></a>节表</h3><p>节表的结构如下，整体为40个字节</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_SECTION_HEADER &#123;</span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME]; //ASCII字符串 可自定义 只截取8个字节</span><br><span class="line">    union &#123;   //该节在没有对齐之前的真实尺寸,该值可以不准确</span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;</span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;    //内存中的偏移地址</span><br><span class="line">    DWORD   SizeOfRawData;   //节在文件中对齐的尺寸</span><br><span class="line">    DWORD   PointerToRawData;   //节区在文件中的偏移</span><br><span class="line">    DWORD   PointerToRelocations;</span><br><span class="line">    DWORD   PointerToLinenumbers;</span><br><span class="line">    WORD    NumberOfRelocations;</span><br><span class="line">    WORD    NumberOfLinenumbers;</span><br><span class="line">    DWORD   Characteristics;   //节的属性</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure><p>程序中显示如下（蓝色部分）</p><p><img src="/../image/663.png" class="lazyload" data-srcset="/../image/663.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="663"></p><p>得注意的是扩展PE头中的 FileAlignment 以及 SizeOfHeaders 这两个成员，SizeOfHeaders 表示所有的头加上节表文件对齐之后的值，对齐的大小参考的就是 FileAlignment 成员，如果所有的头加上节表的大小为320，FileAlignment 为 200，那么 SizeOfHeaders 大小就为 400，因为是根据FileAlignment 对齐的，这种对齐虽然牺牲了空间，但是可以提高程序运行效率，下图中的前面部分0x00100000就是程序在内存中对齐的大小，也就是程序运行起来时对齐的大小，0x00000400是程序在文件中的对齐大小，也就是没有运行时对齐的大小，需要清楚的是，PE程序在运行时内存中的对齐值和没有运行时的对齐值可能是截然不同的</p><h3 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h3><p>导出表(Import Table)和导入表是靠 IMAGE_DATA_DIRECTORY 这个结构体数组来寻找的，IMAGE_DATA_DIRECTORY 的结构如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_DATA_DIRECTORY &#123;</span><br><span class="line">    DWORD   VirtualAddress;</span><br><span class="line">    DWORD   Size;</span><br><span class="line">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br></pre></td></tr></table></figure><p>导入表的结构如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        DWORD   Characteristics;            // 0 for terminating null import descriptor</span><br><span class="line">        DWORD   OriginalFirstThunk;         // RVA 指向 INT (PIMAGE_THUNK_DATA结构数组)</span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  // 0 if not bound,</span><br><span class="line">                                            // -1 if bound, and real date\time stamp</span><br><span class="line">                                            //     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span><br><span class="line">                                            // O.W. date/time stamp of DLL bound to (Old BIND)</span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 // -1 if no forwarders</span><br><span class="line">    DWORD   Name;//RVA指向dll名字,以0结尾</span><br><span class="line">    DWORD   FirstThunk;                     // RVA 指向 IAT (PIMAGE_THUNK_DATA结构数组)</span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br><span class="line">typedef IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR</span><br></pre></td></tr></table></figure><p>一个程序导入多少库就存在多少个Image_Import_Descripotor结构体.结构体数组最后以NULL结构体结束.</p><p>有以下重要成员(全部都是相对虚拟地址):</p><p><strong>1#.OriginalFirstThunk</strong></p><p><strong>INT</strong>(Import Name Table)的地址.INT中各个元素的值为Image_Import_By_Name<strong>结构体指针.INT和IAT的大小相同,且都是长整型(4字节数据类型)数组.</strong></p><p><strong>2#.Name</strong></p><p><strong>库名称</strong>字符串的<strong>地址</strong>.</p><p><strong>3#.FirstThunk</strong></p><p><strong>IAT</strong>的<strong>地址.</strong></p><p><img src="/../image/664.png" class="lazyload" data-srcset="/../image/664.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="664"></p><p>上图只是PE文件加载前的情况，PE文件一旦运行起来，就会变成下图的情况</p><p><img src="/../image/665.png" class="lazyload" data-srcset="/../image/665.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="665"></p><p>我们还需要了解的结构体是 IMAGE_THUNK_DATA 和 IMAGE_IMPORT_BY_NAME 结构如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_IMPORT_BY_NAME &#123;</span><br><span class="line">    WORD    Hint; //可能为空,编译器决定,如果不为空,是函数在导出表的索引</span><br><span class="line">    BYTE    Name[1]; //函数名称,以0结尾</span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br><span class="line"></span><br><span class="line">#include &quot;pshpack8.h&quot;                       // Use align 8 for the 64-bit IAT.</span><br><span class="line"></span><br><span class="line">typedef struct _IMAGE_THUNK_DATA64 &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        ULONGLONG ForwarderString;  // 指向一个转向者字符串的RVA</span><br><span class="line">        ULONGLONG Function;         // 被输入的函数的内存地址</span><br><span class="line">        ULONGLONG Ordinal;// 被输入API的序数值</span><br><span class="line">        ULONGLONG AddressOfData;    // 指针指向 IMAGE_IMPORT_BY_NAME</span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA64;</span><br><span class="line">typedef IMAGE_THUNK_DATA64 * PIMAGE_THUNK_DATA64;</span><br><span class="line"></span><br><span class="line">#include &quot;poppack.h&quot;                        // Back to 4 byte packing</span><br><span class="line"></span><br><span class="line">typedef struct _IMAGE_THUNK_DATA32 &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        DWORD ForwarderString;      // PBYTE </span><br><span class="line">        DWORD Function;             // PDWORD</span><br><span class="line">        DWORD Ordinal;</span><br><span class="line">        DWORD AddressOfData;        // PIMAGE_IMPORT_BY_NAME</span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA32;</span><br><span class="line">typedef IMAGE_THUNK_DATA32 * PIMAGE_THUNK_DATA32;</span><br></pre></td></tr></table></figure><p>其实他们的作用很明显，就是用来寻找当前的模块依赖哪些函数，可以用这几个结构体求到依赖函数的名字。</p><h3 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h3><p>导出表(Export Table)一般是DLL文件用的比较多，exe文件很少有导出表，导出表的数据结构如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;</span><br><span class="line">    DWORD   Characteristics;</span><br><span class="line">    DWORD   TimeDateStamp;</span><br><span class="line">    WORD    MajorVersion;</span><br><span class="line">    WORD    MinorVersion;</span><br><span class="line">    DWORD   Name;// 指针指向该导出表文件名字符串</span><br><span class="line">    DWORD   Base;// 导出函数起始序号</span><br><span class="line">    DWORD   NumberOfFunctions;// 所有导出函数的个数</span><br><span class="line">    DWORD   NumberOfNames;// 以函数名字导出的函数个数</span><br><span class="line">    DWORD   AddressOfFunctions;     // 指针指向导出函数地址表RVA</span><br><span class="line">    DWORD   AddressOfNames;         // 指针指向导出函数名称表RVA</span><br><span class="line">    DWORD   AddressOfNameOrdinals;  // 指针指向导出函数序号表RVA</span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure><p>可以看到导出表里面最后还有三个表，这三个表可以让我们找到函数真正的地址，在编写PE格式解析器的时候可以用到，AddressOfFunctions 是函数地址表，指向每个函数真正的地址，AddressOfNames 和 AddressOfNameOrdinals 分别是函数名称表和函数序号表，我们知道DLL文件有两种调用方式，一种是用名字，一种是用序号，通过这两个表可以用来寻找函数在 AddressOfFunctions 表中真正的地址。</p><h3 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h3><p>当PE文件被装载到虚拟内存的另一个地址中的时候，也就是载入时不将默认的值作为基地址载入，链接器登记的哪个地址是错误的，需要我们用重定位表来调整，重定位表在数据目录项的第 6 个结构，结构如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_BASE_RELOCATION &#123;</span><br><span class="line">    DWORD   VirtualAddress; // 重定位数据的开始 RVA 地址</span><br><span class="line">    DWORD   SizeOfBlock;// 重定位块的长度</span><br><span class="line">//  WORD    TypeOffset[1];// 重定位项数组</span><br><span class="line">&#125; IMAGE_BASE_RELOCATION;</span><br><span class="line">typedef IMAGE_BASE_RELOCATION UNALIGNED * PIMAGE_BASE_RELOCATION;</span><br></pre></td></tr></table></figure><p>重定位表有许多个，以八个字节的 0 结尾</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从写这个简单PE文件解释器学到了很多好玩的东西</p><ul><li>win32API</li></ul><p>通过编写这个简单的PE文件解释器真的对pe文件的理解更加深了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="comment">//获取虚拟地址的偏移</span></span><br><span class="line">DWORD <span class="title function_">RVAOffset</span><span class="params">(PIMAGE_NT_HEADERS pNtHeader, DWORD Rva)</span></span><br><span class="line">&#123;</span><br><span class="line">PIMAGE_SECTION_HEADER pSectionHeader = (PIMAGE_SECTION_HEADER)IMAGE_FIRST_SECTION(pNtHeader);<span class="comment">//获得首地址</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pNtHeader-&gt;FileHeader.NumberOfSections; i++)</span><br><span class="line">&#123;</span><br><span class="line">DWORD SectionBeginRva = pSectionHeader[i].VirtualAddress;</span><br><span class="line"></span><br><span class="line">DWORD SectionEndRva = pSectionHeader[i].VirtualAddress + pSectionHeader[i].SizeOfRawData;</span><br><span class="line"><span class="keyword">if</span> (Rva &gt;= SectionBeginRva &amp;&amp; Rva &lt;= SectionEndRva)</span><br><span class="line">&#123;</span><br><span class="line">DWORD Temp = Rva - SectionBeginRva;</span><br><span class="line">DWORD Rwa = Temp + pSectionHeader[i].PointerToRawData;<span class="comment">//计算它在节表里面的偏移</span></span><br><span class="line"><span class="keyword">return</span> Rwa;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">HANDLE hFile; <span class="comment">//创造句柄</span></span><br><span class="line">HANDLE hMapping;</span><br><span class="line">LPVOID ImageBase;</span><br><span class="line"><span class="type">char</span> szFilePath[MAX_PATH];</span><br><span class="line">OPENFILENAME ofn;<span class="comment">//定义结构，调用文件对话框选择要分析的文件及其保存路径</span></span><br><span class="line">PIMAGE_DOS_HEADER pDH = <span class="literal">NULL</span>; <span class="comment">//指向IMAGE_DOS结构的指针</span></span><br><span class="line">PIMAGE_NT_HEADERS pNtH = <span class="literal">NULL</span>; <span class="comment">//指向IMAGE_NT结构的指针</span></span><br><span class="line">PIMAGE_FILE_HEADER pFH = <span class="literal">NULL</span>;<span class="comment">//指向IMAGE_FILE结构的指针</span></span><br><span class="line">PIMAGE_OPTIONAL_HEADER pOH = <span class="literal">NULL</span>;<span class="comment">//指向IMAGE_OPTIONAL结构的指针</span></span><br><span class="line">    <span class="built_in">memset</span>(szFilePath, <span class="number">0</span>, MAX_PATH);</span><br><span class="line"><span class="built_in">memset</span>(&amp;ofn, <span class="number">0</span>, <span class="keyword">sizeof</span>(ofn));</span><br><span class="line">ofn.lStructSize = <span class="keyword">sizeof</span>(ofn);</span><br><span class="line">ofn.hwndOwner = <span class="literal">NULL</span>;</span><br><span class="line">ofn.hInstance = GetModuleHandle(<span class="literal">NULL</span>);</span><br><span class="line">ofn.nMaxFile = MAX_PATH;</span><br><span class="line">ofn.lpstrInitialDir = <span class="string">&quot;.&quot;</span>;</span><br><span class="line">ofn.lpstrFile = szFilePath;</span><br><span class="line">ofn.lpstrTitle = <span class="string">&quot;请选择的文件路径&quot;</span>;</span><br><span class="line">ofn.Flags = OFN_FILEMUSTEXIST | OFN_PATHMUSTEXIST | OFN_HIDEREADONLY;</span><br><span class="line">ofn.lpstrFilter = <span class="string">&quot;*.*\0*.*\0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!GetOpenFileName(&amp;ofn))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;打开文件错误:%d\n&quot;</span>, GetLastError());</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">hFile = CreateFile(szFilePath, GENERIC_READ, FILE_SHARE_READ, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!hFile)</span><br><span class="line">&#123;</span><br><span class="line">MessageBox(<span class="literal">NULL</span>,szFilePath,<span class="string">&quot;File opened failed&quot;</span>, MB_OK);</span><br><span class="line">&#125;</span><br><span class="line">hMapping = CreateFileMapping(hFile, <span class="literal">NULL</span>, PAGE_READONLY, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (!hMapping)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;创建映射错误:%d&quot;</span>, GetLastError());</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获得基址</span></span><br><span class="line">ImageBase = MapViewOfFile(hMapping, FILE_MAP_READ, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!ImageBase)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;文件映射错误:%d&quot;</span>, GetLastError());</span><br><span class="line">CloseHandle(hMapping);</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/************************** PE头的判断 *********************************/</span></span><br><span class="line"><span class="keyword">if</span> (!ImageBase)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Not a valid PE file error1!\n&quot;</span>);</span><br><span class="line">CloseHandle(hMapping);</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;&lt;--------------------------PEheader-------------------------------&gt;\n&quot;</span>);</span><br><span class="line">pDH = (PIMAGE_DOS_HEADER)ImageBase;</span><br><span class="line"><span class="keyword">if</span> (pDH-&gt;e_magic != IMAGE_DOS_SIGNATURE) <span class="comment">//判断是否为MZ</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Not a valid PE file error2!\n&quot;</span>);</span><br><span class="line">CloseHandle(hMapping);</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">pNtH = (PIMAGE_NT_HEADERS)((DWORD)pDH + pDH-&gt;e_lfanew);</span><br><span class="line"><span class="keyword">if</span> (pNtH-&gt;Signature != IMAGE_NT_SIGNATURE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Not a valid PE file error3!\n&quot;</span>);</span><br><span class="line">CloseHandle(hMapping);</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;PE e_lfanew is: 0x%x\n&quot;</span>,pNtH);</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*  FileHeader                                */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line">pFH = &amp;pNtH-&gt;FileHeader;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;-----------------FileHeader------------------------\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NumberOfSections:%d\n&quot;</span>, pFH-&gt;NumberOfSections); <span class="comment">//节的数量</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;SizeOfOptionalHeader:%d\n&quot;</span>, pFH-&gt;SizeOfOptionalHeader); <span class="comment">//PE头的大小</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*  OptionalHeader                            */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line">pOH = &amp;pNtH-&gt;OptionalHeader;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;-----------------OptionalHeader---------------------\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;SizeOfCode:0x%08x\n&quot;</span>, pOH-&gt;SizeOfCode);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;AddressOfEntryPoint: 0x%08X\n&quot;</span>, pOH-&gt;AddressOfEntryPoint);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ImageBase is 0x%x\n&quot;</span>, ImageBase);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;SectionAlignment: 0x%08x\n&quot;</span>, pOH-&gt;SectionAlignment);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;FileAlignment: 0x%08x\n&quot;</span>, pOH-&gt;FileAlignment);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;SizeOfImage: 0x%08x\n&quot;</span>, pOH-&gt;SizeOfImage);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;SizeOfHeaders: 0x%08x\n&quot;</span>, pOH-&gt;SizeOfHeaders);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NumberOfRvaAndSizes: 0x%08x\n&quot;</span>, pOH-&gt;NumberOfRvaAndSizes);</span><br><span class="line">    </span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*  SectionTable                              */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="type">int</span> SectionNumber = <span class="number">0</span>;</span><br><span class="line">DWORD SectionHeaderOffset = (DWORD)pNtH + <span class="number">24</span> + (DWORD)pFH-&gt;SizeOfOptionalHeader;<span class="comment">//节表位置的计算</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;--------------------SectionTable---------------------\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (SectionNumber; SectionNumber &lt; pFH-&gt;NumberOfSections; SectionNumber++)</span><br><span class="line">&#123;</span><br><span class="line">PIMAGE_SECTION_HEADER pSh = (PIMAGE_SECTION_HEADER)(SectionHeaderOffset + <span class="number">40</span> * SectionNumber);  <span class="comment">//一个节表大小为40个字节</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d &#x27;s Name is %s\n&quot;</span>, SectionNumber + <span class="number">1</span>, pSh-&gt;Name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;VirtualAddress: 0x%08X\n&quot;</span>, (DWORD)pSh-&gt;VirtualAddress);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;SizeOfRawData: 0x%08X\n&quot;</span>, (DWORD)pSh-&gt;SizeOfRawData);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;PointerToRawData: 0x%08X\n&quot;</span>, (DWORD)pSh-&gt;PointerToRawData);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*  ExportTable                               */</span><span class="comment">//导出表/</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;--------------------ExportTable----------------------\n&quot;</span>);</span><br><span class="line">DWORD Export_table_offset = RVAOffset(pNtH, (DWORD)pNtH-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);</span><br><span class="line">PIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((DWORD)ImageBase + Export_table_offset);</span><br><span class="line">DWORD EXport_table_offset_Name = (DWORD)ImageBase + RVAOffset(pNtH, pExportDirectory-&gt;Name);</span><br><span class="line">DWORD* pNameOfAddress = (DWORD*)((DWORD)ImageBase + RVAOffset(pNtH, pExportDirectory-&gt;AddressOfNames));</span><br><span class="line">DWORD* pFunctionOfAdress = (DWORD*)((DWORD)ImageBase + RVAOffset(pNtH, pExportDirectory-&gt;AddressOfFunctions));</span><br><span class="line">WORD* pNameOrdinalOfAddress = (WORD*)((DWORD)ImageBase + RVAOffset(pNtH, pExportDirectory-&gt;AddressOfNameOrdinals));</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Name:%s\n&quot;</span>, EXport_table_offset_Name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NameOfAddress:%08X\n&quot;</span>, RVAOffset(pNtH, pExportDirectory-&gt;AddressOfNames));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;FunctionOfAdress:%08X\n&quot;</span>, RVAOffset(pNtH, pExportDirectory-&gt;AddressOfFunctions));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NameOrdinalOfAddress:%08X\n&quot;</span>, RVAOffset(pNtH, pExportDirectory-&gt;AddressOfNameOrdinals));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pExportDirectory-&gt;NumberOfFunctions == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;!!!!!!!!!!!!!!!!!NO EXPORT!!!!!!!!!!!!!!!!!!!!!&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (hFile != INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (hMapping != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">CloseHandle(hMapping);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ImageBase != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">UnmapViewOfFile(ImageBase);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NumberOfNames:%d\n&quot;</span>, pExportDirectory-&gt;NumberOfNames);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;NumberOfFunctions:%d\n&quot;</span>, pExportDirectory-&gt;NumberOfFunctions);</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/*  ImportTable                               */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;--------------------ImportTable----------------------\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cont = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">DWORD dwImportOffset = RVAOffset(pNtH, pNtH-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);</span><br><span class="line">dwImportOffset = dwImportOffset + cont;</span><br><span class="line">PIMAGE_IMPORT_DESCRIPTOR pImport = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)ImageBase + dwImportOffset);</span><br><span class="line"><span class="keyword">if</span> (pImport-&gt;OriginalFirstThunk == <span class="number">0</span> &amp;&amp; pImport-&gt;TimeDateStamp == <span class="number">0</span> &amp;&amp; pImport-&gt;ForwarderChain == <span class="number">0</span> &amp;&amp; pImport-&gt;Name == <span class="number">0</span> &amp;&amp; pImport-&gt;FirstThunk == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">DWORD dwOriginalFirstThunk = (DWORD)ImageBase + RVAOffset(pNtH, pImport-&gt;OriginalFirstThunk);</span><br><span class="line">DWORD dwFirstThunk = (DWORD)ImageBase + RVAOffset(pNtH, pImport-&gt;FirstThunk);</span><br><span class="line">DWORD dwName = (DWORD)ImageBase + RVAOffset(pNtH, pImport-&gt;Name);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;---------Import File Name: %s\n&quot;</span>, dwName);</span><br><span class="line"><span class="keyword">if</span> (dwOriginalFirstThunk == <span class="number">0x00000000</span>)</span><br><span class="line">&#123;</span><br><span class="line">dwOriginalFirstThunk = dwFirstThunk;</span><br><span class="line">&#125;</span><br><span class="line">DWORD* pdwTrunkData = (DWORD*)dwOriginalFirstThunk;</span><br><span class="line"><span class="type">int</span> n = <span class="number">0</span>, x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (pdwTrunkData[n] != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">DWORD TrunkData = pdwTrunkData[n];</span><br><span class="line"><span class="keyword">if</span> (TrunkData &lt; IMAGE_ORDINAL_FLAG32)<span class="comment">//名字导入</span></span><br><span class="line">&#123;</span><br><span class="line">PIMAGE_IMPORT_BY_NAME pInportByName = (PIMAGE_IMPORT_BY_NAME)((DWORD)ImageBase + RVAOffset(pNtH, TrunkData));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ImportByName: %s\n&quot;</span>, pInportByName-&gt;Name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">DWORD FunNumber = (DWORD)(TrunkData - IMAGE_ORDINAL_FLAG32);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ImportByNumber: %-4d \n&quot;</span>, FunNumber);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (x != <span class="number">0</span> &amp;&amp; x % <span class="number">3</span> == <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">n++;</span><br><span class="line">x++;</span><br><span class="line">&#125;</span><br><span class="line">cont = cont + <span class="number">40</span>;</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (ImageBase)</span><br><span class="line">&#123;</span><br><span class="line">UnmapViewOfFile(ImageBase);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (hMapping)</span><br><span class="line">&#123;</span><br><span class="line">CloseHandle(hMapping);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (hFile != INVALID_HANDLE_VALUE)</span><br><span class="line">&#123;</span><br><span class="line">CloseHandle(hFile);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果图</p><p><img src="/../image/666.png" class="lazyload" data-srcset="/../image/666.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="666"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;下图是PE文件格式示意图&lt;br&gt;&lt;img src=&quot;/2024/05/10/[逆向]PE文件格式解析/image&quot; class=&quot;lazyload&quot; data-srcset=&quot;/2024/05/10/[逆向]PE文件格式解析/image&quot; srcset=&quot;data:imag</summary>
      
    
    
    
    <category term="PE" scheme="https://5m10v3.top/categories/PE/"/>
    
    
    <category term="ctf学习" scheme="https://5m10v3.top/tags/ctf%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>日记(22)</title>
    <link href="https://5m10v3.top/2024/05/09/%E6%97%A5%E8%AE%B0(22)/"/>
    <id>https://5m10v3.top/2024/05/09/%E6%97%A5%E8%AE%B0(22)/</id>
    <published>2024-05-08T16:00:00.000Z</published>
    <updated>2024-06-09T09:13:54.637Z</updated>
    
    <content type="html"><![CDATA[<p>近期主要在弄ISCC的题目,大约弄了一周时间，从里面的安卓题学到了东西<br>接下来还是想先看完pe型结构和pe型病毒的制作，然后去看LLVM混淆，反调试</p><p>近期小目标：</p><ul><li><del>编写一个pe解析器(1天)</del></li><li>编写一个感染exe的pe型病毒(1天)（这个没有完成）</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;近期主要在弄ISCC的题目,大约弄了一周时间，从里面的安卓题学到了东西&lt;br&gt;接下来还是想先看完pe型结构和pe型病毒的制作，然后去看LLVM混淆，反调试&lt;/p&gt;
&lt;p&gt;近期小目标：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;del&gt;编写一个pe解析器(1天)&lt;/del&gt;&lt;/li&gt;
&lt;l</summary>
      
    
    
    
    <category term="日记" scheme="https://5m10v3.top/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>日记(21)</title>
    <link href="https://5m10v3.top/2024/04/25/%E6%97%A5%E8%AE%B0(21)/"/>
    <id>https://5m10v3.top/2024/04/25/%E6%97%A5%E8%AE%B0(21)/</id>
    <published>2024-04-24T16:00:00.000Z</published>
    <updated>2024-06-09T09:13:49.897Z</updated>
    
    <content type="html"><![CDATA[<p>学习这个pe型病毒，主要目的还是再过一遍PE结构，以及一些win32API的学习</p><p>目前只是了解了这个病毒的原理，还没有具体去写</p><p>学习：</p><ul><li>Win32API的学习</li><li>PE型结构</li></ul><p>但是近期主要还是集中在学习反调试，LLVM混淆</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;学习这个pe型病毒，主要目的还是再过一遍PE结构，以及一些win32API的学习&lt;/p&gt;
&lt;p&gt;目前只是了解了这个病毒的原理，还没有具体去写&lt;/p&gt;
&lt;p&gt;学习：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Win32API的学习&lt;/li&gt;
&lt;li&gt;PE型结构&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;但</summary>
      
    
    
    
    <category term="日记" scheme="https://5m10v3.top/categories/%E6%97%A5%E8%AE%B0/"/>
    
    
    <category term="学习" scheme="https://5m10v3.top/tags/%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>AliyunCTF2023-字节码跳动复现</title>
    <link href="https://5m10v3.top/2024/04/18/AliyunCTF2023-%E5%AD%97%E8%8A%82%E7%A0%81%E8%B7%B3%E5%8A%A8%E5%A4%8D%E7%8E%B0/"/>
    <id>https://5m10v3.top/2024/04/18/AliyunCTF2023-%E5%AD%97%E8%8A%82%E7%A0%81%E8%B7%B3%E5%8A%A8%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-04-17T16:00:00.000Z</published>
    <updated>2024-06-09T09:14:25.494Z</updated>
    
    <content type="html"><![CDATA[<p>复现本题主要是为了学习js字节码，若有不足之处，请各位师傅多多指出</p><p>V8 是 Google 开发的开源 JavaScript 引擎。 Chrome、Node.js和许多其他应用程序都在使用 V8。<br>如果只发布V8引擎编译后的字节码，就可以保护源码。</p><p>可以从下面这篇文章中学习变量声明、条件分支、循环、函数声明、类等最基本语法对应的字节码。</p><p><a href="https://tw.coderbridge.com/series/817c07dc8e1c46f2b0a604b3b4e195c1">https://tw.coderbridge.com/series/817c07dc8e1c46f2b0a604b3b4e195c1</a></p><p>下面这个链接可以当v8的javascript字节码阅读官方文档来用。<br><a href="https://github.com/v8/v8/blob/d84e9496d23cf1dc776ae32199d81accfabaafb5/src/interpreter/interpreter-generator.cc">https://github.com/v8/v8/blob/d84e9496d23cf1dc776ae32199d81accfabaafb5/src/interpreter/interpreter-generator.cc</a></p><h2 id="题目介绍"><a href="#题目介绍" class="headerlink" title="题目介绍"></a>题目介绍</h2><p>根据题目给出的bytecode.txt,分析出来它的加密函数已经字符串的比较</p><h3 id="选手获得的文件"><a href="#选手获得的文件" class="headerlink" title="选手获得的文件"></a>选手获得的文件</h3><ul><li>nodejs 二进制程序</li><li>flagchecker.jsc，js源码通过Bytenode编译后得到的字节码形式，能够正常运行</li><li>flagchecker_bytecode.txt，nodejs运行flagchecker.js时添加 <code>-bytecode</code> 获得的js字节码汇编文本文件。</li><li>runner.js、run.sh，用于引导nodejs运行flagchecker.jsc</li></ul><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>我们可以根据flagchecker.jsc 的运行结果得出返回值</p><p>Right!  or  Wrong!</p><p>然后我们在海量的函数里面就可以定位到一个函数</p><h3 id="Main函数-剖析字节码"><a href="#Main函数-剖析字节码" class="headerlink" title="Main函数-剖析字节码"></a>Main函数-剖析字节码</h3><p>main函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[generated bytecode <span class="keyword">for</span> <span class="attr">function</span>: main (<span class="number">0x3711a3bdfd81</span> &lt;<span class="title class_">SharedFunctionInfo</span> main&gt;)]</span><br><span class="line"><span class="title class_">Bytecode</span> <span class="attr">length</span>: <span class="number">69</span></span><br><span class="line"><span class="title class_">Parameter</span> count <span class="number">1</span></span><br><span class="line"><span class="title class_">Register</span> count <span class="number">4</span></span><br><span class="line"><span class="title class_">Frame</span> size <span class="number">32</span></span><br><span class="line"><span class="variable constant_">OSR</span> nesting <span class="attr">level</span>: <span class="number">0</span></span><br><span class="line"><span class="title class_">Bytecode</span> <span class="title class_">Age</span>: <span class="number">0</span></span><br><span class="line"> <span class="number">1207</span> S&gt; <span class="number">0x3711a3be0a56</span> @    <span class="number">0</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a59</span> @    <span class="number">3</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line"> <span class="number">1215</span> E&gt; <span class="number">0x3711a3be0a5a</span> @    <span class="number">4</span> : 2d f9 <span class="number">01</span> <span class="number">02</span>       <span class="title class_">LdaNamedProperty</span> r1, [<span class="number">1</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a5e</span> @    <span class="number">8</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line">         <span class="number">0x3711a3be0a5f</span> @    <span class="number">9</span> : 0d <span class="number">02</span>             <span class="title class_">LdaSmi</span> [<span class="number">2</span>]</span><br><span class="line"> <span class="number">1219</span> E&gt; <span class="number">0x3711a3be0a61</span> @   <span class="number">11</span> : 2f f9 <span class="number">04</span>          <span class="title class_">LdaKeyedProperty</span> r1, [<span class="number">4</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a64</span> @   <span class="number">14</span> : c3                <span class="title class_">Star0</span> </span><br><span class="line"> <span class="number">1270</span> S&gt; <span class="number">0x3711a3be0a65</span> @   <span class="number">15</span> : <span class="number">96</span> <span class="number">23</span>             <span class="title class_">JumpIfToBooleanFalse</span> [<span class="number">35</span>] (<span class="number">0x3711a3be0a88</span> @ <span class="number">50</span>)</span><br><span class="line">         <span class="number">0x3711a3be0a67</span> @   <span class="number">17</span> : <span class="number">17</span> <span class="number">03</span>             <span class="title class_">LdaImmutableCurrentContextSlot</span> [<span class="number">3</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a69</span> @   <span class="number">19</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line"> <span class="number">1279</span> E&gt; <span class="number">0x3711a3be0a6a</span> @   <span class="number">20</span> : <span class="number">61</span> f9 fa <span class="number">06</span>       <span class="title class_">CallUndefinedReceiver1</span> r1, r0, [<span class="number">6</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a6e</span> @   <span class="number">24</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line">         <span class="number">0x3711a3be0a6f</span> @   <span class="number">25</span> : <span class="number">11</span>                <span class="title class_">LdaTrue</span> </span><br><span class="line"> <span class="number">1286</span> E&gt; <span class="number">0x3711a3be0a70</span> @   <span class="number">26</span> : 6a f9 <span class="number">08</span>          <span class="title class_">TestEqual</span> r1, [<span class="number">8</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a73</span> @   <span class="number">29</span> : <span class="number">98</span> <span class="number">15</span>             <span class="title class_">JumpIfFalse</span> [<span class="number">21</span>] (<span class="number">0x3711a3be0a88</span> @ <span class="number">50</span>)</span><br><span class="line"> <span class="number">1305</span> S&gt; <span class="number">0x3711a3be0a75</span> @   <span class="number">31</span> : <span class="number">21</span> <span class="number">02</span> <span class="number">09</span>          <span class="title class_">LdaGlobal</span> [<span class="number">2</span>], [<span class="number">9</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a78</span> @   <span class="number">34</span> : c1                <span class="title class_">Star2</span> </span><br><span class="line"> <span class="number">1313</span> E&gt; <span class="number">0x3711a3be0a79</span> @   <span class="number">35</span> : 2d f8 <span class="number">03</span> 0b       <span class="title class_">LdaNamedProperty</span> r2, [<span class="number">3</span>], [<span class="number">11</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a7d</span> @   <span class="number">39</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line">         <span class="number">0x3711a3be0a7e</span> @   <span class="number">40</span> : <span class="number">13</span> <span class="number">04</span>             <span class="title class_">LdaConstant</span> [<span class="number">4</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a80</span> @   <span class="number">42</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line"> <span class="number">1313</span> E&gt; <span class="number">0x3711a3be0a81</span> @   <span class="number">43</span> : 5d f9 f8 f7 0d    <span class="title class_">CallProperty1</span> r1, r2, r3, [<span class="number">13</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a86</span> @   <span class="number">48</span> : <span class="number">89</span> <span class="number">13</span>             <span class="title class_">Jump</span> [<span class="number">19</span>] (<span class="number">0x3711a3be0a99</span> @ <span class="number">67</span>)</span><br><span class="line"> <span class="number">1349</span> S&gt; <span class="number">0x3711a3be0a88</span> @   <span class="number">50</span> : <span class="number">21</span> <span class="number">02</span> <span class="number">09</span>          <span class="title class_">LdaGlobal</span> [<span class="number">2</span>], [<span class="number">9</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a8b</span> @   <span class="number">53</span> : c1                <span class="title class_">Star2</span> </span><br><span class="line"> <span class="number">1357</span> E&gt; <span class="number">0x3711a3be0a8c</span> @   <span class="number">54</span> : 2d f8 <span class="number">03</span> 0b       <span class="title class_">LdaNamedProperty</span> r2, [<span class="number">3</span>], [<span class="number">11</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a90</span> @   <span class="number">58</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line">         <span class="number">0x3711a3be0a91</span> @   <span class="number">59</span> : <span class="number">13</span> <span class="number">05</span>             <span class="title class_">LdaConstant</span> [<span class="number">5</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a93</span> @   <span class="number">61</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line"> <span class="number">1357</span> E&gt; <span class="number">0x3711a3be0a94</span> @   <span class="number">62</span> : 5d f9 f8 f7 0f    <span class="title class_">CallProperty1</span> r1, r2, r3, [<span class="number">15</span>]</span><br><span class="line">         <span class="number">0x3711a3be0a99</span> @   <span class="number">67</span> : 0e                <span class="title class_">LdaUndefined</span> </span><br><span class="line"> <span class="number">1378</span> S&gt; <span class="number">0x3711a3be0a9a</span> @   <span class="number">68</span> : a8                <span class="title class_">Return</span> </span><br><span class="line"><span class="title class_">Constant</span> pool (size = <span class="number">6</span>)</span><br><span class="line"><span class="number">0x3711a3be09e1</span>: [<span class="title class_">FixedArray</span>] <span class="keyword">in</span> <span class="title class_">OldSpace</span></span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x2546cb1c12c1</span> &lt;<span class="title class_">Map</span>&gt;</span><br><span class="line"> - <span class="attr">length</span>: <span class="number">6</span></span><br><span class="line">           <span class="number">0</span>: <span class="number">0x39ea5930f9e9</span> &lt;<span class="title class_">String</span>[<span class="number">7</span>]: #process&gt;</span><br><span class="line">           <span class="number">1</span>: <span class="number">0x20e3b754b6d9</span> &lt;<span class="title class_">String</span>[<span class="number">4</span>]: #argv&gt;</span><br><span class="line">           <span class="number">2</span>: <span class="number">0x26784b2e1619</span> &lt;<span class="title class_">String</span>[<span class="number">7</span>]: #<span class="variable language_">console</span>&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x0ef123a28e69</span> &lt;<span class="title class_">String</span>[<span class="number">3</span>]: #log&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x3711a3be0961</span> &lt;<span class="title class_">String</span>[<span class="number">6</span>]: #<span class="title class_">Right</span>!&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x3711a3be0979</span> &lt;<span class="title class_">String</span>[<span class="number">6</span>]: #<span class="title class_">Wrong</span>!&gt;</span><br><span class="line"><span class="title class_">Handler</span> <span class="title class_">Table</span> (size = <span class="number">0</span>)</span><br><span class="line"><span class="title class_">Source</span> <span class="title class_">Position</span> <span class="title class_">Table</span> (size = <span class="number">31</span>)</span><br><span class="line"><span class="number">0x3711a3be0aa1</span> &lt;<span class="title class_">ByteArray</span>[<span class="number">31</span>]&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">LdaGlobal [0], [0]//定义全局变量console 它的第一个参数从Constant pool取,并存储到acc寄存器,acc=global.process</span><br><span class="line">Star1 // r1=acc</span><br><span class="line">LdaNamedProperty r1, [1], [2] //第一个参数表示要作用的对象，第二个参数就是取Constant pool里面的值，第三个参数就是参数的数量</span><br><span class="line">Star1  // r1=global.process.argv</span><br><span class="line">LdaSmi [2] //acc=2</span><br><span class="line">LdaKeyedProperty r1, [4] // acc=global.process.argv[2]</span><br><span class="line">Star0 //r0=acc</span><br><span class="line">JumpIfToBooleanFalse [35] (0x3711a3be0a88 @ 50) //作用是判空，如果结果为false ，就会返回Wrong!</span><br><span class="line">LdaImmutableCurrentContextSlot [3] //调用外部函数</span><br><span class="line">Star1 </span><br><span class="line">CallUndefinedReceiver1 r1, r0, [6]  //调用外部函数 acc=某外部函数</span><br><span class="line">Star1 //r1=acc  </span><br><span class="line">//调用r1，参数个数为1，参数放在r0，即调用某外部函数(global.process.argv[2])</span><br><span class="line">LdaTrue // acc=true</span><br><span class="line">TestEqual r1, [8] // 判断r1是否和acc寄存器相等</span><br><span class="line">JumpIfFalse [21] (0x3711a3be0a88 @ 50)  //如果结果为false ，就会返回Wrong!</span><br><span class="line">//因为上述字节码有个相同的结果，所以在此统一解释一下</span><br><span class="line">1349 S&gt; 0x3711a3be0a88 @   50 : 21 02 09           LdaGlobal [2], [9]</span><br><span class="line">         0x3711a3be0a8b @   53 : c1                Star2 </span><br><span class="line"> 1357 E&gt; 0x3711a3be0a8c @   54 : 2d f8 03 0b       LdaNamedProperty r2, [3], [11]</span><br><span class="line">         0x3711a3be0a90 @   58 : c2                Star1 </span><br><span class="line">         0x3711a3be0a91 @   59 : 13 05             LdaConstant [5]</span><br><span class="line">         0x3711a3be0a93 @   61 : c0                Star3 </span><br><span class="line"> 1357 E&gt; 0x3711a3be0a94 @   62 : 5d f9 f8 f7 0f    CallProperty1 r1, r2, r3, [15]</span><br><span class="line"> 翻译一下就是  :   console.log(&#x27;Wrong!&#x27;) //就是会输出Wrong！</span><br><span class="line"> //下面结构跟上面相似</span><br><span class="line"> 1305 S&gt; 0x3711a3be0a75 @   31 : 21 02 09          LdaGlobal [2], [9]</span><br><span class="line">         0x3711a3be0a78 @   34 : c1                Star2 </span><br><span class="line"> 1313 E&gt; 0x3711a3be0a79 @   35 : 2d f8 03 0b       LdaNamedProperty r2, [3], [11]</span><br><span class="line">         0x3711a3be0a7d @   39 : c2                Star1 </span><br><span class="line">         0x3711a3be0a7e @   40 : 13 04             LdaConstant [4]</span><br><span class="line">         0x3711a3be0a80 @   42 : c0                Star3 </span><br><span class="line"> 1313 E&gt; 0x3711a3be0a81 @   43 : 5d f9 f8 f7 0d    CallProperty1 r1, r2, r3, [13]</span><br><span class="line"> 翻译一下就是   :  console.log(&#x27;Right!&#x27;) //就是会输出Right！</span><br></pre></td></tr></table></figure><p> 可见这个main函数的关键就是外部调用的函数</p><p>我们在海量的函数找到其它两个可以函数 aaa,ccc函数</p><h3 id="aaa函数-剖析字节码"><a href="#aaa函数-剖析字节码" class="headerlink" title="aaa函数-剖析字节码"></a>aaa函数-剖析字节码</h3><p>aaa函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[generated bytecode <span class="keyword">for</span> <span class="attr">function</span>: aaa (<span class="number">0x3711a3bdfd31</span> &lt;<span class="title class_">SharedFunctionInfo</span> aaa&gt;)]</span><br><span class="line"><span class="title class_">Bytecode</span> <span class="attr">length</span>: <span class="number">91</span></span><br><span class="line"><span class="title class_">Parameter</span> count <span class="number">2</span></span><br><span class="line"><span class="title class_">Register</span> count <span class="number">7</span></span><br><span class="line"><span class="title class_">Frame</span> size <span class="number">56</span></span><br><span class="line"><span class="variable constant_">OSR</span> nesting <span class="attr">level</span>: <span class="number">0</span></span><br><span class="line"><span class="title class_">Bytecode</span> <span class="title class_">Age</span>: <span class="number">0</span></span><br><span class="line">  <span class="number">757</span> S&gt; <span class="number">0x3711a3be0cde</span> @    <span class="number">0</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">         <span class="number">0x3711a3be0ce1</span> @    <span class="number">3</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">  <span class="number">768</span> E&gt; <span class="number">0x3711a3be0ce2</span> @    <span class="number">4</span> : 2d f7 <span class="number">01</span> <span class="number">02</span>       <span class="title class_">LdaNamedProperty</span> r3, [<span class="number">1</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be0ce6</span> @    <span class="number">8</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">         <span class="number">0x3711a3be0ce7</span> @    <span class="number">9</span> : 0b f7             <span class="title class_">Ldar</span> r3</span><br><span class="line">  <span class="number">757</span> E&gt; <span class="number">0x3711a3be0ce9</span> @   <span class="number">11</span> : <span class="number">68</span> f7 <span class="number">03</span> <span class="number">01</span> <span class="number">04</span>    <span class="title class_">Construct</span> r3, a0-a0, [<span class="number">4</span>]</span><br><span class="line">         <span class="number">0x3711a3be0cee</span> @   <span class="number">16</span> : c3                <span class="title class_">Star0</span> </span><br><span class="line">  <span class="number">792</span> S&gt; <span class="number">0x3711a3be0cef</span> @   <span class="number">17</span> : 2d fa <span class="number">02</span> <span class="number">06</span>       <span class="title class_">LdaNamedProperty</span> r0, [<span class="number">2</span>], [<span class="number">6</span>]</span><br><span class="line">         <span class="number">0x3711a3be0cf3</span> @   <span class="number">21</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">         <span class="number">0x3711a3be0cf4</span> @   <span class="number">22</span> : 0d 2b             <span class="title class_">LdaSmi</span> [<span class="number">43</span>]</span><br><span class="line">  <span class="number">799</span> E&gt; <span class="number">0x3711a3be0cf6</span> @   <span class="number">24</span> : 6a f7 <span class="number">08</span>          <span class="title class_">TestEqual</span> r3, [<span class="number">8</span>]</span><br><span class="line">         <span class="number">0x3711a3be0cf9</span> @   <span class="number">27</span> : <span class="number">97</span> <span class="number">04</span>             <span class="title class_">JumpIfTrue</span> [<span class="number">4</span>] (<span class="number">0x3711a3be0cfd</span> @ <span class="number">31</span>)</span><br><span class="line">  <span class="number">806</span> S&gt; <span class="number">0x3711a3be0cfb</span> @   <span class="number">29</span> : <span class="number">12</span>                <span class="title class_">LdaFalse</span> </span><br><span class="line">  <span class="number">819</span> S&gt; <span class="number">0x3711a3be0cfc</span> @   <span class="number">30</span> : a8                <span class="title class_">Return</span> </span><br><span class="line">  <span class="number">835</span> S&gt; <span class="number">0x3711a3be0cfd</span> @   <span class="number">31</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d00</span> @   <span class="number">34</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">  <span class="number">846</span> E&gt; <span class="number">0x3711a3be0d01</span> @   <span class="number">35</span> : 2d f7 <span class="number">03</span> <span class="number">09</span>       <span class="title class_">LdaNamedProperty</span> r3, [<span class="number">3</span>], [<span class="number">9</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d05</span> @   <span class="number">39</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">         <span class="number">0x3711a3be0d06</span> @   <span class="number">40</span> : 0d 2b             <span class="title class_">LdaSmi</span> [<span class="number">43</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d08</span> @   <span class="number">42</span> : bf                <span class="title class_">Star4</span> </span><br><span class="line">         <span class="number">0x3711a3be0d09</span> @   <span class="number">43</span> : 0b f7             <span class="title class_">Ldar</span> r3</span><br><span class="line">  <span class="number">835</span> E&gt; <span class="number">0x3711a3be0d0b</span> @   <span class="number">45</span> : <span class="number">68</span> f7 f6 <span class="number">01</span> 0b    <span class="title class_">Construct</span> r3, r4-r4, [<span class="number">11</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d10</span> @   <span class="number">50</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line">  <span class="number">942</span> S&gt; <span class="number">0x3711a3be0d11</span> @   <span class="number">51</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d14</span> @   <span class="number">54</span> : bf                <span class="title class_">Star4</span> </span><br><span class="line">  <span class="number">949</span> E&gt; <span class="number">0x3711a3be0d15</span> @   <span class="number">55</span> : 2d f6 <span class="number">01</span> <span class="number">02</span>       <span class="title class_">LdaNamedProperty</span> r4, [<span class="number">1</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d19</span> @   <span class="number">59</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">         <span class="number">0x3711a3be0d1a</span> @   <span class="number">60</span> : <span class="number">13</span> <span class="number">04</span>             <span class="title class_">LdaConstant</span> [<span class="number">4</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d1c</span> @   <span class="number">62</span> : be                <span class="title class_">Star5</span> </span><br><span class="line">         <span class="number">0x3711a3be0d1d</span> @   <span class="number">63</span> : <span class="number">13</span> <span class="number">05</span>             <span class="title class_">LdaConstant</span> [<span class="number">5</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d1f</span> @   <span class="number">65</span> : bd                <span class="title class_">Star6</span> </span><br><span class="line">  <span class="number">949</span> E&gt; <span class="number">0x3711a3be0d20</span> @   <span class="number">66</span> : 5e f7 f6 f5 f4 0d <span class="title class_">CallProperty2</span> r3, r4, r5, r6, [<span class="number">13</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d26</span> @   <span class="number">72</span> : c1                <span class="title class_">Star2</span> </span><br><span class="line"> <span class="number">1056</span> S&gt; <span class="number">0x3711a3be0d27</span> @   <span class="number">73</span> : <span class="number">17</span> <span class="number">02</span>             <span class="title class_">LdaImmutableCurrentContextSlot</span> [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be0d29</span> @   <span class="number">75</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">         <span class="number">0x3711a3be0d2a</span> @   <span class="number">76</span> : <span class="number">19</span> fa f6          <span class="title class_">Mov</span> r0, r4</span><br><span class="line">         <span class="number">0x3711a3be0d2d</span> @   <span class="number">79</span> : <span class="number">19</span> f9 f5          <span class="title class_">Mov</span> r1, r5</span><br><span class="line">         <span class="number">0x3711a3be0d30</span> @   <span class="number">82</span> : <span class="number">19</span> f8 f4          <span class="title class_">Mov</span> r2, r6</span><br><span class="line"> <span class="number">1063</span> E&gt; <span class="number">0x3711a3be0d33</span> @   <span class="number">85</span> : 5f f7 f6 <span class="number">03</span> 0f    <span class="title class_">CallUndefinedReceiver</span> r3, r4-r6, [<span class="number">15</span>]</span><br><span class="line"> <span class="number">1087</span> S&gt; <span class="number">0x3711a3be0d38</span> @   <span class="number">90</span> : a8                <span class="title class_">Return</span> </span><br><span class="line"><span class="title class_">Constant</span> pool (size = <span class="number">6</span>)</span><br><span class="line"><span class="number">0x3711a3be0c69</span>: [<span class="title class_">FixedArray</span>] <span class="keyword">in</span> <span class="title class_">OldSpace</span></span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x2546cb1c12c1</span> &lt;<span class="title class_">Map</span>&gt;</span><br><span class="line"> - <span class="attr">length</span>: <span class="number">6</span></span><br><span class="line">           <span class="number">0</span>: <span class="number">0x3adf78836561</span> &lt;<span class="title class_">String</span>[<span class="number">6</span>]: #<span class="title class_">Buffer</span>&gt;</span><br><span class="line">           <span class="number">1</span>: <span class="number">0x2546cb1c4999</span> &lt;<span class="title class_">String</span>[<span class="number">4</span>]: #<span class="keyword">from</span>&gt;</span><br><span class="line">           <span class="number">2</span>: <span class="number">0x2546cb1c4d41</span> &lt;<span class="title class_">String</span>[<span class="number">6</span>]: #length&gt;</span><br><span class="line">           <span class="number">3</span>: <span class="number">0x3adf78836c31</span> &lt;<span class="title class_">String</span>[<span class="number">5</span>]: #alloc&gt;</span><br><span class="line">           <span class="number">4</span>: <span class="number">0x3711a3be0bb1</span> &lt;<span class="title class_">String</span>[<span class="number">86</span>]: #3edd7925cd6e04ab44f25bef57bc53bd20b74b8c11f893090fdcdfddad0709100100fe6a9230333234fbae&gt;</span><br><span class="line">           <span class="number">5</span>: <span class="number">0x3adf78838741</span> &lt;<span class="title class_">String</span>[<span class="number">3</span>]: #hex&gt;</span><br><span class="line"><span class="title class_">Handler</span> <span class="title class_">Table</span> (size = <span class="number">0</span>)</span><br><span class="line"><span class="title class_">Source</span> <span class="title class_">Position</span> <span class="title class_">Table</span> (size = <span class="number">38</span>)</span><br><span class="line"><span class="number">0x3711a3be0d41</span> &lt;<span class="title class_">ByteArray</span>[<span class="number">38</span>]&gt;</span><br></pre></td></tr></table></figure><p>由于上面的简单铺垫，接下来我们将快速且简洁地分析</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">LdaGlobal [0], [0]</span><br><span class="line">Star3  // r3 =Buffer  </span><br><span class="line">LdaNamedProperty r3, [1], [2]</span><br><span class="line">Star3  //r3=Buffer.from</span><br><span class="line">Ldar r3  //acc=r3=Buffer.from</span><br><span class="line">Construct r3, a0-a0, [4] //文档的意思是创建 r3 这个函数 ，然后参数是 a0</span><br><span class="line">Star0 //r0= new Buffer.from(a0)</span><br><span class="line">//猜测此处的a0就是main传进来的用户输入。姑且称为input。</span><br><span class="line">LdaNamedProperty r0, [2], [6]</span><br><span class="line">Star3 // r3= input.length</span><br><span class="line">LdaSmi [43] // acc=43</span><br><span class="line">TestEqual r3, [8]  // if input.length == 43</span><br><span class="line">JumpIfTrue [4] (0x3711a3be0cfd @ 31) //如果返回True </span><br><span class="line">LdaFalse //acc=False</span><br><span class="line">Return //返回</span><br><span class="line">LdaGlobal [0], [0] // acc =Buffer</span><br><span class="line">Star3 //r3=acc=Buffer</span><br><span class="line"> 846 E&gt; 0x3711a3be0d01 @   35 : 2d f7 03 09       LdaNamedProperty r3, [3], [9]</span><br><span class="line">        0x3711a3be0d05 @   39 : c0                Star3 </span><br><span class="line">        0x3711a3be0d06 @   40 : 0d 2b             LdaSmi [43]</span><br><span class="line">        0x3711a3be0d08 @   42 : bf                Star4 </span><br><span class="line">        0x3711a3be0d09 @   43 : 0b f7             Ldar r3</span><br><span class="line"> 835 E&gt; 0x3711a3be0d0b @   45 : 68 f7 f6 01 0b    Construct r3, r4-r4, [11]</span><br><span class="line">        0x3711a3be0d10 @   50 : c2                Star1 </span><br><span class="line">//这个函数 翻译一下就是 r1=new Buffer.alloc(43)    </span><br><span class="line">LdaSmi [43]</span><br><span class="line">Star4  //r4 =Buffer</span><br><span class="line">LdaNamedProperty r4, [1], [2]</span><br><span class="line">Star3 //r3=Buffer.from</span><br><span class="line">LdaConstant [4]</span><br><span class="line">Star5 //r5 = &#x27;3edd7925cd6e04ab44f25bef57bc53bd20b74b8c11f893090fdcdfddad0709100100fe6a9230333234fbae&#x27;</span><br><span class="line">LdaConstant [5]</span><br><span class="line">Star6  r6 = hex</span><br><span class="line">CallProperty2 r3, r4, r5, r6, [13]</span><br><span class="line">Star2 //r2=Buffer.from(r5,hex)</span><br><span class="line">LdaImmutableCurrentContextSlot [2]</span><br><span class="line">Star3 //r3=外部函数</span><br><span class="line">Mov r0, r4 // r4=r0</span><br><span class="line">Mov r1, r5 // r5=r1</span><br><span class="line">Mov r2, r6 // r6=r2</span><br><span class="line">CallUndefinedReceiver r3, r4-r6, [15]</span><br><span class="line">Return  //return r3(r4,r5,r6)</span><br></pre></td></tr></table></figure><p>经过剖析我们可以得知，aaa这个函数更像一个初始化的函数，那么看来这个外部函数才是加密的关键</p><h3 id="ccc函数-剖析字节码"><a href="#ccc函数-剖析字节码" class="headerlink" title="ccc函数-剖析字节码"></a>ccc函数-剖析字节码</h3><p>ccc函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[generated bytecode <span class="keyword">for</span> <span class="attr">function</span>: ccc (<span class="number">0x3711a3bdfce1</span> &lt;<span class="title class_">SharedFunctionInfo</span> ccc&gt;)]</span><br><span class="line"><span class="title class_">Bytecode</span> <span class="attr">length</span>: <span class="number">188</span></span><br><span class="line"><span class="title class_">Parameter</span> count <span class="number">4</span></span><br><span class="line"><span class="title class_">Register</span> count <span class="number">4</span></span><br><span class="line"><span class="title class_">Frame</span> size <span class="number">32</span></span><br><span class="line"><span class="variable constant_">OSR</span> nesting <span class="attr">level</span>: <span class="number">0</span></span><br><span class="line"><span class="title class_">Bytecode</span> <span class="title class_">Age</span>: <span class="number">0</span></span><br><span class="line">  <span class="number">173</span> S&gt; <span class="number">0x3711a3be1216</span> @    <span class="number">0</span> : <span class="number">00</span> 0d aa <span class="number">00</span>       <span class="title class_">LdaSmi</span>.<span class="property">Wide</span> [<span class="number">170</span>]</span><br><span class="line">         <span class="number">0x3711a3be121a</span> @    <span class="number">4</span> : c3                <span class="title class_">Star0</span> </span><br><span class="line">  <span class="number">188</span> S&gt; <span class="number">0x3711a3be121b</span> @    <span class="number">5</span> : 0c                <span class="title class_">LdaZero</span> </span><br><span class="line">  <span class="number">189</span> E&gt; <span class="number">0x3711a3be121c</span> @    <span class="number">6</span> : <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">StaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">  <span class="number">194</span> S&gt; <span class="number">0x3711a3be121f</span> @    <span class="number">9</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be1222</span> @   <span class="number">12</span> : c1                <span class="title class_">Star2</span> </span><br><span class="line">         <span class="number">0x3711a3be1223</span> @   <span class="number">13</span> : 0d <span class="number">13</span>             <span class="title class_">LdaSmi</span> [<span class="number">19</span>]</span><br><span class="line">  <span class="number">194</span> E&gt; <span class="number">0x3711a3be1225</span> @   <span class="number">15</span> : 6c f8 <span class="number">04</span>          <span class="title class_">TestLessThan</span> r2, [<span class="number">4</span>]</span><br><span class="line">         <span class="number">0x3711a3be1228</span> @   <span class="number">18</span> : <span class="number">98</span> 2a             <span class="title class_">JumpIfFalse</span> [<span class="number">42</span>] (<span class="number">0x3711a3be1252</span> @ <span class="number">60</span>)</span><br><span class="line">  <span class="number">274</span> S&gt; <span class="number">0x3711a3be122a</span> @   <span class="number">20</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">  <span class="number">273</span> E&gt; <span class="number">0x3711a3be122d</span> @   <span class="number">23</span> : 2f <span class="number">03</span> <span class="number">06</span>          <span class="title class_">LdaKeyedProperty</span> a0, [<span class="number">6</span>]</span><br><span class="line">  <span class="number">265</span> E&gt; <span class="number">0x3711a3be1230</span> @   <span class="number">26</span> : <span class="number">38</span> fa <span class="number">08</span>          <span class="title class_">Add</span> r0, [<span class="number">8</span>]</span><br><span class="line">  <span class="number">277</span> E&gt; <span class="number">0x3711a3be1233</span> @   <span class="number">29</span> : <span class="number">44</span> <span class="number">33</span> <span class="number">09</span>          <span class="title class_">AddSmi</span> [<span class="number">51</span>], [<span class="number">9</span>]</span><br><span class="line">  <span class="number">285</span> E&gt; <span class="number">0x3711a3be1236</span> @   <span class="number">32</span> : <span class="number">00</span> 4c ff <span class="number">00</span> <span class="number">05</span> <span class="number">00</span> <span class="title class_">BitwiseAndSmi</span>.<span class="property">Wide</span> [<span class="number">255</span>], [<span class="number">5</span>]</span><br><span class="line">         <span class="number">0x3711a3be123c</span> @   <span class="number">38</span> : c3                <span class="title class_">Star0</span> </span><br><span class="line">  <span class="number">305</span> S&gt; <span class="number">0x3711a3be123d</span> @   <span class="number">39</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be1240</span> @   <span class="number">42</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">         <span class="number">0x3711a3be1241</span> @   <span class="number">43</span> : 0b fa             <span class="title class_">Ldar</span> r0</span><br><span class="line">  <span class="number">308</span> E&gt; <span class="number">0x3711a3be1243</span> @   <span class="number">45</span> : <span class="number">34</span> <span class="number">04</span> f7 0a       <span class="title class_">StaKeyedProperty</span> a1, r3, [<span class="number">10</span>]</span><br><span class="line">  <span class="number">200</span> S&gt; <span class="number">0x3711a3be1247</span> @   <span class="number">49</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be124a</span> @   <span class="number">52</span> : <span class="number">50</span> 0c             <span class="title class_">Inc</span> [<span class="number">12</span>]</span><br><span class="line">  <span class="number">200</span> E&gt; <span class="number">0x3711a3be124c</span> @   <span class="number">54</span> : <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">StaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">  <span class="number">183</span> E&gt; <span class="number">0x3711a3be124f</span> @   <span class="number">57</span> : <span class="number">88</span> <span class="number">30</span> <span class="number">00</span>          <span class="title class_">JumpLoop</span> [<span class="number">48</span>], [<span class="number">0</span>] (<span class="number">0x3711a3be121f</span> @ <span class="number">9</span>)</span><br><span class="line">  <span class="number">337</span> S&gt; <span class="number">0x3711a3be1252</span> @   <span class="number">60</span> : 0d <span class="number">55</span>             <span class="title class_">LdaSmi</span> [<span class="number">85</span>]</span><br><span class="line">         <span class="number">0x3711a3be1254</span> @   <span class="number">62</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line">  <span class="number">352</span> S&gt; <span class="number">0x3711a3be1255</span> @   <span class="number">63</span> : 0d <span class="number">13</span>             <span class="title class_">LdaSmi</span> [<span class="number">19</span>]</span><br><span class="line">  <span class="number">353</span> E&gt; <span class="number">0x3711a3be1257</span> @   <span class="number">65</span> : <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">StaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">  <span class="number">359</span> S&gt; <span class="number">0x3711a3be125a</span> @   <span class="number">68</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be125d</span> @   <span class="number">71</span> : c1                <span class="title class_">Star2</span> </span><br><span class="line">         <span class="number">0x3711a3be125e</span> @   <span class="number">72</span> : 0d 2b             <span class="title class_">LdaSmi</span> [<span class="number">43</span>]</span><br><span class="line">  <span class="number">359</span> E&gt; <span class="number">0x3711a3be1260</span> @   <span class="number">74</span> : 6c f8 0d          <span class="title class_">TestLessThan</span> r2, [<span class="number">13</span>]</span><br><span class="line">         <span class="number">0x3711a3be1263</span> @   <span class="number">77</span> : <span class="number">98</span> <span class="number">34</span>             <span class="title class_">JumpIfFalse</span> [<span class="number">52</span>] (<span class="number">0x3711a3be1297</span> @ <span class="number">129</span>)</span><br><span class="line">  <span class="number">383</span> S&gt; <span class="number">0x3711a3be1265</span> @   <span class="number">79</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be1268</span> @   <span class="number">82</span> : c0                <span class="title class_">Star3</span> </span><br><span class="line">  <span class="number">403</span> E&gt; <span class="number">0x3711a3be1269</span> @   <span class="number">83</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">  <span class="number">402</span> E&gt; <span class="number">0x3711a3be126c</span> @   <span class="number">86</span> : 2f <span class="number">03</span> <span class="number">10</span>          <span class="title class_">LdaKeyedProperty</span> a0, [<span class="number">16</span>]</span><br><span class="line">  <span class="number">394</span> E&gt; <span class="number">0x3711a3be126f</span> @   <span class="number">89</span> : <span class="number">38</span> f9 0f          <span class="title class_">Add</span> r1, [<span class="number">15</span>]</span><br><span class="line">  <span class="number">407</span> E&gt; <span class="number">0x3711a3be1272</span> @   <span class="number">92</span> : <span class="number">00</span> 4c ff <span class="number">00</span> 0e <span class="number">00</span> <span class="title class_">BitwiseAndSmi</span>.<span class="property">Wide</span> [<span class="number">255</span>], [<span class="number">14</span>]</span><br><span class="line">  <span class="number">386</span> E&gt; <span class="number">0x3711a3be1278</span> @   <span class="number">98</span> : <span class="number">34</span> <span class="number">04</span> f7 <span class="number">12</span>       <span class="title class_">StaKeyedProperty</span> a1, r3, [<span class="number">18</span>]</span><br><span class="line">  <span class="number">442</span> S&gt; <span class="number">0x3711a3be127c</span> @  <span class="number">102</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">  <span class="number">441</span> E&gt; <span class="number">0x3711a3be127f</span> @  <span class="number">105</span> : 2f <span class="number">04</span> <span class="number">16</span>          <span class="title class_">LdaKeyedProperty</span> a1, [<span class="number">22</span>]</span><br><span class="line">  <span class="number">436</span> E&gt; <span class="number">0x3711a3be1282</span> @  <span class="number">108</span> : 3f f9 <span class="number">15</span>          <span class="title class_">BitwiseXor</span> r1, [<span class="number">21</span>]</span><br><span class="line">  <span class="number">446</span> E&gt; <span class="number">0x3711a3be1285</span> @  <span class="number">111</span> : <span class="number">00</span> 4c ff <span class="number">00</span> <span class="number">14</span> <span class="number">00</span> <span class="title class_">BitwiseAndSmi</span>.<span class="property">Wide</span> [<span class="number">255</span>], [<span class="number">20</span>]</span><br><span class="line">         <span class="number">0x3711a3be128b</span> @  <span class="number">117</span> : c2                <span class="title class_">Star1</span> </span><br><span class="line">  <span class="number">365</span> S&gt; <span class="number">0x3711a3be128c</span> @  <span class="number">118</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be128f</span> @  <span class="number">121</span> : <span class="number">50</span> <span class="number">18</span>             <span class="title class_">Inc</span> [<span class="number">24</span>]</span><br><span class="line">  <span class="number">365</span> E&gt; <span class="number">0x3711a3be1291</span> @  <span class="number">123</span> : <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">StaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">  <span class="number">347</span> E&gt; <span class="number">0x3711a3be1294</span> @  <span class="number">126</span> : <span class="number">88</span> 3a <span class="number">00</span>          <span class="title class_">JumpLoop</span> [<span class="number">58</span>], [<span class="number">0</span>] (<span class="number">0x3711a3be125a</span> @ <span class="number">68</span>)</span><br><span class="line">  <span class="number">531</span> S&gt; <span class="number">0x3711a3be1297</span> @  <span class="number">129</span> : <span class="number">00</span> 0d 9f <span class="number">00</span>       <span class="title class_">LdaSmi</span>.<span class="property">Wide</span> [<span class="number">159</span>]</span><br><span class="line">  <span class="number">540</span> E&gt; <span class="number">0x3711a3be129b</span> @  <span class="number">133</span> : 6a f9 <span class="number">19</span>          <span class="title class_">TestEqual</span> r1, [<span class="number">25</span>]</span><br><span class="line">         <span class="number">0x3711a3be129e</span> @  <span class="number">136</span> : <span class="number">98</span> <span class="number">32</span>             <span class="title class_">JumpIfFalse</span> [<span class="number">50</span>] (<span class="number">0x3711a3be12d0</span> @ <span class="number">186</span>)</span><br><span class="line">  <span class="number">563</span> S&gt; <span class="number">0x3711a3be12a0</span> @  <span class="number">138</span> : 0c                <span class="title class_">LdaZero</span> </span><br><span class="line">  <span class="number">564</span> E&gt; <span class="number">0x3711a3be12a1</span> @  <span class="number">139</span> : <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">StaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">  <span class="number">569</span> S&gt; <span class="number">0x3711a3be12a4</span> @  <span class="number">142</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be12a7</span> @  <span class="number">145</span> : c1                <span class="title class_">Star2</span> </span><br><span class="line">         <span class="number">0x3711a3be12a8</span> @  <span class="number">146</span> : 0d 2b             <span class="title class_">LdaSmi</span> [<span class="number">43</span>]</span><br><span class="line">  <span class="number">569</span> E&gt; <span class="number">0x3711a3be12aa</span> @  <span class="number">148</span> : 6c f8 1a          <span class="title class_">TestLessThan</span> r2, [<span class="number">26</span>]</span><br><span class="line">         <span class="number">0x3711a3be12ad</span> @  <span class="number">151</span> : <span class="number">98</span> <span class="number">21</span>             <span class="title class_">JumpIfFalse</span> [<span class="number">33</span>] (<span class="number">0x3711a3be12ce</span> @ <span class="number">184</span>)</span><br><span class="line">  <span class="number">604</span> S&gt; <span class="number">0x3711a3be12af</span> @  <span class="number">153</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">  <span class="number">603</span> E&gt; <span class="number">0x3711a3be12b2</span> @  <span class="number">156</span> : 2f <span class="number">05</span> 1b          <span class="title class_">LdaKeyedProperty</span> a2, [<span class="number">27</span>]</span><br><span class="line">         <span class="number">0x3711a3be12b5</span> @  <span class="number">159</span> : c1                <span class="title class_">Star2</span> </span><br><span class="line">  <span class="number">614</span> E&gt; <span class="number">0x3711a3be12b6</span> @  <span class="number">160</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">  <span class="number">613</span> E&gt; <span class="number">0x3711a3be12b9</span> @  <span class="number">163</span> : 2f <span class="number">04</span> 1d          <span class="title class_">LdaKeyedProperty</span> a1, [<span class="number">29</span>]</span><br><span class="line">  <span class="number">607</span> E&gt; <span class="number">0x3711a3be12bc</span> @  <span class="number">166</span> : 6a f8 1f          <span class="title class_">TestEqual</span> r2, [<span class="number">31</span>]</span><br><span class="line">         <span class="number">0x3711a3be12bf</span> @  <span class="number">169</span> : <span class="number">97</span> <span class="number">04</span>             <span class="title class_">JumpIfTrue</span> [<span class="number">4</span>] (<span class="number">0x3711a3be12c3</span> @ <span class="number">173</span>)</span><br><span class="line">  <span class="number">636</span> S&gt; <span class="number">0x3711a3be12c1</span> @  <span class="number">171</span> : <span class="number">12</span>                <span class="title class_">LdaFalse</span> </span><br><span class="line">  <span class="number">649</span> S&gt; <span class="number">0x3711a3be12c2</span> @  <span class="number">172</span> : a8                <span class="title class_">Return</span> </span><br><span class="line">  <span class="number">575</span> S&gt; <span class="number">0x3711a3be12c3</span> @  <span class="number">173</span> : <span class="number">21</span> <span class="number">00</span> <span class="number">02</span>          <span class="title class_">LdaGlobal</span> [<span class="number">0</span>], [<span class="number">2</span>]</span><br><span class="line">         <span class="number">0x3711a3be12c6</span> @  <span class="number">176</span> : <span class="number">50</span> <span class="number">20</span>             <span class="title class_">Inc</span> [<span class="number">32</span>]</span><br><span class="line">  <span class="number">575</span> E&gt; <span class="number">0x3711a3be12c8</span> @  <span class="number">178</span> : <span class="number">23</span> <span class="number">00</span> <span class="number">00</span>          <span class="title class_">StaGlobal</span> [<span class="number">0</span>], [<span class="number">0</span>]</span><br><span class="line">  <span class="number">558</span> E&gt; <span class="number">0x3711a3be12cb</span> @  <span class="number">181</span> : <span class="number">88</span> <span class="number">27</span> <span class="number">00</span>          <span class="title class_">JumpLoop</span> [<span class="number">39</span>], [<span class="number">0</span>] (<span class="number">0x3711a3be12a4</span> @ <span class="number">142</span>)</span><br><span class="line">  <span class="number">682</span> S&gt; <span class="number">0x3711a3be12ce</span> @  <span class="number">184</span> : <span class="number">11</span>                <span class="title class_">LdaTrue</span> </span><br><span class="line">  <span class="number">694</span> S&gt; <span class="number">0x3711a3be12cf</span> @  <span class="number">185</span> : a8                <span class="title class_">Return</span> </span><br><span class="line">  <span class="number">705</span> S&gt; <span class="number">0x3711a3be12d0</span> @  <span class="number">186</span> : <span class="number">12</span>                <span class="title class_">LdaFalse</span> </span><br><span class="line">  <span class="number">718</span> S&gt; <span class="number">0x3711a3be12d1</span> @  <span class="number">187</span> : a8                <span class="title class_">Return</span> </span><br><span class="line"><span class="title class_">Constant</span> pool (size = <span class="number">1</span>)</span><br><span class="line"><span class="number">0x3711a3be11c9</span>: [<span class="title class_">FixedArray</span>] <span class="keyword">in</span> <span class="title class_">OldSpace</span></span><br><span class="line"> - <span class="attr">map</span>: <span class="number">0x2546cb1c12c1</span> &lt;<span class="title class_">Map</span>&gt;</span><br><span class="line"> - <span class="attr">length</span>: <span class="number">1</span></span><br><span class="line">           <span class="number">0</span>: <span class="number">0x2546cb1c9159</span> &lt;<span class="title class_">String</span>[<span class="number">1</span>]: #i&gt;</span><br><span class="line"><span class="title class_">Handler</span> <span class="title class_">Table</span> (size = <span class="number">0</span>)</span><br><span class="line"><span class="title class_">Source</span> <span class="title class_">Position</span> <span class="title class_">Table</span> (size = <span class="number">119</span>)</span><br><span class="line"><span class="number">0x3711a3be12d9</span> &lt;<span class="title class_">ByteArray</span>[<span class="number">119</span>]&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">LdaSmi.Wide [170]</span><br><span class="line">Star0 //r0=170 </span><br><span class="line">LdaZero //acc=0</span><br><span class="line">StaGlobal [0], [0]</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Star2 //r2=i</span><br><span class="line">LdaSmi [19]//acc=19</span><br><span class="line">TestLessThan r2, [4] // if i &lt;19</span><br><span class="line">JumpIfFalse [42] (0x3711a3be1252 @ 60) // 如果返回False 就跳到60</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">LdaKeyedProperty a0,[6] //acc=a0[i]</span><br><span class="line">Add r0, [8]//acc+=r0</span><br><span class="line">AddSmi [51], [9] //acc+=51</span><br><span class="line">BitwiseAndSmi.Wide [255], [5] //acc&amp;=0xff</span><br><span class="line">Star0 //r0=acc</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Star3  //r3=i</span><br><span class="line">Ldar r0 //acc=r0</span><br><span class="line">StaKeyedProperty a1, r3, [10] //这个就类似于python里面的键值对 a1[a3]=acc （即a1[i]=acc）</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Inc [12]//i+=1</span><br><span class="line">StaGlobal [0], [0]</span><br><span class="line">JumpLoop [48], [0] (0x3711a3be121f @ 9)//到这里形成第一个循环体</span><br><span class="line">经过19次加密之后开始新的循环体</span><br><span class="line">LdaSmi [85]</span><br><span class="line">Star1//r1=85 </span><br><span class="line">LdaSmi [19]</span><br><span class="line">StaGlobal [0], [0] //i=19</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Star2 //r2=i</span><br><span class="line">LdaSmi [43]</span><br><span class="line">estLessThan r2, [13]</span><br><span class="line">JumpIfFalse [52] (0x3711a3be1297 @ 129)//if i&lt;43 如果返回False jmp 129</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Star3  //r3=i</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">LdaKeyedProperty a0, [16] //acc=a0[i]</span><br><span class="line">Add r1, [15]// acc+=r1</span><br><span class="line">BitwiseAndSmi.Wide [255], [14] //acc&amp;=0xff</span><br><span class="line">StaKeyedProperty a1, r3, [18] //a1[r3]=acc</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">LdaKeyedProperty a1, [22] //acc=a1[i]</span><br><span class="line">BitwiseXor r1, [21] //acc^=r1</span><br><span class="line">BitwiseAndSmi.Wide [255], [20] // acc &amp;= 0xff</span><br><span class="line">Star1  //r1=acc</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Inc [24] //i+=1</span><br><span class="line">StaGlobal [0], [0]</span><br><span class="line">JumpLoop [58], [0] (0x3711a3be125a @ 68) //到这里第二个循环体结束</span><br><span class="line">LdaSmi.Wide [159]</span><br><span class="line">TestEqual r1, [25]</span><br><span class="line">JumpIfFalse [50] (0x3711a3be12d0 @ 186)// if i&lt;159 </span><br><span class="line">LdaZero  //acc=0</span><br><span class="line">StaGlobal [0], [0]</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Star2 //r2=i</span><br><span class="line">LdaSmi [43]</span><br><span class="line">TestLessThan r2, [26]</span><br><span class="line">JumpIfFalse [33] (0x3711a3be12ce @ 184) // if r2&gt;43  return False</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">LdaKeyedProperty a2, [27]</span><br><span class="line">Star2 //r2=a2[i]</span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">LdaKeyedProperty a1, [29]</span><br><span class="line">TestEqual r2, [31] //if(a1[i]==a2[i])  不相等 return False</span><br><span class="line">JumpIfTrue [4] (0x3711a3be12c3 @ 173)</span><br><span class="line">LdaFalse </span><br><span class="line">Return </span><br><span class="line">LdaGlobal [0], [2]</span><br><span class="line">Inc [32] //i+=1</span><br><span class="line">StaGlobal [0], [0]</span><br><span class="line">JumpLoop [39], [0] (0x3711a3be12a4 @ 142) //结束循环</span><br></pre></td></tr></table></figure><h3 id="加密函数-实现"><a href="#加密函数-实现" class="headerlink" title="加密函数-实现"></a>加密函数-实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">end=<span class="string">&#x27;3edd7925cd6e04ab44f25bef57bc53bd20b74b8c11f893090fdcdfddad0709100100fe6a9230333234fbae&#x27;</span></span><br><span class="line">r0 = <span class="number">170</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">43</span>): </span><br><span class="line">    dst=<span class="built_in">int</span>(end[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">input</span>[i]+=r0</span><br><span class="line">    <span class="built_in">input</span>[i]+=<span class="number">51</span></span><br><span class="line">    <span class="built_in">input</span>[i]&amp;=<span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">input</span>[i] == dst:</span><br><span class="line">        r0=<span class="built_in">input</span>[i]</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">r1 = <span class="number">85</span>        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">19</span>,<span class="number">43</span>):</span><br><span class="line">    dst=<span class="built_in">int</span>(end[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">input</span>[i]+=r1</span><br><span class="line">    <span class="built_in">input</span>[i]&amp;=<span class="number">0xff</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">input</span>[i] == dst:</span><br><span class="line">        r1=(<span class="built_in">input</span>[i]^r1)&amp;<span class="number">0xff</span></span><br><span class="line">        <span class="keyword">break</span>  </span><br></pre></td></tr></table></figure><h3 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">end=<span class="string">&#x27;3edd7925cd6e04ab44f25bef57bc53bd20b74b8c11f893090fdcdfddad0709100100fe6a9230333234fbae&#x27;</span></span><br><span class="line">r0 = <span class="number">170</span></span><br><span class="line">r1 = <span class="number">85</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">19</span>): </span><br><span class="line">    dst=<span class="built_in">int</span>(end[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">     acc =ch</span><br><span class="line">     acc+=r0</span><br><span class="line">     acc+=<span class="number">51</span></span><br><span class="line">     acc&amp;=<span class="number">0xff</span></span><br><span class="line">     <span class="keyword">if</span> acc == dst:</span><br><span class="line">        flag+=<span class="built_in">chr</span>(ch)</span><br><span class="line">        r0=acc</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">r1=<span class="number">85</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">19</span>,<span class="number">43</span>): </span><br><span class="line">    dst=<span class="built_in">int</span>(end[<span class="number">2</span>*i:<span class="number">2</span>*i+<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">     acc =ch</span><br><span class="line">     acc+=r1</span><br><span class="line">     acc&amp;=<span class="number">0xff</span></span><br><span class="line">     <span class="keyword">if</span> acc == dst:</span><br><span class="line">        flag+=<span class="built_in">chr</span>(ch)</span><br><span class="line">        r1=(acc^r1)&amp;<span class="number">0xff</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(flag)     </span><br><span class="line"><span class="comment">#得到FLAG:aliyunctf&#123;6a52d70da780cfe7f7218897535a4f61&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;复现本题主要是为了学习js字节码，若有不足之处，请各位师傅多多指出&lt;/p&gt;
&lt;p&gt;V8 是 Google 开发的开源 JavaScript 引擎。 Chrome、Node.js和许多其他应用程序都在使用 V8。&lt;br&gt;如果只发布V8引擎编译后的字节码，就可以保护源码。&lt;/p</summary>
      
    
    
    
    <category term="js字节码" scheme="https://5m10v3.top/categories/js%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
    
    <category term="字节码" scheme="https://5m10v3.top/tags/%E5%AD%97%E8%8A%82%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核驱动学习(八)</title>
    <link href="https://5m10v3.top/2024/04/14/Windows%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0(%E5%85%AB)/"/>
    <id>https://5m10v3.top/2024/04/14/Windows%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0(%E5%85%AB)/</id>
    <published>2024-04-13T16:00:00.000Z</published>
    <updated>2024-06-09T09:16:50.236Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简单通信"><a href="#简单通信" class="headerlink" title="简单通信"></a>简单通信</h2><p>这篇文章主要实现内核驱动和应用层之间的通信，通信是驱动开发中不可或缺的一部分，通过通信可以实现驱动和应用层之间的数据交换和控制命令传递等功能</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line">NTSTATUS <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//删除符号链接</span></span><br><span class="line">UNICODE_STRING uLinkName;</span><br><span class="line">RtlInitUnicodeString(&amp;uLinkName, LINK_NAME);</span><br><span class="line">IoDeleteSymbolicLink(&amp;uLinkName);</span><br><span class="line">IoDeleteDevice(pDriverObject-&gt;DeviceObject);</span><br><span class="line">    DbgPrintEx(<span class="number">77</span>,<span class="number">0</span>,<span class="string">&quot;Unload success!\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT pDriverObject,PUNICODE_STRING pReg)</span></span><br><span class="line">&#123;</span><br><span class="line">    pDriverObject-&gt;DriverUnload=DriverUnload;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上是一个驱动程序最基本的框架,接下来我们要逐步创建IO通信</p><p>我们要先定义我们的驱动名称和符号链接名称</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_NAME <span class="string">L&quot;\\device\\My_Driver&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LINK_NAME <span class="string">L&quot;\\dosDevices\\My_Device&quot;</span></span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">//定义驱动名称和符号链接名称</span><br><span class="line">UNICODE_STRING usDriverName=&#123;0&#125;;</span><br><span class="line">UNICODE_STRING usLinkName=&#123;0&#125;;</span><br><span class="line">//定义一个状态</span><br><span class="line">NTSTATUS ntStatus=0;</span><br><span class="line">//定义设备名称</span><br><span class="line">PDEVICE_OBJECT pDeviceObject =NULL;</span><br><span class="line">//初始化字符串</span><br><span class="line">RtlInitUnicodeString(&amp;usDriverName,DEVICE_NAME);</span><br><span class="line">RtlInitUnicodeString(&amp;usLinkName,LINK_NAME);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*IoCreateDevice(</span><br><span class="line">    _In_  PDRIVER_OBJECT DriverObject, //驱动对象</span><br><span class="line">    _In_  ULONG DeviceExtensionSize,//默认0</span><br><span class="line">    _In_opt_ PUNICODE_STRING DeviceName,  //驱动的名称</span><br><span class="line">    _In_  DEVICE_TYPE DeviceType,//填FILE_DEVICE_UNKNOWN</span><br><span class="line">    _In_  ULONG DeviceCharacteristics, //填0</span><br><span class="line">    _In_  BOOLEAN Exclusive,//填True</span><br><span class="line">    PDEVICE_OBJECT *DeviceObject //设备对象</span><br><span class="line">    );*/</span><br><span class="line">//创建设备对象</span><br><span class="line">ntStatus=IoCreateDevice(pDriverObject,0,&amp;usDriverName,FILE_DEVICE_UNKNOWN,0,TRUE,&amp;pDeviceObject);</span><br><span class="line">if(!NT_SUCCESS(ntStatus))</span><br><span class="line">&#123;</span><br><span class="line">  DbgPrintEx(77,0,&quot;IoCreateDevice Failed:%wZ\r\n&quot;);</span><br><span class="line">  return ntStatus;</span><br><span class="line">&#125;</span><br><span class="line">//设置通讯模式</span><br><span class="line">pDeviceObject-&gt;Flags |= DO_BUFFERED_IO ;//这种模式是基于缓冲区的</span><br><span class="line">//创建符号链接</span><br><span class="line">ntStatus = IoCreateSymbolicLink(&amp;usLinkName,&amp;usDriverName)</span><br><span class="line">/*</span><br><span class="line">#define DO_VERIFY_VOLUME                    0x00000002      </span><br><span class="line">#define DO_BUFFERED_IO                      0x00000004      </span><br><span class="line">#define DO_EXCLUSIVE                        0x00000008      </span><br><span class="line">#define DO_DIRECT_IO                        0x00000010      </span><br><span class="line">#define DO_MAP_IO_BUFFER                    0x00000020      </span><br><span class="line">#define DO_DEVICE_HAS_NAME                  0x00000040      </span><br><span class="line">#define DO_DEVICE_INITIALIZING              0x00000080      </span><br><span class="line">#define DO_SYSTEM_BOOT_PARTITION            0x00000100      </span><br><span class="line">#define DO_LONG_TERM_REQUESTS               0x00000200      </span><br><span class="line">#define DO_NEVER_LAST_DEVICE                0x00000400      </span><br><span class="line">#define DO_SHUTDOWN_REGISTERED              0x00000800      </span><br><span class="line">#define DO_BUS_ENUMERATED_DEVICE            0x00001000      </span><br><span class="line">#define DO_POWER_PAGABLE                    0x00002000      </span><br><span class="line">#define DO_POWER_INRUSH                     0x00004000      </span><br><span class="line">#define DO_LOW_PRIORITY_FILESYSTEM          0x00010000      </span><br><span class="line">#define DO_SUPPORTS_PERSISTENT_ACLS         0x00020000      </span><br><span class="line">#define DO_SUPPORTS_TRANSACTIONS            0x00040000      </span><br><span class="line">#define DO_FORCE_NEITHER_IO                 0x00080000      </span><br><span class="line">#define DO_VOLUME_DEVICE_OBJECT             0x00100000        </span><br><span class="line">#define DO_SYSTEM_SYSTEM_PARTITION          0x00200000      </span><br><span class="line">#define DO_SYSTEM_CRITICAL_PARTITION        0x00400000      </span><br><span class="line">#define DO_DISALLOW_EXECUTE                 0x00800000      </span><br><span class="line">#define DO_DEVICE_TO_BE_RESET               0x04000000      </span><br><span class="line">#define DO_DEVICE_IRP_REQUIRES_EXTENSION    0x08000000      </span><br><span class="line">#define DO_DAX_VOLUME                       0x10000000      </span><br><span class="line">#define DO_BOOT_CRITICAL                    0x20000000  </span><br><span class="line">*/    </span><br></pre></td></tr></table></figure><p>派遣函数是驱动程序中用来处理<code>I/O</code>请求的核心函数，一般情况下，驱动程序通过实现一组派遣函数来处理<code>I/O</code>请求。这些派遣函数包括：</p><ul><li>IRP_MJ_CREATE：用于处理创建请求。</li><li>IRP_MJ_READ：用于处理读请求。</li><li>IRP_MJ_WRITE：用于处理写请求。</li><li>IRP_MJ_DEVICE_CONTROL：用于处理设备控制请求等。</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pDriverObject-&gt;MajorFunction[IRP_MJ_CREATE]=DispatchCreate;</span><br><span class="line">pDriverObject-&gt;MajorFunction[IRP_MJ_READ]=DispatchRead;</span><br><span class="line">pDriverObject-&gt;MajorFunction[IRP_MJ_WRITE]=DispatchWrite;</span><br><span class="line">pDriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]=DispatchIoctrl;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS  <span class="title function_">DispatchCommon</span><span class="params">(</span></span><br><span class="line"><span class="params">_In_ <span class="keyword">struct</span> _DEVICE_OBJECT* DeviceObject,</span></span><br><span class="line"><span class="params">_Inout_ <span class="keyword">struct</span> _IRP* Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//设置Irp处理成功</span></span><br><span class="line">    Irp-&gt;IoStatus.Status =STATUS_SUCCESS;</span><br><span class="line">    <span class="comment">//设置返回信息</span></span><br><span class="line">    Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//结束IRP处理流程</span></span><br><span class="line">    IoCompleteRequest(Irp,IO_NO_INCREMENT);</span><br><span class="line">    <span class="comment">//返回成功</span></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上是一个基本功能的派遣函数，而read ，write ，IoControl就是添加了不同的功能。</p><h3 id="IRP-MJ-READ"><a href="#IRP-MJ-READ" class="headerlink" title="IRP_MJ_READ"></a>IRP_MJ_READ</h3><h4 id="R0层"><a href="#R0层" class="headerlink" title="R0层"></a>R0层</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS  <span class="title function_">DispatchRead</span><span class="params">(</span></span><br><span class="line"><span class="params">_In_ <span class="keyword">struct</span> _DEVICE_OBJECT* DeviceObject,</span></span><br><span class="line"><span class="params">_Inout_ <span class="keyword">struct</span> _IRP* Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取当前Irp栈</span></span><br><span class="line">    PIO_STACK_LOCATION pStack =IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    <span class="comment">//拿到r3缓冲区</span></span><br><span class="line">    PVOID pReadBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">    <span class="comment">//获得读取长度</span></span><br><span class="line">    ULONG ulReadLength =pStack-&gt;Parameters.Read.Length;</span><br><span class="line">    <span class="comment">//计算返回数据的长度</span></span><br><span class="line">    ULONG ulStrLen =(wcslen(<span class="string">L&quot;Hello world funck!&quot;</span>)+<span class="number">1</span>)*<span class="keyword">sizeof</span>(WCHAR);</span><br><span class="line">    <span class="comment">//最小数据长度</span></span><br><span class="line">    ULONG uMin = ulReadLength&gt;ulStrLen ?ulStrLen:ulReadLength;</span><br><span class="line">    RtlCopyMemory(pReadBuffer,<span class="string">L&quot;Hello world funck!&quot;</span>,uMin)</span><br><span class="line">    <span class="comment">//设置Irp处理成功</span></span><br><span class="line">    Irp-&gt;IoStatus.Status =STATUS_SUCCESS;</span><br><span class="line">    <span class="comment">//设置返回信息</span></span><br><span class="line">    Irp-&gt;IoStatus.Information = uMin; <span class="comment">//这里要设置返回值为uMin</span></span><br><span class="line">    <span class="comment">//结束IRP处理流程</span></span><br><span class="line">    IoCompleteRequest(Irp,IO_NO_INCREMENT);</span><br><span class="line">    <span class="comment">//返回成功</span></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="R3层"><a href="#R3层" class="headerlink" title="R3层"></a>R3层</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_LINKE_NAME <span class="string">L&quot;\\\\.\\My_Device&quot;</span>  <span class="comment">//这里要跟你设置的符号链接的名称一样</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//创建句柄</span></span><br><span class="line">    HANDLE  hFile = <span class="built_in">CreateFile</span>(DEVICE_LINKE_NAME, GENERIC_ALL, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed%x\r\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;Pause&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    UCHAR Buffer[MAX_PATH];</span><br><span class="line">    ULONG dwRet;</span><br><span class="line">    BOOL bRET =<span class="built_in">ReadFile</span>(hFile,Buffer,MAX_PATH,&amp;dwRet,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(bRET)</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;read %d bytes\r\n&quot;</span>, dwRet);</span><br><span class="line">       <span class="built_in">wprintf</span>(<span class="string">L&quot;%s\r\n&quot;</span>, Buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;Pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="IRP-MJ-WRITE"><a href="#IRP-MJ-WRITE" class="headerlink" title="IRP_MJ_WRITE"></a>IRP_MJ_WRITE</h3><h4 id="R0层-1"><a href="#R0层-1" class="headerlink" title="R0层"></a>R0层</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS  <span class="title function_">DispatchWrite</span><span class="params">(</span></span><br><span class="line"><span class="params">_In_ <span class="keyword">struct</span> _DEVICE_OBJECT* DeviceObject,</span></span><br><span class="line"><span class="params">_Inout_ <span class="keyword">struct</span> _IRP* Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//获取当前Irp栈</span></span><br><span class="line">    PIO_STACK_LOCATION pStack =IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line">    <span class="comment">//拿到r3缓冲区</span></span><br><span class="line">    PVOID pWriteBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">    <span class="comment">//获得读取长度</span></span><br><span class="line">    ULONG ulWriteLength =pStack-&gt;Parameters.Read.Length;</span><br><span class="line">    UNICODE_STRING usStr=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    RtlInitUnicodeString(&amp;usStr,pWriteBuffer);</span><br><span class="line">    DbgPrint(<span class="string">&quot;%wZ\r\n&quot;</span>, usStr);</span><br><span class="line">DbgPrint(<span class="string">&quot;write success!!!&quot;</span>);</span><br><span class="line">    <span class="comment">//设置Irp处理成功</span></span><br><span class="line">    Irp-&gt;IoStatus.Status =STATUS_SUCCESS;</span><br><span class="line">    <span class="comment">//设置返回信息</span></span><br><span class="line">    Irp-&gt;IoStatus.Information = ulWriteLength; <span class="comment">//这里要设置返回值为uMin</span></span><br><span class="line">    <span class="comment">//结束IRP处理流程</span></span><br><span class="line">    IoCompleteRequest(Irp,IO_NO_INCREMENT);</span><br><span class="line">    <span class="comment">//返回成功</span></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="R3层-1"><a href="#R3层-1" class="headerlink" title="R3层"></a>R3层</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_LINKE_NAME <span class="string">L&quot;\\\\.\\My_Device&quot;</span>  <span class="comment">//这里要跟你设置的符号链接的名称一样</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//创建句柄</span></span><br><span class="line">    HANDLE  hFile = <span class="built_in">CreateFile</span>(DEVICE_LINKE_NAME, GENERIC_ALL, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed%x\r\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;Pause&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ULONG dwRet; </span><br><span class="line">    DWORD dwWriteLen = (<span class="built_in">wcslen</span>(<span class="string">L&quot;Hello World Fuck!&quot;</span>))*<span class="built_in">sizeof</span>(WCHAR) + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">WriteFile</span>(hFile, <span class="string">L&quot;Hello World Fuck!&quot;</span>,dwWriteLen,&amp;dwRet,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\r\n&quot;</span>, dwRet);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;Pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IO通信"><a href="#IO通信" class="headerlink" title="IO通信"></a>IO通信</h2><h3 id="IRP-MJ-DEVICE-CONTROL"><a href="#IRP-MJ-DEVICE-CONTROL" class="headerlink" title="IRP_MJ_DEVICE_CONTROL"></a>IRP_MJ_DEVICE_CONTROL</h3><p>进行IO通信重要的是控制码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define IRP_IOCTRL_BASE 0x8000</span><br><span class="line">#define IRP_IOCTRL_CODE(i) CTL_CODE(FILE_DEVICE_UNKNOWN,IRP_IOCTRL_BASE + i,METHOD_BUFFERED,FILE_ANY_ACCESS)</span><br><span class="line">#define GET_PROCESS IRP_IOCTRL_CODE(0)</span><br></pre></td></tr></table></figure><h4 id="R0层-2"><a href="#R0层-2" class="headerlink" title="R0层"></a>R0层</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS  <span class="title function_">DispatchIoCtrl</span><span class="params">(</span></span><br><span class="line"><span class="params">_In_ <span class="keyword">struct</span> _DEVICE_OBJECT* DeviceObject,</span></span><br><span class="line"><span class="params">_Inout_ <span class="keyword">struct</span> _IRP* Irp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PIO_STACK_LOCATION pStack = IoGetCurrentIrpStackLocation(Irp);</span><br><span class="line"><span class="comment">//获得控制码</span></span><br><span class="line">ULONG code = pStack-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line"><span class="comment">//输入输出缓冲区</span></span><br><span class="line">PVOID pReadBuffer = <span class="literal">NULL</span>;</span><br><span class="line">ULONG uReadLength = <span class="number">0</span>;</span><br><span class="line">PVOID pWriteBuffer = <span class="literal">NULL</span>;</span><br><span class="line">ULONG uWriteLength = <span class="number">0</span>;</span><br><span class="line">pReadBuffer = pWriteBuffer = Irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">uReadLength = uWriteLength = pStack-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line"><span class="keyword">switch</span> (code)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> GET_PROCESS:</span><br><span class="line">DbgPrint(<span class="string">&quot;%s\r\n&quot;</span>, pReadBuffer);</span><br><span class="line">RtlZeroMemory(pWriteBuffer, <span class="number">1024</span>);</span><br><span class="line">ULONG uRetLen = <span class="built_in">strlen</span>(<span class="string">&quot;DispathchCrtl ok\r\n&quot;</span>);</span><br><span class="line">RtlCopyMemory(pWriteBuffer, <span class="string">&quot;DispathchCrtl ok\r\n&quot;</span>, uRetLen);</span><br><span class="line">Irp-&gt;IoStatus.Information = uRetLen;</span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">IoCompleteRequest(Irp, IO_NO_INCREMENT);<span class="comment">//结束IRP </span></span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//设置Irp处理成功</span></span><br><span class="line">Irp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line"><span class="comment">//设置返回信息</span></span><br><span class="line">Irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//结束IRP处理流程</span></span><br><span class="line">IoCompleteRequest(Irp, IO_NO_INCREMENT);</span><br><span class="line"><span class="comment">//返回成功</span></span><br><span class="line"><span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="R3层-2"><a href="#R3层-2" class="headerlink" title="R3层"></a>R3层</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_LINKE_NAME <span class="string">L&quot;\\\\.\\My_Device&quot;</span>  <span class="comment">//这里要跟你设置的符号链接的名称一样</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_IOCTRL_BASE 0x8000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_IOCTRL_CODE(i) CTL_CODE(FILE_DEVICE_UNKNOWN,IRP_IOCTRL_BASE + i,METHOD_BUFFERED,FILE_ANY_ACCESS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_PROCESS IRP_IOCTRL_CODE(0)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hFile=<span class="built_in">CreateFile</span>(DEVICE_LINKE_NAME, GENERIC_ALL, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (hFile == INVALID_HANDLE_VALUE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreateFile Failed%x\r\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;Pause&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) </span><br><span class="line">   &#123;</span><br><span class="line">       <span class="type">char</span> ReadBuf[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">       <span class="type">char</span> WriteBuf[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">       DWORD dwRet = <span class="number">0</span>;</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;输入字符串\r\n&quot;</span>);</span><br><span class="line">       <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,&amp;ReadBuf);</span><br><span class="line">       <span class="built_in">DeviceIoControl</span>(hFile, GET_PROCESS, ReadBuf,<span class="built_in">sizeof</span>(ReadBuf), WriteBuf,<span class="built_in">sizeof</span>(WriteBuf),&amp;dwRet,<span class="number">0</span>);</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;%d %s\r\n&quot;</span>, dwRet, WriteBuf);</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;Pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简单通信&quot;&gt;&lt;a href=&quot;#简单通信&quot; class=&quot;headerlink&quot; title=&quot;简单通信&quot;&gt;&lt;/a&gt;简单通信&lt;/h2&gt;&lt;p&gt;这篇文章主要实现内核驱动和应用层之间的通信，通信是驱动开发中不可或缺的一部分，通过通信可以实现驱动和应用层之间的数据交换和控</summary>
      
    
    
    
    <category term="内核驱动" scheme="https://5m10v3.top/categories/%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8/"/>
    
    
    <category term="Windows内核驱动开发" scheme="https://5m10v3.top/tags/Windows%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Windows内核驱动学习(七)</title>
    <link href="https://5m10v3.top/2024/04/13/Windows%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0(%E4%B8%83)/"/>
    <id>https://5m10v3.top/2024/04/13/Windows%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0(%E4%B8%83)/</id>
    <published>2024-04-12T16:00:00.000Z</published>
    <updated>2024-06-09T09:07:00.354Z</updated>
    
    <content type="html"><![CDATA[<h2 id="蓝屏分析"><a href="#蓝屏分析" class="headerlink" title="蓝屏分析"></a>蓝屏分析</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;蓝屏分析&quot;&gt;&lt;a href=&quot;#蓝屏分析&quot; class=&quot;headerlink&quot; title=&quot;蓝屏分析&quot;&gt;&lt;/a&gt;蓝屏分析&lt;/h2&gt;</summary>
      
    
    
    
    <category term="内核驱动" scheme="https://5m10v3.top/categories/%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8/"/>
    
    
    <category term="Windows内核驱动开发" scheme="https://5m10v3.top/tags/Windows%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
</feed>
